// ============================================================================
// FB_CircleSimple - 极简画圆功能块（教学版）
// 文件名: FB_CircleSimple.scl
// 版本: 2.0
// 兼容: SIMATIC S7-1500, TIA Portal V17/V18
// 编码: UTF-8
// ============================================================================
// 功能说明:
//   - 极简画圆：只用 MC_Power + MC_Home + MC_MoveAbsolute
//   - 无点动、无Halt、无限位检测
//   - 状态机：空闲 → 使能 → 回原点 → 等待启动 → 画圆 → 完成
//   - 默认圆心 (510, 176.3)，半径 80mm
// ============================================================================

FUNCTION_BLOCK "画圆简易版"
{ S7_Optimized_Access := 'TRUE' }
VERSION : 2.0

// ============================================================================
// 输入变量
// ============================================================================
VAR_INPUT
    // ===== 系统控制 =====
    启动按钮 : Bool;              // 启动画圆
    停止按钮 : Bool;              // 停止并返回空闲
    
    // ===== MC反馈 =====
    X轴使能状态 : Bool;           // MC_Power.Status
    Y轴使能状态 : Bool;
    X轴回原点完成 : Bool;         // MC_Home.Done
    Y轴回原点完成 : Bool;
    X轴定位完成 : Bool;           // MC_MoveAbsolute.Done
    Y轴定位完成 : Bool;
    X轴错误 : Bool;               // MC_Power.Error
    Y轴错误 : Bool;
    
    // ===== 圆参数（可在HMI调整）=====
    圆心X : Real := 510.0;        // 圆心X (mm) - 默认510
    圆心Y : Real := 176.3;        // 圆心Y (mm) - 默认176.3（Y对准X中心）
    圆半径 : Real := 80.0;        // 半径 (mm) - 默认80
    圆速度 : Real := 50.0;        // 速度 (mm/s)
    角度步进 : Real := 5.0;       // 每步角度 (度)
END_VAR

// ============================================================================
// 输出变量
// ============================================================================
VAR_OUTPUT
    // ===== MC控制 =====
    X轴使能请求 : Bool;           // → MC_Power.Enable
    Y轴使能请求 : Bool;
    X轴回原点请求 : Bool;         // → MC_Home.Execute
    Y轴回原点请求 : Bool;
    
    // ===== 绝对定位 =====
    X轴目标位置 : Real;           // → MC_MoveAbsolute.Position
    Y轴目标位置 : Real;
    X轴定位启动 : Bool;           // → MC_MoveAbsolute.Execute
    Y轴定位启动 : Bool;
    定位速度 : Real := 100.0;     // → MC_MoveAbsolute.Velocity
    
    // ===== 状态 =====
    当前状态 : Int;
END_VAR

// ============================================================================
// 常量
// ============================================================================
VAR CONSTANT
    // 状态定义
    c状态_空闲 : Int := 0;
    c状态_使能 : Int := 10;
    c状态_回原点 : Int := 20;
    c状态_等待启动 : Int := 30;
    c状态_画圆初始化 : Int := 100;
    c状态_移动起点 : Int := 110;
    c状态_等待到位 : Int := 115;
    c状态_插补运行 : Int := 120;
    c状态_完成 : Int := 130;
    c状态_错误 : Int := 999;
    
    // 数学常量
    cPI : Real := 3.14159265359;
    
    // 插补周期
    c插补周期 : TIME := t#100ms;
END_VAR

// ============================================================================
// 静态变量
// ============================================================================
VAR
    t插补 {InstructionName := 'IEC_TIMER'; LibVersion := '1.0'} : IEC_TIMER;
    t完成延时 {InstructionName := 'IEC_TIMER'; LibVersion := '1.0'} : IEC_TIMER;
    
    f启动沿 {InstructionName := 'R_TRIG'; LibVersion := '1.0'} : R_TRIG;
    
    主状态 : Int := 0;
    上次状态 : Int := -1;
    b新状态 : Bool;
    
    r当前角度 : Real := 0.0;
    r圆心X : Real;
    r圆心Y : Real;
    r半径 : Real;
END_VAR

VAR_TEMP
    t弧度 : Real;
    tX : Real;
    tY : Real;
END_VAR

// ============================================================================
// 主程序
// ============================================================================
BEGIN
    // ========================================================================
    // 边沿检测
    // ========================================================================
    #f启动沿(CLK := #启动按钮);
    
    // ========================================================================
    // 轴错误检测
    // ========================================================================
    IF #X轴错误 OR #Y轴错误 THEN
        #主状态 := #c状态_错误;
    END_IF;
    
    // ========================================================================
    // 停止按钮 → 返回空闲
    // ========================================================================
    IF #停止按钮 THEN
        #X轴定位启动 := FALSE;
        #Y轴定位启动 := FALSE;
        #X轴回原点请求 := FALSE;
        #Y轴回原点请求 := FALSE;
        #主状态 := #c状态_空闲;
    END_IF;
    
    // ========================================================================
    // 状态检测
    // ========================================================================
    #b新状态 := (#主状态 <> #上次状态);
    #上次状态 := #主状态;
    
    // ========================================================================
    // 状态机
    // ========================================================================
    CASE #主状态 OF
        
        // ====== 空闲 ======
        #c状态_空闲:
            #X轴使能请求 := FALSE;
            #Y轴使能请求 := FALSE;
            #X轴回原点请求 := FALSE;
            #Y轴回原点请求 := FALSE;
            #X轴定位启动 := FALSE;
            #Y轴定位启动 := FALSE;
            
            // 按启动按钮 → 开始使能
            IF #f启动沿.Q THEN
                #主状态 := #c状态_使能;
            END_IF;
            
        // ====== 使能 ======
        #c状态_使能:
            #X轴使能请求 := TRUE;
            #Y轴使能请求 := TRUE;
            
            // 等待两轴使能成功
            IF #X轴使能状态 AND #Y轴使能状态 THEN
                #主状态 := #c状态_回原点;
            END_IF;
            
        // ====== 回原点 ======
        #c状态_回原点:
            // 发送回原点请求（上升沿触发）
            IF #b新状态 THEN
                #X轴回原点请求 := TRUE;
                #Y轴回原点请求 := TRUE;
            ELSE
                // 保持一个周期后关闭（脉冲触发）
                #X轴回原点请求 := FALSE;
                #Y轴回原点请求 := FALSE;
            END_IF;
            
            // 等待两轴回原点完成
            IF #X轴回原点完成 AND #Y轴回原点完成 THEN
                #主状态 := #c状态_等待启动;
            END_IF;
            
        // ====== 等待启动 ======
        #c状态_等待启动:
            #X轴回原点请求 := FALSE;
            #Y轴回原点请求 := FALSE;
            
            // 再次按启动按钮 → 开始画圆
            IF #f启动沿.Q THEN
                #主状态 := #c状态_画圆初始化;
            END_IF;
            
        // ====== 画圆初始化 ======
        #c状态_画圆初始化:
            // 参数检查
            IF #圆半径 <= 0.0 OR #圆半径 > 200.0 THEN
                #主状态 := #c状态_错误;
            ELSE
                // 保存参数
                #r圆心X := #圆心X;
                #r圆心Y := #圆心Y;
                #r半径 := #圆半径;
                #r当前角度 := 0.0;
                
                // 起点（角度0°）：圆心右侧
                #X轴目标位置 := #r圆心X + #r半径;
                #Y轴目标位置 := #r圆心Y;
                #定位速度 := #圆速度;
                
                #主状态 := #c状态_移动起点;
            END_IF;
            
        // ====== 移动到起点 ======
        #c状态_移动起点:
            // 发送定位命令（脉冲触发）
            IF #b新状态 THEN
                #X轴定位启动 := TRUE;
                #Y轴定位启动 := TRUE;
            ELSE
                #X轴定位启动 := FALSE;
                #Y轴定位启动 := FALSE;
            END_IF;
            
            // 等待定位完成
            IF #X轴定位完成 AND #Y轴定位完成 THEN
                #r当前角度 := 0.0;
                #主状态 := #c状态_插补运行;
            END_IF;
            
        // ====== 插补运行 ======
        #c状态_插补运行:
            #t插补.TON(IN := TRUE, PT := #c插补周期);
            
            IF #t插补.Q OR #b新状态 THEN
                #t插补.TON(IN := FALSE, PT := #c插补周期);
                
                // 角度递增（顺时针）
                #r当前角度 := #r当前角度 + #角度步进;
                
                // 完成检查
                IF #r当前角度 >= 360.0 THEN
                    #主状态 := #c状态_完成;
                ELSE
                    // 计算新位置
                    #t弧度 := #r当前角度 * #cPI / 180.0;
                    #tX := #r圆心X + (#r半径 * COS(#t弧度));
                    #tY := #r圆心Y + (#r半径 * SIN(#t弧度));
                    
                    #X轴目标位置 := #tX;
                    #Y轴目标位置 := #tY;
                    #X轴定位启动 := TRUE;
                    #Y轴定位启动 := TRUE;
                END_IF;
            ELSE
                #X轴定位启动 := FALSE;
                #Y轴定位启动 := FALSE;
            END_IF;
            
        // ====== 完成 ======
        #c状态_完成:
            #X轴定位启动 := FALSE;
            #Y轴定位启动 := FALSE;
            
            // 延时后返回等待启动（可再次画圆）
            #t完成延时.TON(IN := TRUE, PT := t#2s);
            
            IF #t完成延时.Q THEN
                #t完成延时.TON(IN := FALSE, PT := t#2s);
                #主状态 := #c状态_等待启动;
            END_IF;
            
        // ====== 错误 ======
        #c状态_错误:
            #X轴使能请求 := FALSE;
            #Y轴使能请求 := FALSE;
            #X轴回原点请求 := FALSE;
            #Y轴回原点请求 := FALSE;
            #X轴定位启动 := FALSE;
            #Y轴定位启动 := FALSE;
            
        ELSE
            #主状态 := #c状态_空闲;
            
    END_CASE;
    
    // ========================================================================
    // 状态输出
    // ========================================================================
    #当前状态 := #主状态;
    
END_FUNCTION_BLOCK


