# 画圆简易版 - TIA Portal 配置指南

## 一、概述

### 极简设计
- **只用 6 个 MC 块**：
  - 2 × MC_Power（使能）
  - 2 × MC_Home（回原点）
  - 2 × MC_MoveAbsolute（绝对定位）
- **无点动、无 Halt、无限位检测**
- **适用场景**：教学测试、安全已验证的环境

### 默认圆参数
| 参数 | 默认值 | 说明 |
|------|--------|------|
| 圆心X | 510.0 mm | X 轴圆心位置 |
| 圆心Y | 176.3 mm | Y 轴圆心位置（对准 X 中心） |
| 圆半径 | 80.0 mm | 圆的半径 |
| 圆速度 | 50.0 mm/s | 定位速度 |
| 角度步进 | 5.0° | 每步角度 |

---

## 二、状态流程

```
按启动按钮
    ↓
状态10: 使能 → MC_Power.Enable = TRUE
    ↓ (X轴使能状态 AND Y轴使能状态)
状态20: 回原点 → MC_Home.Execute = TRUE
    ↓ (X轴回原点完成 AND Y轴回原点完成)
状态30: 等待启动（原点就绪）
    ↓ 再次按启动按钮
状态100: 画圆初始化 → 计算起点 (圆心X+半径, 圆心Y)
    ↓
状态110: 移动起点 → MC_MoveAbsolute
    ↓ (X轴定位完成 AND Y轴定位完成)
状态120: 插补运行 → 每100ms发送新目标点
    ↓ (角度 >= 360°)
状态130: 完成 → 2秒后返回状态30
```

---

## 三、OB1 配置（LAD 方式）

### Network 结构
```
OB1
├── Network 1: 画圆简易版 FB（生成 DB_CircleSimple）
├── Network 2: MC_Power X轴
├── Network 3: MC_Power Y轴
├── Network 4: MC_Home X轴
├── Network 5: MC_Home Y轴
├── Network 6: MC_MoveAbsolute X轴
└── Network 7: MC_MoveAbsolute Y轴
```

### Network 1：调用 FB
1. 从 **程序块** 拖入 `画圆简易版` FB
2. 自动创建实例 DB：`DB_CircleSimple`
3. 配置输入引脚：

| 引脚 | 连接到 |
|------|--------|
| 启动按钮 | "I10.0"（或其他启动输入） |
| 停止按钮 | "I10.1"（或其他停止输入） |
| 复位按钮 | "M0.2"（复位标志） |
| X轴使能状态 | （Network 2 配好后填） |
| Y轴使能状态 | （Network 3 配好后填） |
| X轴回原点完成 | （Network 4 配好后填） |
| Y轴回原点完成 | （Network 5 配好后填） |
| X轴定位完成 | （Network 6 配好后填） |
| Y轴定位完成 | （Network 7 配好后填） |
| X轴错误 | （Network 2 配好后填） |
| Y轴错误 | （Network 3 配好后填） |
| 圆心X | 510.0 |
| 圆心Y | 176.3 |
| 圆半径 | 80.0 |
| 圆速度 | 50.0 |
| 角度步进 | 5.0 |

### Network 2：MC_Power X轴
```
拖入 MC_Power → 自动生成 MC_Power_DB

配置：
- Axis := "X轴"
- Enable := "DB_CircleSimple".X轴使能请求
- StartMode := 0
- StopMode := 0
```

### Network 3：MC_Power Y轴
```
拖入 MC_Power → 自动生成 MC_Power_DB_1

配置：
- Axis := "Y轴"
- Enable := "DB_CircleSimple".Y轴使能请求
```

### Network 4：MC_Home X轴
```
拖入 MC_Home → 自动生成 MC_Home_DB

配置：
- Axis := "X轴"
- Execute := "DB_CircleSimple".X轴回原点请求
- Position := 0.0
- Mode := 3（或根据工艺对象配置）
```

### Network 5：MC_Home Y轴
```
拖入 MC_Home → 自动生成 MC_Home_DB_1

配置：
- Axis := "Y轴"
- Execute := "DB_CircleSimple".Y轴回原点请求
- Position := 0.0
- Mode := 3
```

### Network 6：MC_MoveAbsolute X轴
```
拖入 MC_MoveAbsolute → 自动生成 MC_MoveAbsolute_DB

配置：
- Axis := "X轴"
- Execute := "DB_CircleSimple".X轴定位启动
- Position := "DB_CircleSimple".X轴目标位置
- Velocity := "DB_CircleSimple".定位速度
- Acceleration := 500.0
- Deceleration := 500.0
- Jerk := 0.0
```

### Network 7：MC_MoveAbsolute Y轴
```
拖入 MC_MoveAbsolute → 自动生成 MC_MoveAbsolute_DB_1

配置：
- Axis := "Y轴"
- Execute := "DB_CircleSimple".Y轴定位启动
- Position := "DB_CircleSimple".Y轴目标位置
- Velocity := "DB_CircleSimple".定位速度
- Acceleration := 500.0
- Deceleration := 500.0
```

### 回填 FB 输入（MC 状态反馈）

回到 Network 1，填写 MC 反馈：

| FB引脚 | 连接到 |
|--------|--------|
| X轴使能状态 | "MC_Power_DB".Status |
| Y轴使能状态 | "MC_Power_DB_1".Status |
| X轴回原点完成 | "MC_Home_DB".Done |
| Y轴回原点完成 | "MC_Home_DB_1".Done |
| X轴定位完成 | "MC_MoveAbsolute_DB".Done |
| Y轴定位完成 | "MC_MoveAbsolute_DB_1".Done |
| X轴错误 | "MC_Power_DB".Error |
| Y轴错误 | "MC_Power_DB_1".Error |

---

## 四、工艺对象配置

### X轴 / Y轴 配置
1. **项目树 → CPU → 工艺对象 → 右键 → 添加新对象**
2. 选择：**运动控制 → TO_PositioningAxis**
3. 驱动类型：**PTO**
4. 脉冲/方向输出：
   - X轴：Q4.0（脉冲）、Q4.1（方向）
   - Y轴：Q4.2（脉冲）、Q4.3（方向）

### 回原点模式配置
在工艺对象的 **归位（Homing）** 配置中：
- 模式：选择适合你设备的模式
- 如果没有原点开关，可以选择 **直接设置当前位置为原点**

---

## 五、操作流程

### 启动流程
1. **确保设备安全**
2. **按启动按钮（I10.0）**
   - 状态变为 10（使能）→ 20（回原点）
3. **等待回原点完成**
   - 状态变为 30（等待启动）
4. **再次按启动按钮**
   - 状态变为 100 → 110 → 120（画圆）
5. **观察画圆进度**
   - `画圆进度` 从 0° 增加到 360°
6. **完成**
   - 状态变为 130，2秒后返回 30

### 停止/复位
- **按停止按钮（I10.1）**：立即返回状态 0（空闲）
- **按复位按钮（M0.2）**：仅在错误状态（999）时有效

---

## 六、状态码一览

| 状态值 | 含义 |
|--------|------|
| 0 | 空闲 |
| 10 | 使能中（等待 MC_Power.Status） |
| 20 | 回原点中（等待 MC_Home.Done） |
| 30 | 等待启动（原点就绪，可按启动开始画圆） |
| 100 | 画圆初始化（计算起点坐标） |
| 110 | 移动到起点 |
| 120 | 插补运行（画圆中） |
| 130 | 完成（2秒后返回30） |
| 999 | 错误 |

---

## 七、圆形轨迹说明

### 起点位置
- 角度 0° → 位置 (圆心X + 半径, 圆心Y)
- 默认：(510 + 80, 176.3) = **(590, 176.3)**

### 运动方向
- 顺时针：0° → 90° → 180° → 270° → 360°
- 每步 5°，共 72 步完成一圈

### 轨迹示意
```
                    90°
                     ↑
          (510, 256.3)
                    
    180° ← ● (510, 176.3) → 0° 起点
          圆心           (590, 176.3)
                    
          (510, 96.3)
                     ↓
                   270°
```

---

## 八、调试建议

### 监控变量
| 变量 | 说明 |
|------|------|
| `DB_CircleSimple.当前状态` | 状态机位置 |
| `DB_CircleSimple.画圆进度` | 0~360° |
| `DB_CircleSimple.X轴目标位置` | 当前目标 X |
| `DB_CircleSimple.Y轴目标位置` | 当前目标 Y |
| `"X轴".ActualPosition` | X 实际位置 |
| `"Y轴".ActualPosition` | Y 实际位置 |

### 常见问题
| 问题 | 原因 | 解决 |
|------|------|------|
| 状态卡在 10 | MC_Power 未返回 Status | 检查工艺对象配置 |
| 状态卡在 20 | MC_Home 未返回 Done | 检查回原点模式配置 |
| 状态卡在 110/120 | MC_MoveAbsolute 未返回 Done | 检查速度/加速度参数 |
| 状态 999 | 轴错误 | 检查驱动器状态、接线 |


