# TIA Portal 钻孔项目创建流程（MC库版）

## 一、创建新项目

### 1.1 新建项目
1. 打开 **TIA Portal V17/V18**
2. 点击 **创建新项目**
3. 项目名称：`钻孔系统_MC版`
4. 路径：选择保存位置
5. 点击 **创建**

---


---

## 二、添加硬件设备

### 2.1 添加PLC
1. 在 **项目树** → **设备和网络** → **添加新设备**
2. 选择 **控制器** → **SIMATIC S7-1500** → **CPU 1511C-1 PN**
3. 点击 **确定**

### 2.2 添加IO模块
根据现场IO连接表，需要添加数字量输入和输出模块。

1. 在设备视图中，点击CPU右侧的 **+** 号
2. 添加 **数字量输入模块**（如：DI 16x24VDC）
   - 输入地址：**I4.0 ~ I5.7**（16个输入）
   - 输入类型：24VDC
3. 添加 **数字量输出模块**（如：DO 16x24VDC）
   - 输出地址：**Q10.0 ~ Q11.7**（16个输出）
   - 输出类型：24VDC（晶体管）

### 2.3 配置脉冲输出（PTO）
1511C-1 PN 自带脉冲输出功能，用于控制步进/伺服驱动器。

1. 在设备配置中，找到 **工艺对象** → **运动控制**
2. 确认CPU支持 **PTO（脉冲串输出）** 功能
3. 记录可用的PTO通道（通常为PTO1、PTO2等）

---

## 三、创建工艺对象（轴）

### 3.1 添加工艺对象
1. 在 **项目树** → **工艺对象** → 右键 → **添加新对象**
2. 选择 **运动控制** → **定位轴**
3. 名称：`X轴`
4. 点击 **确定**

### 3.2 配置X轴参数

#### 基本参数
- **驱动装置**：选择 **步进电机** 或 **伺服电机**
- **编码器系统**：根据实际情况选择（如：无编码器 或 增量编码器）
- **硬件接口**：选择脉冲输出点（如：**PTO1**，对应CPU的脉冲输出通道1）

#### 扩展参数
- **机械**：
  - 电机每转脉冲数：根据驱动器设置（如：10000）
  - 电机每转负载位移：根据丝杠导程（如：5mm）
- **位置限制**：
  - 启用软件限位：勾选
  - 正向限位：100.0（根据实际行程）
  - 负向限位：0.0（原点位置）

### 3.3 创建Y轴
重复步骤 3.1-3.2，创建第二个轴：
- 名称：`Y轴`
- 硬件接口：选择 **PTO2**（对应CPU的脉冲输出通道2）
- 其他配置参数与X轴类似

---

## 四、导入SCL代码

### 4.1 导入主函数块
1. 在 **项目树** → **程序块** → 右键 → **外部源文件** → **从文件**
2. 选择文件：`最终版本_MC库版.scl`
3. 点击 **从外部源文件生成块**
4. 编译检查（应无错误）

### 4.2 验证函数块
- 确认生成了 `FB1 "钻孔控制_MC版"`

---

## 五、创建MC块实例DB

### 5.1 创建MC_Power实例DB
1. **项目树** → **程序块** → 右键 → **添加新块** → **数据块**
2. 名称：`MC_POWER_DB`
3. 类型：选择 **实例DB**
4. 关联到：`MC_Power`（在系统库中）
5. 点击 **确定**

### 5.2 创建MC_Reset实例DB
1. 重复步骤 5.1
2. 名称：`MC_RESET_DB`
3. 关联到：`MC_Reset`

### 5.3 创建MC_MoveJog实例DB
1. 重复步骤 5.1
2. 名称：`MC_MOVEJOG_DB`
3. 关联到：`MC_MoveJog`

### 5.4 创建Y轴MC块实例DB
重复步骤 5.1-5.3，创建Y轴的实例DB：
- `MC_POWER_DB_1`（关联MC_Power）
- `MC_RESET_DB_1`（关联MC_Reset）
- `MC_MOVEJOG_DB_1`（关联MC_MoveJog）

---

## 六、创建主程序实例DB

### 6.1 创建主函数块实例DB
1. **项目树** → **程序块** → 右键 → **添加新块** → **数据块**
2. 名称：`DB_钻孔控制`
3. 类型：选择 **实例DB**
4. 关联到：`FB1 "钻孔控制_MC版"`
5. 点击 **确定**

---

## 七、编写主程序（OB1）

### 7.1 打开OB1
1. **项目树** → **程序块** → **Main [OB1]**
2. 切换到 **SCL** 视图（如果默认是LAD/FBD）

### 7.2 编写调用代码

```scl
// 钻孔系统主程序（IO映射：I4.0~I5.7, Q10.0~Q11.7）
"DB_钻孔控制"(
    系统上电 := "系统上电标志",      // M0.0 或直接使用 TRUE
    启动按钮 := "I4.0",              // 启动按钮
    停止按钮 := "I4.1",              // 停止按钮
    x轴左限位 := "I4.3",             // X轴左限位（原点，检测2）
    x轴右限位 := "I4.2",             // X轴右限位（检测1）
    y轴后限位 := "I4.4",             // Y轴后限位（检测3）
    y轴前限位 := "I4.5",             // Y轴前限位（原点，检测4）
    气缸元点检测 := "I4.6",          // 气缸原点检测（检测5）
    工作台加紧 => "Q10.4",           // 工作台夹紧气缸（控制5）
    钻下降 => "Q10.5",               // 钻头下降气缸（控制6）
    钻运行 => "Q10.6"                // 钻头旋转电机（控制7）
);
```

**IO地址说明**：
- 输入地址（I4.0~I4.6）：使用IO模块的数字量输入，对应现场传感器
- 输出地址（Q10.4~Q10.6）：使用IO模块的数字量输出，对应现场执行器
- 脉冲输出（Q10.0~Q10.3）：由工艺对象自动管理，对应控制1~4（CP1/DIR1/CP2/DIR2）

---

## 八、配置IO映射表

### 8.1 创建PLC变量表
1. **项目树** → **PLC变量** → **默认变量表**
2. 添加以下变量（参考 `IO映射表_MC库版.md`）：

| 名称 | 地址 | 数据类型 | 说明 | 传感器/执行器编号 |
|------|------|----------|------|------------------|
| 系统上电标志 | M0.0 | Bool | 系统上电标志 | - |
| 启动按钮 | I4.0 | Bool | 启动按钮 | - |
| 停止按钮 | I4.1 | Bool | 停止按钮 | - |
| x轴右限位 | I4.2 | Bool | X轴右限位 | 检测1 |
| x轴左限位 | I4.3 | Bool | X轴左限位（原点） | 检测2 |
| y轴后限位 | I4.4 | Bool | Y轴后限位 | 检测3 |
| y轴前限位 | I4.5 | Bool | Y轴前限位（原点） | 检测4 |
| 气缸元点检测 | I4.6 | Bool | 气缸原点检测 | 检测5 |
| CP1 | Q10.0 | Bool | X轴脉冲输出 | 控制1（MC库自动管理） |
| DIR1 | Q10.1 | Bool | X轴方向输出 | 控制2（MC库自动管理） |
| CP2 | Q10.2 | Bool | Y轴脉冲输出 | 控制3（MC库自动管理） |
| DIR2 | Q10.3 | Bool | Y轴方向输出 | 控制4（MC库自动管理） |
| 工作台加紧 | Q10.4 | Bool | 工作台夹紧气缸 | 控制5 |
| 钻下降 | Q10.5 | Bool | 钻头下降气缸 | 控制6 |
| 钻运行 | Q10.6 | Bool | 钻头旋转电机 | 控制7 |

**注意**：
- IO地址范围：输入I4.0~I5.7，输出Q10.0~Q11.7
- 传感器编号（检测1~5）严格按照现场IO连接表分配
- 执行器编号（控制1~7）严格按照现场IO连接表分配
- 脉冲输出（控制1~4）由MC库自动管理，无需手动配置

---

## 九、编译和下载

### 9.1 编译项目
1. 点击菜单栏 **项目** → **编译** → **软件（全部重建）**
2. 检查编译结果，确保无错误

### 9.2 连接PLC
1. 点击菜单栏 **在线** → **下载到设备**
2. 选择连接方式（如：PN/IE）
3. 选择目标设备
4. 点击 **下载**

### 9.3 切换到运行模式
1. 下载完成后，选择 **启动模块**
2. 切换到 **RUN** 模式

---

## 十、调试和监控

### 10.1 创建监控表
1. **项目树** → **监控与强制表** → 右键 → **添加新监控表**
2. 添加需要监控的变量：
   - 输入变量（I4.0~I4.6）
   - 输出变量（Q10.4~Q10.6）
   - 脉冲输出（Q10.0~Q10.3，由MC库控制）
   - 内部状态（DB_钻孔控制.状态）

### 10.2 测试步骤

#### 测试1：系统上电
- 置位 `系统上电标志`（M0.0）
- 观察X轴、Y轴是否开始回原点
- 检查限位信号是否正常

#### 测试2：启动流程
- 确认所有限位到位（I4.3, I4.5, I4.6 = TRUE，即x轴左限位、y轴前限位、气缸原点检测）
- 按下启动按钮（I4.0）
- 观察状态机是否进入放料状态

#### 测试3：完整流程
- 观察5秒放料延时
- 检查XY轴是否开始移动
- 验证钻头下降和运行

---

## 十一、常见问题排查

### 问题1：MC块报错
**现象**：编译时提示MC块未找到
**解决**：
- 确认已创建工艺对象（X轴、Y轴）
- 确认MC块实例DB已正确关联
- 检查轴名称是否与代码中一致（"X轴"、"Y轴"）

### 问题2：轴不运动
**现象**：程序运行但轴不动
**解决**：
- 检查MC_Power的Enable是否为TRUE
- 检查MC_MoveJog的JogForward/JogBackward是否有信号
- 检查驱动器使能信号
- 检查硬件接线

### 问题3：限位不生效
**现象**：到达限位后轴继续运动
**解决**：
- 检查限位开关接线
- 检查限位信号在监控表中的状态
- 确认限位逻辑在代码中正确执行

---

## 十二、文件清单

项目完成后应包含以下文件：

```
钻孔系统_MC版/
├── 设备/
│   └── PLC_1/
│       ├── 硬件配置
│       └── 工艺对象/
│           ├── X轴
│           └── Y轴
├── 程序块/
│   ├── Main [OB1]
│   ├── FB1 "钻孔控制_MC版"
│   ├── DB_钻孔控制
│   ├── MC_POWER_DB
│   ├── MC_POWER_DB_1
│   ├── MC_RESET_DB
│   ├── MC_RESET_DB_1
│   ├── MC_MOVEJOG_DB
│   └── MC_MOVEJOG_DB_1
└── PLC变量/
    └── 默认变量表
```

---

## 注意事项

1. **IO地址范围**：输入I4.0~I5.7，输出Q10.0~Q11.7，需在TIA Portal中正确配置IO模块
2. **传感器编号**：严格按照现场IO连接表分配，检测1~5对应I4.2~I4.6
3. **执行器编号**：控制1~7对应Q10.0~Q10.6，其中控制1~4由MC库自动管理
4. **轴名称必须一致**：代码中使用的轴名称（"X轴"、"Y轴"）必须与工艺对象中的名称完全一致
5. **MC块实例DB名称**：必须与代码中调用的名称一致（MC_POWER_DB、MC_POWER_DB_1等）
6. **脉冲输出**：由工艺对象自动管理，无需手动配置CP/DIR输出点
7. **速度参数**：代码中速度设为100.0，可根据实际需求调整
8. **编译顺序**：先创建工艺对象和MC块实例DB，再导入SCL代码
9. **详细IO映射**：参考 `IO映射表_MC库版.md` 文件

---

## 快速检查清单

- [ ] 项目已创建
- [ ] PLC硬件已配置
- [ ] 工艺对象（X轴、Y轴）已创建
- [ ] MC块实例DB已创建（6个）
- [ ] SCL代码已导入
- [ ] 主程序实例DB已创建
- [ ] OB1中已编写调用代码
- [ ] IO变量表已配置
- [ ] 项目编译无错误
- [ ] 程序已下载到PLC
- [ ] 监控表已创建

完成以上步骤后，您的钻孔系统MC库版本项目就创建完成了！

