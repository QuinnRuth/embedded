# Python-PLC è½¨è¿¹é€šè®¯æ¶æ„

## æ•´ä½“æ¶æ„

```mermaid
flowchart LR
    subgraph PC["ğŸ–¥ï¸ PC ç«¯"]
        PY["Python<br/>run.py"]
    end

    subgraph PLC["ğŸ“Ÿ S7-1500 PLC"]
        subgraph DB["DB200_Traj<br/>é€šè®¯æ¡¥æ¢"]
            D1["X_Setpoint<br/>Y_Setpoint<br/>Velocity"]
            D2["Enable<br/>NewPoint"]
            D3["Busy<br/>Done<br/>Error"]
        end
        
        FB["FB_PythonFollow<br/>çŠ¶æ€æœº"]
        
        subgraph MC["MC_MoveAbsolute"]
            MCX["Xè½´"]
            MCY["Yè½´"]
        end
    end

    PY -->|"â‘  å†™åæ ‡+æ ‡å¿—"| DB
    DB -->|"â‘¡ è¯»åæ ‡"| FB
    FB -->|"â‘¢ Position/Execute"| MC
    MC -->|"â‘£ Done"| FB
    FB -->|"â‘¤ å†™ Busy/Done"| DB
    DB -->|"â‘¥ è½®è¯¢çŠ¶æ€"| PY

    style DB fill:#e1f5fe
    style FB fill:#fff3e0
    style MC fill:#e8f5e9
```

## æ—¶åºå›¾ï¼ˆè¯¦ç»†ç‰ˆï¼‰

```mermaid
sequenceDiagram
    participant PY as Python<br/>(snap7)
    participant DB as DB200<br/>(éä¼˜åŒ–DB)
    participant FB as FB_PythonFollow<br/>(OB1æ¯å‘¨æœŸè°ƒç”¨)
    participant MC as MC_MoveAbsolute<br/>(Xè½´/Yè½´)

    Note over PY,MC: â•â•â•â•â•â•â•â•â•â•â• ç¬¬ N ä¸ªç‚¹çš„å®Œæ•´æ¡æ‰‹æµç¨‹ â•â•â•â•â•â•â•â•â•â•â•

    rect rgb(230, 245, 255)
        Note over PY,DB: ã€é˜¶æ®µ1ã€‘Python å†™å…¥ç›®æ ‡ç‚¹
        PY->>DB: db_write(200, 0, 16å­—èŠ‚)<br/>â”Œ DBD0 = X_Setpoint (Real)<br/>â”œ DBD4 = Y_Setpoint (Real)<br/>â”œ DBD8 = Velocity (Real)<br/>â”œ DBW12 = PointIndex (Int)<br/>â”œ DBX14.4 = Enable := TRUE<br/>â”” DBX14.0 = NewPoint := TRUE
    end

    rect rgb(255, 243, 224)
        Note over FB,DB: ã€é˜¶æ®µ2ã€‘FB æ£€æµ‹åˆ°æ–°ç‚¹ï¼Œé”å­˜åæ ‡
        FB->>DB: è¯»å– DBX14.4 (Enable)
        DB-->>FB: Enable = TRUE âœ“
        FB->>DB: è¯»å– DBX14.0 (NewPoint)
        DB-->>FB: NewPoint = TRUE âœ“
        
        FB->>FB: é”å­˜åæ ‡åˆ°å†…éƒ¨å˜é‡<br/>rç›®æ ‡X := DBD0<br/>rç›®æ ‡Y := DBD4
        
        FB->>DB: å†™å…¥æ¡æ‰‹å“åº”<br/>DBX14.1 = Busy := TRUE<br/>DBX14.2 = Done := FALSE
    end

    rect rgb(232, 245, 233)
        Note over FB,MC: ã€é˜¶æ®µ3ã€‘FB é©±åŠ¨ MC è¿åŠ¨
        FB->>MC: Xè½´ç›®æ ‡ä½ç½® â†’ Position (LReal)<br/>Yè½´ç›®æ ‡ä½ç½® â†’ Position (LReal)
        FB->>MC: Xè½´å®šä½å¯åŠ¨ := TRUE â†’ Execute<br/>Yè½´å®šä½å¯åŠ¨ := TRUE â†’ Execute
        
        Note over MC: âš™ï¸ è½´è¿åŠ¨ä¸­...<br/>(Execute ä¿æŒ TRUE)
        
        MC-->>FB: Xè½´: Done := TRUE
        MC-->>FB: Yè½´: Done := TRUE
    end

    rect rgb(255, 235, 238)
        Note over FB,DB: ã€é˜¶æ®µ4ã€‘FB å®Œæˆï¼Œå†™å›çŠ¶æ€
        FB->>MC: Xè½´å®šä½å¯åŠ¨ := FALSE<br/>Yè½´å®šä½å¯åŠ¨ := FALSE
        
        FB->>DB: å†™å…¥å®ŒæˆçŠ¶æ€<br/>DBX14.1 = Busy := FALSE<br/>DBX14.2 = Done := TRUE<br/>DBX14.0 = NewPoint := FALSE
    end

    rect rgb(243, 229, 245)
        Note over PY,DB: ã€é˜¶æ®µ5ã€‘Python è½®è¯¢ç¡®è®¤
        loop æ¯ 50ms è½®è¯¢
            PY->>DB: db_read(200, 14, 1å­—èŠ‚)
            DB-->>PY: è¿”å›çŠ¶æ€å­—èŠ‚
            PY->>PY: æ£€æŸ¥ bit1(Busy) / bit2(Done)
        end
        
        Note over PY: Done=1 ä¸” Busy=0 â†’ å®Œæˆ âœ“
    end

    Note over PY,MC: â•â•â•â•â•â•â•â•â•â•â• å‘é€ç¬¬ N+1 ä¸ªç‚¹... â•â•â•â•â•â•â•â•â•â•â•
```

## DB200_Traj å†…å­˜å¸ƒå±€

```mermaid
block-beta
    columns 1
    
    block:header
        columns 4
        h1["åç§»"] h2["å­—èŠ‚æ•°"] h3["å˜é‡å"] h4["è¯»/å†™æ–¹"]
    end
    
    block:row0
        columns 4
        a1["0-3"] a2["4"] a3["X_Setpoint (Real)"] a4["Pythonå†™ / FBè¯»"]
    end
    
    block:row1
        columns 4
        b1["4-7"] b2["4"] b3["Y_Setpoint (Real)"] b4["Pythonå†™ / FBè¯»"]
    end
    
    block:row2
        columns 4
        c1["8-11"] c2["4"] c3["Velocity (Real)"] c4["Pythonå†™"]
    end
    
    block:row3
        columns 4
        d1["12-13"] d2["2"] d3["PointIndex (Int)"] d4["Pythonå†™"]
    end
    
    block:row4
        columns 4
        e1["14.0"] e2["1bit"] e3["NewPoint"] e4["Pythonå†™ / FBæ¸…"]
    end
    
    block:row5
        columns 4
        f1["14.1"] f2["1bit"] f3["Busy"] f4["FBå†™ / Pythonè¯»"]
    end
    
    block:row6
        columns 4
        g1["14.2"] g2["1bit"] g3["Done"] g4["FBå†™ / Pythonè¯»"]
    end
    
    block:row7
        columns 4
        i1["14.3"] i2["1bit"] i3["Error"] i4["FBå†™ / Pythonè¯»"]
    end
    
    block:row8
        columns 4
        j1["14.4"] j2["1bit"] j3["Enable"] j4["Pythonå†™ / FBè¯»"]
    end
```

## æ¡æ‰‹ä¿¡å·è¯¦è§£

```mermaid
sequenceDiagram
    participant PY as Python
    participant PLC as PLC (FB)

    Note over PY,PLC: ã€æ¡æ‰‹åè®®ï¼šå•ç‚¹ç¡®è®¤åˆ¶ã€‘

    PY->>PLC: å†™ Enable=1 (å¯åŠ¨æ¨¡å¼)
    PY->>PLC: å†™ NewPoint=1 (æœ‰æ–°ç‚¹)
    
    Note over PY: ç­‰å¾… Busy ä¸Šå‡...
    
    PLC-->>PY: Busy=1 (å·²æ¥æ”¶ï¼Œå¼€å§‹æ‰§è¡Œ)
    
    Note over PY: ç­‰å¾… Done ä¸” !Busy...
    
    PLC-->>PY: Done=1, Busy=0 (æ‰§è¡Œå®Œæˆ)
    PLC-->>PY: NewPoint=0 (å·²æ¶ˆè´¹)
    
    Note over PY: ç¡®è®¤å®Œæˆ âœ“ å¯å‘ä¸‹ä¸€ç‚¹

    Note over PY,PLC: ã€é”™è¯¯å¤„ç†ã€‘
    
    alt æ­£å¸¸å®Œæˆ
        PLC-->>PY: Error=0
        PY->>PY: å‘é€ä¸‹ä¸€ç‚¹
    else è½´æŠ¥é”™
        PLC-->>PY: Error=1
        PY->>PY: åœæ­¢å‘é€ï¼ŒæŠ¥è­¦
    end
```

## Python ä»£ç ä¸å†…å­˜å¯¹ç…§

| Python ä»£ç  | DB200 åœ°å€ | å­—èŠ‚åç§» | ä½åç§» | è¯´æ˜ |
|------------|-----------|---------|-------|------|
| `set_real(data, 0, x)` | DBD0 | 0-3 | - | X åæ ‡ (4å­—èŠ‚æµ®ç‚¹) |
| `set_real(data, 4, y)` | DBD4 | 4-7 | - | Y åæ ‡ (4å­—èŠ‚æµ®ç‚¹) |
| `set_real(data, 8, v)` | DBD8 | 8-11 | - | é€Ÿåº¦ (4å­—èŠ‚æµ®ç‚¹) |
| `set_int(data, 12, i)` | DBW12 | 12-13 | - | ç‚¹ç´¢å¼• (2å­—èŠ‚æ•´æ•°) |
| `set_bool(data, 14, 0, True)` | DBX14.0 | 14 | bit0 | NewPoint æ ‡å¿— |
| `set_bool(data, 14, 1, v)` | DBX14.1 | 14 | bit1 | Busy æ ‡å¿— |
| `set_bool(data, 14, 2, v)` | DBX14.2 | 14 | bit2 | Done æ ‡å¿— |
| `set_bool(data, 14, 3, v)` | DBX14.3 | 14 | bit3 | Error æ ‡å¿— |
| `set_bool(data, 14, 4, True)` | DBX14.4 | 14 | bit4 | Enable æ ‡å¿— |
| `get_bool(data, 0, 1)` | DBX14.1 | 14 | bit1 | è¯» Busy |
| `get_bool(data, 0, 2)` | DBX14.2 | 14 | bit2 | è¯» Done |

## çŠ¶æ€æœº

```mermaid
stateDiagram-v2
    [*] --> ç©ºé—²
    ç©ºé—² --> ç­‰å¾…æ–°ç‚¹: Enable=TRUE
    ç­‰å¾…æ–°ç‚¹ --> æ‰§è¡Œè¿åŠ¨: NewPoint=TRUE
    æ‰§è¡Œè¿åŠ¨ --> å®Œæˆ: X_Done & Y_Done
    å®Œæˆ --> ç­‰å¾…æ–°ç‚¹: è‡ªåŠ¨è¿”å›
    ç­‰å¾…æ–°ç‚¹ --> ç©ºé—²: Enable=FALSE
```

## æ•°æ®æµå¯¹ç…§è¡¨

| æ­¥éª¤ | æ–¹å‘ | æ•°æ®/ä¿¡å· | è¯´æ˜ |
|:---:|:---:|---|---|
| â‘  | Python â†’ DB | X/Y/V + Enable + NewPoint | Python å†™å…¥ç›®æ ‡ç‚¹ |
| â‘¡ | DB â†’ FB | X_Setpoint, Y_Setpoint | FB è¯»å–åæ ‡ |
| â‘¢ | FB â†’ DB | Busy = TRUE | FB æ ‡è®°å¼€å§‹æ‰§è¡Œ |
| â‘£ | FB â†’ MC | Position + Execute | é©±åŠ¨ MC è¿åŠ¨ |
| â‘¤ | MC â†’ FB | Done | è½´åˆ°ä½åé¦ˆ |
| â‘¥ | FB â†’ MC | Execute = FALSE | åœæ­¢è§¦å‘ |
| â‘¦ | FB â†’ DB | Busy=0, Done=1, NewPoint=0 | FB æ ‡è®°å®Œæˆ |
| â‘§ | DB â†’ Python | Done = TRUE | Python ç¡®è®¤å®Œæˆ |

## å…³é”®ä»£ç 

### Python ä¾§ (`run.py`)

```python
# å†™å…¥ç›®æ ‡
set_real(data, 0, x)           # X_Setpoint
set_real(data, 4, y)           # Y_Setpoint
set_bool(data, 14, 4, True)    # Enable
set_bool(data, 14, 0, True)    # NewPoint

# è½®è¯¢çŠ¶æ€
done = get_bool(data, 0, 2)    # Done ä½
busy = get_bool(data, 0, 1)    # Busy ä½
```

### PLC ä¾§ (`FB_PythonFollow.scl`)

```scl
// è¯»å–åæ ‡
#rç›®æ ‡X := REAL_TO_LREAL("DB200_Traj".X_Setpoint);
#rç›®æ ‡Y := REAL_TO_LREAL("DB200_Traj".Y_Setpoint);

// è¾“å‡ºåˆ° MC
#Xè½´ç›®æ ‡ä½ç½® := #rç›®æ ‡X;
#Xè½´å®šä½å¯åŠ¨ := TRUE;

// å†™å…¥çŠ¶æ€
"DB200_Traj".Busy := TRUE;
"DB200_Traj".Done := TRUE;
```

## ä¸€å¥è¯æ€»ç»“

> **Python åªè´Ÿè´£å¾€ DB200 å†™åæ ‡å’Œæ ‡å¿—ï¼ŒFB æ¯å‘¨æœŸè‡ªåŠ¨ä» DB200 è¯»å€¼å¹¶é©±åŠ¨ MCï¼Œæœ€åæŠŠçŠ¶æ€å†™å› DB200 ç»™ Python çœ‹â€”â€”DB200 å°±æ˜¯ä¸¤è¾¹çš„"æ¡¥æ¢"ã€‚**

