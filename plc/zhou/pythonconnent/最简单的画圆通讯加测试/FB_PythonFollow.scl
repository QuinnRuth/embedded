// ============================================================================
// FB_PythonFollow - Python 跟随运动控制功能块
// 文件名: FB_PythonFollow.scl
// 版本: 1.0
// 兼容: SIMATIC S7-1500, TIA Portal V17/V18
// 编码: UTF-8
// ============================================================================
// 功能说明:
//   - 读取 DB200_Traj 中的目标位置
//   - 使用 MC_MoveAbsolute 执行单点运动
//   - 单点握手协议：NewPoint → Busy → Done
// ============================================================================
// 使用方法:
//   1. 在 OB1 中调用此 FB
//   2. 将 MC 块的反馈信号连接到此 FB
//   3. 将此 FB 的输出连接到 MC_MoveAbsolute
// ============================================================================

FUNCTION_BLOCK "Python跟随控制"
{ S7_Optimized_Access := 'TRUE' }
VERSION : 1.0

// ============================================================================
// 输入变量
// ============================================================================
VAR_INPUT
    // 仅保留绝对定位完成反馈
    X轴定位完成 : Bool;           // MC_MoveAbsolute_X.Done
    Y轴定位完成 : Bool;           // MC_MoveAbsolute_Y.Done
END_VAR

// ============================================================================
// 输出变量
// ============================================================================
VAR_OUTPUT
    // 仅与 MC_MoveAbsolute 相连的引脚
    X轴目标位置 : LReal;          // → MC_MoveAbsolute_X.Position (LReal)
    Y轴目标位置 : LReal;          // → MC_MoveAbsolute_Y.Position (LReal)
    X轴定位启动 : Bool;           // → MC_MoveAbsolute_X.Execute
    Y轴定位启动 : Bool;           // → MC_MoveAbsolute_Y.Execute
    
    // 状态监控
    当前状态 : Int;
END_VAR

// ============================================================================
// 常量
// ============================================================================
VAR CONSTANT
    c状态_空闲 : Int := 0;
    c状态_等待新点 : Int := 10;
    c状态_执行运动 : Int := 20;
    c状态_完成 : Int := 40;
END_VAR

// ============================================================================
// 静态变量
// ============================================================================
VAR
    主状态 : Int := 0;
    r目标X : LReal;
    r目标Y : LReal;
END_VAR

// ============================================================================
// 主程序
// ============================================================================
BEGIN
    // ========================================================================
    // 状态机
    // ========================================================================
    CASE #主状态 OF
        
        // ====== 空闲 ======
        c状态_空闲:
            #X轴定位启动 := FALSE;
            #Y轴定位启动 := FALSE;
            "DB200_Traj".Busy := FALSE;
            "DB200_Traj".Done := FALSE;
            
            // 检查 Python 模式是否使能
            IF "DB200_Traj".Enable THEN
                #主状态 := #c状态_等待新点;
            END_IF;
            
        // ====== 等待新点 ======
        c状态_等待新点:
            #X轴定位启动 := FALSE;
            #Y轴定位启动 := FALSE;
            "DB200_Traj".Busy := FALSE;
            
            // 检查是否退出 Python 模式
            IF NOT "DB200_Traj".Enable THEN
                #主状态 := #c状态_空闲;
            // 检查是否有新点
            ELSIF "DB200_Traj".NewPoint THEN
                // 读取目标位置
                #r目标X := REAL_TO_LREAL("DB200_Traj".X_Setpoint);
                #r目标Y := REAL_TO_LREAL("DB200_Traj".Y_Setpoint);
                
                // 设置输出
                #X轴目标位置 := #r目标X;
                #Y轴目标位置 := #r目标Y;
                
                // 标记正在执行
                "DB200_Traj".Busy := TRUE;
                "DB200_Traj".Done := FALSE;
                
                #主状态 := #c状态_执行运动;
            END_IF;
            
        // ====== 执行运动 ======
        c状态_执行运动:
            // 持续给 Execute 信号直到 Done
            #X轴定位启动 := TRUE;
            #Y轴定位启动 := TRUE;
            
            // 检查是否两轴都到位
            IF #X轴定位完成 AND #Y轴定位完成 THEN
                #主状态 := #c状态_完成;
            END_IF;
            
            // 检查是否退出 Python 模式
            IF NOT "DB200_Traj".Enable THEN
                #X轴定位启动 := FALSE;
                #Y轴定位启动 := FALSE;
                "DB200_Traj".Busy := FALSE;
                #主状态 := #c状态_空闲;
            END_IF;
            
        // ====== 完成 ======
        c状态_完成:
            #X轴定位启动 := FALSE;
            #Y轴定位启动 := FALSE;
            
            // 标记完成，清除新点标志
            "DB200_Traj".Busy := FALSE;
            "DB200_Traj".Done := TRUE;
            "DB200_Traj".NewPoint := FALSE;
            
            // 返回等待新点
            #主状态 := #c状态_等待新点;
            
        ELSE
            #主状态 := #c状态_空闲;
            
    END_CASE;
    
    // ========================================================================
    // 状态输出
    // ========================================================================
    #当前状态 := #主状态;
    
END_FUNCTION_BLOCK


