# 钻孔+画圆控制系统 - 项目架构与安全验证清单

## 一、项目架构图

### 1.1 系统总体架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           钻孔+画圆控制系统 V2.0                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │                          应用层 (Application Layer)                     │ │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────┐ │ │
│  │  │   钻孔模式      │  │   画圆模式      │  │      安全管理           │ │ │
│  │  │  - 放料         │  │  - 初始化       │  │  - 急停处理             │ │ │
│  │  │  - XY移动       │  │  - 移动到起点   │  │  - 限位保护             │ │ │
│  │  │  - 钻下降       │  │  - 插补运行     │  │  - 碰撞检测             │ │ │
│  │  │  - 钻运行       │  │  - 完成         │  │  - 错误处理             │ │ │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────────────┘ │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                    │                                         │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │                          控制层 (Control Layer)                         │ │
│  │  ┌─────────────────────────────────────────────────────────────────┐   │ │
│  │  │                    FB_MainControl (主流程控制)                   │   │ │
│  │  │  ┌───────────────────┐  ┌────────────────────────────────────┐  │   │ │
│  │  │  │   状态机管理      │  │         插补计算                    │  │   │ │
│  │  │  │  - IDLE          │  │  - FC_CircleInterpolate            │  │   │ │
│  │  │  │  - HOMING        │  │  - FC_CirclePathCheck              │  │   │ │
│  │  │  │  - DRILL         │  │  - FC_AngleNormalize               │  │   │ │
│  │  │  │  - CIRCLE        │  │  - FC_VelocityLimit                │  │   │ │
│  │  │  │  - ERROR         │  │  - FC_PositionInRange              │  │   │ │
│  │  │  └───────────────────┘  └────────────────────────────────────┘  │   │ │
│  │  └─────────────────────────────────────────────────────────────────┘   │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                    │                                         │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │                          运动层 (Motion Layer)                          │ │
│  │  ┌───────────────────────────┐  ┌───────────────────────────────────┐  │ │
│  │  │        X轴 MC块          │  │           Y轴 MC块                │  │ │
│  │  │  - MC_Power              │  │  - MC_Power                       │  │ │
│  │  │  - MC_Reset              │  │  - MC_Reset                       │  │ │
│  │  │  - MC_MoveJog            │  │  - MC_MoveJog                     │  │ │
│  │  │  - MC_MoveAbsolute       │  │  - MC_MoveAbsolute                │  │ │
│  │  └───────────────────────────┘  └───────────────────────────────────┘  │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                    │                                         │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │                          数据层 (Data Layer)                            │ │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────┐ │ │
│  │  │ DB_MainControl  │  │ DB_MotionParams │  │      DB_Status          │ │ │
│  │  │ (实例DB)        │  │ (运动参数)      │  │  (系统状态)             │ │ │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────────────┘ │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 二、文件结构

```
画圆扩展版/
├── FB_MainControl.scl      # 主流程控制功能块
├── FC_CircleInterpolate.scl # 圆弧插补函数集
├── DB_MotionParams.scl     # 运动参数数据块
├── DB_Status.scl           # 系统状态数据块
├── OB1_Main.scl            # 主程序和启动OB
└── 文档/
    ├── IO映射表.md
    ├── OB1配置手册.md
    └── README.md
```

---

## 三、状态机设计

### 3.1 主状态
| 状态值 | 状态名 | 说明 |
|--------|--------|------|
| 0 | 空闲 | 等待上电 |
| 10 | 回原点 | 点动回原点 |
| 20 | 等待启动 | 等待启动按钮 |
| 30 | 钻孔_放料 | 放料等待 |
| 40 | 钻孔_XY移动 | XY轴移动 |
| 50 | 钻孔_钻下降 | 钻头下降 |
| 60 | 钻孔_钻运行 | 钻头运行 |
| 70 | 钻孔_复位 | 循环复位 |
| 100 | 画圆_初始化 | 参数检查 |
| 110 | 画圆_移动起点 | 移动到起点 |
| 120 | 画圆_插补运行 | 插补运行 |
| 130 | 画圆_完成 | 完成等待 |
| 999 | 错误 | 错误状态 |

---

## 四、安全验证清单

### 4.1 硬件安全
- [ ] 急停按钮接线正确
- [ ] 限位开关接线正确且方向正确
- [ ] 脉冲/方向输出接线正确
- [ ] 气缸输出接线正确

### 4.2 软件安全
- [ ] 急停处理优先级最高
- [ ] 限位保护在状态机前后双重检查
- [ ] 轴错误检测正常
- [ ] 定位超时保护正常
- [ ] 参数范围检查正常

### 4.3 运行测试
- [ ] 回原点功能正常
- [ ] 限位触发停止正常
- [ ] 急停功能正常
- [ ] 复位功能正常
- [ ] 画圆轨迹正确

---

## 五、错误代码表

| 错误码 | 含义 | 处理方式 |
|--------|------|----------|
| 0 | 无错误 | - |
| 1 | 急停触发 | 松开急停，按复位 |
| 2 | X轴故障 | 检查X轴驱动器 |
| 3 | Y轴故障 | 检查Y轴驱动器 |
| 4 | 限位触发 | 检查限位开关 |
| 5 | 定位超时 | 检查轴运动 |
| 6 | 参数无效 | 检查圆参数 |
| 7 | 碰撞风险 | 调整圆参数 |

---

## 六、版本历史

| 版本 | 日期 | 说明 |
|------|------|------|
| 1.0 | 2024 | 初始版本 |
| 2.0 | 2024 | 添加画圆功能 |

