// ============================================================================
// FB_PythonFollow_HardcodedPoints - 硬编码轨迹点的运动控制功能块
// 文件名: FB_PythonFollow_HardcodedPoints.scl
// 版本: 2.0
// 兼容: SIMATIC S7-1500, TIA Portal V17/V18
// 编码: UTF-8 with BOM
// ============================================================================
// 功能说明:
//   - 使用硬编码的"正"字轨迹点
//   - 仅与 MC 相关，无 DB200 依赖
//   - 自动按顺序执行所有点
// ============================================================================
// 轨迹点说明:
//   12 个点绘制"正"字，一笔画完成
//   起点：上中 → 左上 → 右上 → 回上中 → 中中 → 中横右半 → 回中中 → 中下
//   → 抬笔到中上 → 右下 → 回中下 → 左下（收笔）
// ============================================================================

FUNCTION_BLOCK "Python跟随控制_硬编码点"
{ S7_Optimized_Access := 'TRUE' }
VERSION : 2.0

// ============================================================================
// 输入变量
// ============================================================================
VAR_INPUT
    启动 : Bool;                  // 启动轨迹执行（上升沿触发）
    停止 : Bool;                  // 停止轨迹执行（立即停止）
    X轴定位完成 : Bool;           // MC_MoveAbsolute_X.Done
    Y轴定位完成 : Bool;           // MC_MoveAbsolute_Y.Done
END_VAR

// ============================================================================
// 输出变量
// ============================================================================
VAR_OUTPUT
    X轴目标位置 : LReal;          // → MC_MoveAbsolute_X.Position (LReal)
    Y轴目标位置 : LReal;          // → MC_MoveAbsolute_Y.Position (LReal)
    X轴定位启动 : Bool;           // → MC_MoveAbsolute_X.Execute
    Y轴定位启动 : Bool;           // → MC_MoveAbsolute_Y.Execute
    运行中 : Bool;                // 正在执行轨迹
    已完成 : Bool;                // 所有点执行完成
    当前点索引 : Int;             // 当前执行的点编号
    当前状态 : Int;               // 状态机当前状态
END_VAR

// ============================================================================
// 常量
// ============================================================================
VAR CONSTANT
    // 状态常量
    c状态_空闲 : Int := 0;
    c状态_执行运动 : Int := 10;
    c状态_等待完成 : Int := 20;
    c状态_下一点 : Int := 30;
    c状态_全部完成 : Int := 40;

    // 总点数
    c总点数 : Int := 12;
END_VAR

// ============================================================================
// 静态变量
// ============================================================================
VAR
    主状态 : Int := 0;
    点索引 : Int := 0;
    启动_上次值 : Bool := FALSE;

    // 轨迹点数组 - "正"字坐标
    轨迹X : Array[0..11] of Real := [
        491.3,   // Point 0: 起点：上中
        391.3,   // Point 1: 左上
        591.3,   // Point 2: 右上
        491.3,   // Point 3: 回上中
        491.3,   // Point 4: 中中
        391.3,   // Point 5: 中横右半段
        491.3,   // Point 6: 回中中
        491.3,   // Point 7: 中下
        541.3,   // Point 8: 抬笔到中上（中下与右下之间）
        591.3,   // Point 9: 右下
        491.3,   // Point 10: 回中下
        391.3    // Point 11: 左下（收笔）
    ];

    轨迹Y : Array[0..11] of Real := [
        233.9,   // Point 0: 起点：上中
        233.9,   // Point 1: 左上
        233.9,   // Point 2: 右上
        233.9,   // Point 3: 回上中
        133.9,   // Point 4: 中中
        133.9,   // Point 5: 中横右半段
        133.9,   // Point 6: 回中中
        33.9,    // Point 7: 中下
        183.9,   // Point 8: 抬笔到中上（中中和上之间）
        33.9,    // Point 9: 右下
        33.9,    // Point 10: 回中下
        33.9     // Point 11: 左下（收笔）
    ];
END_VAR

// ============================================================================
// 主程序
// ============================================================================
BEGIN
    // ========================================================================
    // 停止信号：立即停止（优先级最高）
    // ========================================================================
    IF #停止 THEN
        #X轴定位启动 := FALSE;
        #Y轴定位启动 := FALSE;
        #运行中 := FALSE;
        #点索引 := 0;
        #主状态 := #c状态_空闲;
    END_IF;

    // ========================================================================
    // 启动信号上升沿检测
    // ========================================================================
    IF #启动 AND NOT #启动_上次值 AND NOT #停止 THEN
        IF #主状态 = #c状态_空闲 OR #主状态 = #c状态_全部完成 THEN
            #点索引 := 0;
            #已完成 := FALSE;
            #主状态 := #c状态_执行运动;
        END_IF;
    END_IF;
    #启动_上次值 := #启动;

    // ========================================================================
    // 状态机
    // ========================================================================
    CASE #主状态 OF

        // ====== 空闲 ======
        c状态_空闲:
            #X轴定位启动 := FALSE;
            #Y轴定位启动 := FALSE;
            #运行中 := FALSE;
            #已完成 := FALSE;
            #点索引 := 0;

        // ====== 执行运动 ======
        c状态_执行运动:
            // 读取当前点坐标
            #X轴目标位置 := REAL_TO_LREAL(#轨迹X[#点索引]);
            #Y轴目标位置 := REAL_TO_LREAL(#轨迹Y[#点索引]);

            // 启动 MC
            #X轴定位启动 := TRUE;
            #Y轴定位启动 := TRUE;
            #运行中 := TRUE;
            #已完成 := FALSE;

            #主状态 := #c状态_等待完成;

        // ====== 等待完成 ======
        c状态_等待完成:
            // 检查是否两轴都到位
            IF #X轴定位完成 AND #Y轴定位完成 THEN
                #X轴定位启动 := FALSE;
                #Y轴定位启动 := FALSE;
                #主状态 := #c状态_下一点;
            END_IF;

        // ====== 下一点 ======
        c状态_下一点:
            #点索引 := #点索引 + 1;

            // 检查是否还有点
            IF #点索引 < #c总点数 THEN
                #主状态 := #c状态_执行运动;
            ELSE
                #主状态 := #c状态_全部完成;
            END_IF;

        // ====== 全部完成 ======
        c状态_全部完成:
            #X轴定位启动 := FALSE;
            #Y轴定位启动 := FALSE;
            #运行中 := FALSE;
            #已完成 := TRUE;

            // 保持在完成状态，等待下一次启动上升沿

        ELSE
            #主状态 := #c状态_空闲;

    END_CASE;

    // ========================================================================
    // 状态输出
    // ========================================================================
    #当前状态 := #主状态;
    #当前点索引 := #点索引;

END_FUNCTION_BLOCK
