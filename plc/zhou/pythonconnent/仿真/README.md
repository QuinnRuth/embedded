# Python 仿真 + PLC 同步控制系统

## 项目架构

```
py测试/
├── README.md              # 项目说明
├── requirements.txt       # 依赖库
├── config.yaml            # 配置文件
├── main.py                # 主程序入口
├── models.py              # 数据模型（dataclass）
├── plc_client.py          # PLC 通信模块（线程安全）
├── simulator.py           # 仿真引擎（matplotlib 动画）
├── trajectory.py          # 轨迹生成器
└── utils.py               # 工具函数
```

## 核心功能

1. **实时仿真**：使用 matplotlib 动画显示机器人运动
2. **PLC 同步控制**：多线程实现仿真与实际运动同步
3. **状态监控**：实时显示位置、速度、状态
4. **轨迹生成**：支持圆形、直线、自定义轨迹

## 技术栈

- **Python 3.10+**（类型提示、dataclass）
- **matplotlib**（动画可视化）
- **python-snap7**（PLC 通信）
- **PyYAML**（配置管理）
- **threading**（多线程同步）

## 架构设计

```
┌────────────────────────────────────────────────────┐
│                   Main Thread                      │
│  ┌──────────────────────────────────────────────┐ │
│  │  Matplotlib Animation (60 FPS)               │ │
│  │  - 绘制轨迹                                  │ │
│  │  - 更新实时位置                              │ │
│  │  - 显示状态信息                              │ │
│  └──────────────────────────────────────────────┘ │
│           ▲                                        │
│           │ 读取共享状态                           │
│           │                                        │
│  ┌────────┴───────────────────────────────────┐   │
│  │      Shared State (线程安全)              │   │
│  │  - current_position: (x, y)               │   │
│  │  - target_position: (x, y)                │   │
│  │  - status: "idle" | "moving" | "done"     │   │
│  │  - point_index: int                       │   │
│  └────────┬───────────────────────────────────┘   │
│           │ 更新状态                               │
│           ▼                                        │
└────────────────────────────────────────────────────┘
             ▲
             │ 线程安全队列 (Queue)
             │
┌────────────┴───────────────────────────────────────┐
│                   PLC Thread                       │
│  ┌──────────────────────────────────────────────┐ │
│  │  PLC Communication Loop                      │ │
│  │  1. 从队列获取目标点                         │ │
│  │  2. db_write() 发送到 PLC                    │ │
│  │  3. 轮询 Done 标志                           │ │
│  │  4. 更新共享状态（当前位置）                 │ │
│  │  5. 发送下一个点...                          │ │
│  └──────────────────────────────────────────────┘ │
│                                                    │
│  ┌──────────────────────────────────────────────┐ │
│  │  Snap7 Client                                │ │
│  │  - db_read() / db_write()                    │ │
│  │  - 网络重连机制                              │ │
│  └──────────────────────────────────────────────┘ │
└────────────────────────────────────────────────────┘
```

## 使用方法

### 1. 安装依赖
```bash
cd /home/muqiao/dev/plc/zhou/pythonconnent/py测试
pip install -r requirements.txt
```

### 2. 配置 PLC
编辑 `config.yaml`：
```yaml
plc:
  ip: "192.168.0.1"
  db: 200
  velocity: 50.0

simulation:
  fps: 60
  window_size: [800, 600]
  xlim: [0, 800]
  ylim: [-200, 400]
```

### 3. 运行程序
```bash
python main.py
```

## 运行模式

1. **仿真 + PLC 同步**（默认）：实时显示仿真动画，同步控制 PLC
2. **仅仿真模式**：无 PLC 连接，纯仿真测试
3. **仅 PLC 模式**：无仿真窗口，后台控制 PLC

## 快捷键

| 按键 | 功能 | 说明 |
|------|------|------|
| **Q** | 退出程序 | 关闭仿真窗口，断开 PLC 连接 |
| **Space** | 暂停/继续 | 切换 PLC Enable 信号，轴立即停止/继续 |
| **R** | 复位 | 清空轨迹队列，重置状态到起点 |
| **S** | 停止 | 停止 PLC 通信线程 |

## 轨迹类型

| 类型 | 说明 |
|------|------|
| **Circle** | 圆形轨迹（默认） |
| **Star** | 五角星轨迹（一笔画） |
| **Taiji** | 太极图轨迹（含S曲线和鱼眼） |
| **Zheng** | 汉字"正"轨迹（一笔画） |
| **Rectangle** | 矩形轨迹 |

## 滑块控制

| 滑块 | 范围 | 说明 |
|------|------|------|
| Start Angle | 0-360° | 圆轨迹起始角度 |
| Angle Step | 0.5-10° | 相邻点角度间隔 |
| Points | 50-1500 | 轨迹总点数（最大 1500 点）|

## PLC 控制原理

通过 DB200 的 `Enable` 位实现启停控制：

```
Enable = TRUE  → PLC 进入工作状态，接收并执行轨迹点
Enable = FALSE → PLC 立即停止运动，返回空闲状态
```

**无需修改 PLC 代码**，Python 端通过写 DB200 的 Enable 位即可实现完整的启停控制。
