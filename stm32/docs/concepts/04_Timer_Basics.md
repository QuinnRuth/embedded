# 定时器基础 (Timer Basics)

## 概述

STM32 定时器（TIM）是外设中最强大的模块之一，可用于：
- 定时中断（精确计时）
- PWM 输出（控制亮度、速度）
- 外部计数（数脉冲）
- 输入捕获（测频率）
- 编码器接口（测速度）

---

## 四个核心寄存器

### 1. PSC - 预分频器 (Prescaler)

**全名**：PreScaler

**作用**：将系统时钟分频，减慢计数速度

```
PSC = 0   → 72MHz ÷ 1    = 72MHz
PSC = 1   → 72MHz ÷ 2    = 36MHz
PSC = 719 → 72MHz ÷ 720  = 100kHz
```

**比喻**：齿轮减速，决定每一步有多"大"

---

### 2. CNT - 计数器 (Counter)

**全名**：Counter

**作用**：不断往上计数，从 0 开始，到达 ARR 后归零重启

```
CNT 的生命周期：
0 → 1 → 2 → ... → ARR-1 → 0 → 1 → ...
```

**比喻**：跑步者从起点跑，每一步 +1

---

### 3. ARR - 自动重装载值 (Auto-Reload Register)

**全名**：Auto-Reload Register

**作用**：规定 CNT 数到多少就归零（触发更新事件）

```
ARR = 99 时：
CNT = 0, 1, 2, ..., 98, 99
          ↑                    ↑
        开始               归零
CNT = 0, 1, 2, ...
```

**比喻**：终点线，跑到了就重头开始

---

### 4. CCR - 捕获/比较寄存器 (Capture/Compare Register)

**全名**：Capture/Compare Register

**作用**：
- **PWM 模式**：与 CNT 比较，决定输出高低电平
- **输入捕获**：保存 CNT 触发时的值

```
PWM 模式比较逻辑：
CNT < CCR  → 输出 HIGH (LED亮)
CNT ≥ CCR  → 输出 LOW  (LED灭)
```

**比喻**：分界线，跑者在线的这一边亮，另一边灭

---

## 四者关系图

```
┌─────────────────────────────────────────────────────────────────┐
│                   定时器工作流程                          │
├─────────────────────────────────────────────────────────────────┤
│                                                             │
│  72MHz 系统时钟                                           │
│       │                                                     │
│       ▼                                                     │
│   ┌───────────┐                                              │
│   │    PSC    │  减慢时钟                                  │
│   │ (分频器)  │                                            │
│   └─────┬─────┘                                            │
│         │                                                    │
│         ▼                                                    │
│   ┌───────────┐      ┌───────────┐      ┌───────────┐      │
│   │    CNT    │ ←→  │    ARR    │      │    CCR    │      │
│   │  (计数器)  │      │ (重装载值) │      │ (比较值)   │      │
│   │ 0→ARR循环  │      │ 归零触发  │      │ PWM分界   │      │
│   └───────────┘      └───────────┘      └───────────┘      │
│                                                             │
│            定时中断模式           PWM 输出模式                 │
│                                                             │
└─────────────────────────────────────────────────────────────────┘
```

---

## 三种常用模式

### 1. 定时中断模式 (6-1)

**配置**：
- PSC = 7200-1
- ARR = 10000-1
- 周期 = (7200 × 10000) / 72,000,000 = 1 秒

**流程**：
```
CNT 数到 ARR → 触发更新事件 → 产生中断 → 执行 TIM2_IRQHandler()
```

**用途**：每隔固定时间执行某任务（闪灯、采样、喂狗）

---

### 2. 外部时钟模式 (6-2)

**配置**：
- 使用外部时钟源（PA0 = TIM2_ETR）
- PSC = 1-1（不分频）
- ARR = 10-1

**流程**：
```
外部脉冲 → PA0 → CNT 计数 → 数到 10 触发中断
```

**用途**：计数外部信号（脉冲计数、测速）

---

### 3. PWM 输出模式 (6-3)

**配置**：
- PSC = 720-1
- ARR = 100-1
- PWM 频率 = 72MHz / 720 / 100 = 1kHz
- 开启输出比较通道

**流程**：
```
CNT 不断循环，每周期与 CCR 比较：
CNT < CCR → 输出 HIGH
CNT ≥ CCR → 输出 LOW
```

**占空比**：`Duty = CCR / (ARR+1) × 100%`

**用途**：控制亮度、电机速度、舵机角度

---

## 关键公式

### 定时周期公式

```
T = (PSC + 1) × (ARR + 1) / fclk

例：(7200 × 10000) / 72,000,000 = 1 秒
```

### PWM 频率公式

```
fPWM = fclk / (PSC + 1) / (ARR + 1)

例：72,000,000 / 720 / 100 = 1000 Hz = 1kHz
```

### PWM 占空比公式

```
Duty = CCR / (ARR + 1) × 100%

例：CCR = 30, ARR = 99 → 30 / 100 × 100% = 30%
```

---

## GPIO 配置差异

| 模式 | GPIO 模式 | 说明 |
|------|-----------|------|
| 定时中断 | 无需配置 | 不使用引脚输出 |
| 外部时钟 | `GPIO_Mode_IPU` | 上拉输入（PA0 = ETR） |
| PWM 输出 | `GPIO_Mode_AF_PP` | 复用推挽输出 |

**重要**：`GPIO_Mode_AF_PP` 表示引脚控制权交给定时器硬件，而非软件 GPIO 代码。

---

## 关键 HAL/LL 函数

| 函数 | 用途 | 模式 |
|------|------|------|
| `TIM_TimeBaseInit()` | 配置 PSC、ARR、CNT 模式 | 所有 |
| `TIM_OCInit()` | 配置输出比较（PWM） | PWM |
| `TIM_OCStructInit()` | 输出比较结构体默认值初始化 | PWM |
| `TIM_SetCompare1()` | 动态修改 CCR 值 | PWM |
| `TIM_ETRClockMode2Config()` | 配置外部时钟 | 外部时钟 |
| `TIM_ITConfig()` | 使能/失能中断 | 中断 |
| `TIM_Cmd()` | 启动/停止定时器 | 所有 |
| `TIM_GetCounter()` | 读取当前 CNT 值 | 外部时钟 |

---

## 记忆口诀

- **PSC** = 减慢时钟的齿轮
- **CNT** = 正在跑的计数器
- **ARR** = CNT 跑到多少归零
- **CCR** = PWM 的分界线（亮/灭分界点）

---

## 扩展阅读

- STM32 参考手册：定时器章节
- 课程源码：`/stm32/learning/课件/程序源码/STM32Project-有注释版/`
