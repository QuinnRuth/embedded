# 定时器测量维度总结

**日期**: 2026-01-06
**状态**: ✅ 完成

---

## 一句话总结

定时器本质是"时间基准+计数器"，可测量任何能转换成"时间"或"计数"的物理量。

---

## 测量维度矩阵

```
                    ┌─────────────────────────────────┐
                    │      定时器测量的维度矩阵          │
                    └─────────────────────────────────┘
                                    │
         ┌──────────────────────────┼──────────────────────────┐
         │                          │                          │
    【时间维度】              【运动维度】              【状态维度】
         │                          │                          │
    ┌────┴────┐              ┌────┴────┐              ┌────┴────┐
    │         │              │         │              │         │
  瞬时值    积累值         速度量    位置量        方向     数量
    │         │              │         │              │         │
  频率     脉冲数        速度/转速   角度/圈数     正负     计数
  脉冲宽度  累积时间      加速度     位移
  周期
```

---

## 一、时间维度（单点测量）

### 1. 频率
```
测量：两个上升沿之间的时间 → 转换成频率

代码体现：6-6 输入捕获模式
          IC_GetFreq() 返回 Hz

计算公式：
  Freq = 计数器频率 ÷ 周期计数值
  Freq = 1,000,000 ÷ (CCR1 + 1)  // 1MHz定时器
```

### 2. 脉冲宽度
```
定义：高电平持续时间（上升沿 → 下降沿）

高电平 ────────────┐
                  │
低电平             └──────────────────
                  ↑────────────────↑
              脉冲宽度（高电平时间）

计算：
  脉冲宽度 = CCR2 × 计数器周期
           = CCR2 × (1 / 定时器频率)
           = CCR2 × 1μs（当定时器1MHz时）
```

### 3. 占空比
```
定义：高电平时间 / 周期 × 100%

    高电平时间      低电平时间
       (CCR)         (ARR-CCR)
   ┌─────┬─────┐     ┌──────────┐
   │ 高 │     │     │    低     │
   └─────┴─────┘     └──────────┘
   ↑────────────────────────────↑
              周期 (ARR)

代码体现：6-7 PWMI模式
          IC_GetDuty() 返回 %

计算公式：
  占空比 = CCR2 / CCR1 × 100%
          或 CCR / ARR × 100%（PWM输出时）
```

### 4. 周期
```
定义：一个完整周期的时间（上升沿 → 下一个上升沿）

计算：
  周期 = 1 / 频率
  周期 = CCR1 × 计数器周期
```

---

## 二、运动维度（编码器相关）

### 5. 速度/转速
```
测量：单位时间内的计数值

代码体现：6-8 Encoder_Get() 返回 计数/秒
          TIM2中断每100ms读取一次编码器计数

应用：电机转速控制
```

### 6. 方向
```
测量：A/B 相位关系

A相： ────┐         ┌─────
          └─────────┘

B相：   ────┐         ┌───
            └─────────┘

正转：A 超前 B 90° → 正值
反转：B 超前 A 90° → 负值

代码体现：Encoder_Get() 返回正负值
```

### 7. 位置/角度/圈数
```
测量：累积计数值

应用：电机精确定位
      360° = 1000 脉冲 → 每1° ≈ 2.78 计数

计算：
  角度 = 计数 ÷ 分辨率 × 360°
  圈数 = 计数 ÷ 每圈脉冲数
```

### 8. 位移（直线运动）
```
编码器装在直线导轨上：
      1mm = 100 计数
      位移 = 计数 / 100 (mm)
```

### 9. 加速度（差分计算）
```
速度1 - 速度0
加速度 = ────────────────
        Δt

两次读取的速度差即可推算加速度
```

---

## 三、状态维度

### 10. 脉冲数/计数
```
直接读取计数器值

代码体现：CNT 寄存器
          TIM_GetCounter(TIM3)
```

### 11. 距离（超声波）
```
发射脉冲 → 接收回波
测量往返时间 → 计算距离

距离 = (声速 × 时间) / 2

声速 ≈ 340 m/s（20°C空气中）
```

---

## 完整对照表

| 维度 | 测量内容 | 代码体现 | 应用场景 |
|------|---------|---------|---------|
| **频率** | Hz | `IC_GetFreq()` | 信号源频率检测 |
| **脉冲宽度** | 时间 | `CCR2 × 周期` | 脉冲持续时间 |
| **占空比** | % | `CCR2/CCR1×100` | PWM占空比 |
| **周期** | 秒 | `1/f` | 信号完整性 |
| **速度** | 计数/秒 | `Encoder_Get()` | 电机转速 |
| **方向** | 正/负 | `正负返回值` | 旋转方向 |
| **位置** | 累积计数 | `累计CNT` | 电机精确定位 |
| **角度** | 度 | `计数/分辨率` | 机械臂角度 |
| **位移** | mm | `计数/线数` | 直线运动 |
| **加速度** | 计数/s² | `速度差/Δt` | 运动控制 |
| **距离** | mm | `超声波时间` | 测距 |
| **脉冲数** | 计数值 | `CNT` | 流量计 |

---

## CCR 与脉冲宽度的区别

```
CCR 不是脉冲宽度，而是计数器阈值

CCR = 计数器中的一个比较值/计数值（无单位）

脉冲宽度 = CCR × 单个计数的时间
          = CCR × (1 / 定时器频率)
          = CCR × 1μs（当定时器1MHz时）

示例：
  CCR = 1000，定时器频率 = 1MHz
  脉冲宽度 = 1000 × 1μs = 1000μs = 1ms
```

---

## 编码器分辨率（4倍原理）

### 单相编码器
```
只在上升沿计数
转一圈 = 计数 100 次
```

### 双相编码器（TI12 模式）
```
在 A↑、B↑、A↓、B↓ 四个边沿都计数

一个周期：A↑ → B↑ → A↓ → B↓
         ↑    ↑    ↑    ↑
        计数1 计数2 计数3 计数4

转一圈 = 计数 400 次（4倍分辨率）

代码体现：
  TIM_EncoderMode_TI12
```

---

## 记忆口诀

```
时间维度：频率、占空、周期、宽度
运动维度：速度方向、位置位移、加速度
状态维度：脉冲计数、距离测量

CCR是比较值，乘时钟才是时间
TI12模式是四倍，边沿计数更精确
```

---

## 扩展阅读

- STM32 参考手册：定时器章节
- `docs/concepts/04_Timer_Basics.md` - 定时器基础
- `docs/concepts/07_APB_Bus_and_Pin_Mapping.md` - 总线与引脚映射
