# STM32 总线架构与引脚映射

**日期**: 2026-01-06
**状态**: ✅ 完成

---

## 一句话总结

**总线只负责传数据**，定时器到引脚的映射是**内部矩阵连接**（固定映射），不经过总线。

---

## STM32 总线结构

```
           ┌─────────────────────────────────────────────┐
           │              AHB (高速总线)             │
           │   72 MHz                                    │
           └─────────────────────────────────────────────┘
                    │
           ┌──────────┴──────────┐
           │   APB2 (外设总线2)  │   1 MHz (72/72)
           └──────────┬──────────┘
                    │
    ┌───────────────┼───────────────┬───────────────┐
    │               │               │               │
 ┌──┴──┐      ┌──┴──┐       ┌──┴──┐       ┌──┴──┐
 │ TIM1 │      │ TIM2 │       │ TIM3 │       │ TIM4 │
 │ 36MHz│      │ 72MHz│       │ 72MHz│       │ 36MHz│
 └───┬──┘      └───┬──┘       └───┬──┘       └───┬──┘
     │                │               │               │
     │                │               │               │
   APB1           APB1           APB2           APB1
    │                │               │               │
    └────────────────┴───────────────┴───────────────┘
                    │
           ┌───────────┼───────────────┐
           │           │              │
         GPIOA      GPIOB        GPIOC
```

---

## 为什么 TIM3 在 APB1 却能控制 PA6？

**问题**：TIM3 挂在 APB1 上，GPIOA 也挂在 APB2 上，它们不在同一总线，怎么连接的？

**答案**：定时器和引脚是**固定映射**的，通过**内部复用矩阵**连接，不经过总线。

```
定时器控制器 ────────[内部复用矩阵]───────▶ GPIO 引脚
   (APB1)                (固定连接)           (APB2)
```

**类比**：
- 总线 = 高速公路
- 复用矩阵 = 专门的高速连接通道（不走公路，直接走隧道）
- 定时器 → 引脚 = 走高速隧道

---

## APB 总线频率计算

```
┌─────────────────────────────────────────────────────┐
│           AHB = 72 MHz                         │
│    ┌──────────────┴──────────────┐             │
│    │   APB1 预分频器        │             │
│    │   (默认 ×1，可配 ×2)     │             │
│    └──────────────┬──────────────┘             │
│                 ↓  72 MHz                   │
│         ┌───────────────────┐                │
│         │   TIM2, TIM3, TIM4,5,6,7 │                │
│         └───────────────────┘                │
│                 │                            │
│    ┌──────────────┴──────────────┐             │
│    │   APB2 预分频器        │             │
│    │   (默认 ×1，可配 ×1)     │             │
│    └──────────────┬──────────────┘             │
│                 ↓  36 MHz                   │
│         ┌───────────────────┐                │
│         │   TIM1 │                │
│         └───────────────────┘                │
│                                          │
│         ┌───────────────┼───────────────┐       │
│         │               │               │       │
│       GPIOA          GPIOB          GPIOC  │
└─────────────────────────────────────────────────────┘
```

| 总线 | 频率 | 挂载的定时器 |
|------|------|--------------|
| APB1 | 72 MHz (默认) | TIM2, TIM3, TIM4, TIM5, TIM6, TIM7 |
| APB2 | 36 MHz (72÷2) | TIM1 |

**注意**：APB1 的预分频器默认是 ×1，但 RCC 中可以配置为 ×2，此时频率变为 36 MHz。

---

## 定时器通道到引脚的固定映射

定时器到 GPIO 引脚的映射是**硬件固定的**，无法通过软件更改：

| 定时器 | 通道 | 引脚（固定，不可改） |
|--------|------|-------------------|
| TIM1 | CH1 | PA8 |
| TIM2 | CH1/CH2/CH3/CH4 | PA0/PA1/PA2/PA3 |
| **TIM3** | **CH1/CH2/CH3/CH4** | **PA6/PA7/PB0/PB1** |
| TIM4 | CH1/CH2/CH3/CH4 | PA6/PA7/PB8/PB9 |

**关键**：TIM3_CH1 固定映射到 PA6，无论总线是哪个都一样。

---

## 代码中对应关系

```c
// 开启 GPIOA 时钟（APB2 总线）
RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOA, ENABLE);

// 开启 TIM3 时钟（APB1 总线）
RCC_APB1PeriphClockCmd(RCC_APB1Periph_TIM3, ENABLE);

// 配置 PA6 为输入（GPIO 挂 APB2）
GPIO_InitStructure.GPIO_Pin = GPIO_Pin_6;

// 配置 TIM3_CH1 捕获 PA6（定时器挂 APB1，但通过内部矩阵连接）
TIM_ICInitStructure.TIM_Channel = TIM_Channel_1;
```

---

## 6-6 vs 6-7 接线对比

| 对比项 | 6-6（输入捕获） | 6-7（PWMI 模式） |
|--------|-------------------|-------------------|
| **输入引脚** | PA6（1个） | PA6 + PA7（2个） |
| **TIM3 通道** | 只用 CH1 | CH1 + CH2 同时工作 |
| **测量内容** | 只测频率 | 频率 + 占空比 |
| **TIM3 模式** | IC 模式 | PWMI 模式 |
| **OLED 显示** | Freq: 00000Hz | Freq: 00000Hz + Duty: 00% |
| **初始化函数** | `IC_Init()` | `IC_Init()`（PWMI 配置） |

---

## 6-7 硬件连接

```
PWM 输出（来自 TIM2 PA0）：┌───┬───▶ PA6 (TIM3_CH1，PWMI 输入1)
                          │
                          └─▶ PA7 (TIM3_CH2，PWMI 输入2）
```

**注意**：6-6 只需要 PA6 一根线，6-7 需要 PA6 和 PA7 两根线！

---

## 记忆口诀

```
APB1: 72MHz, 挂 TIM2-7
APB2: 36MHz, 挂 TIM1

TIM3_CH1 = PA6 (固定)
TIM2_CH1 = PA0 (固定)

开时钟: TIMx 在 APBx，GPIO 在 APBy
```

---

## 扩展阅读

- STM32 参考手册：RCC 章节（复位和时钟控制）
- STM32 参考手册：GPIO 章节（复用功能）
