# 课程简介

- 程序纯手打，手把手教学  
- STM32最小系统板+面包板硬件平台

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/cc6c37ba6713ffa7d555f6325cf41004522d0513492e611e4b9231c9c878d96d.jpg)

# 硬件设备

- STM32面包板入门套件  
- Windows电脑  
- 万用表、示波器、镊子、剪刀等

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/4b8603b01808c74e7a9c9b20b59225d2fcd98299e38f885b7b3a4ddccb155738.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/db94bb88bcf31b08869f298c6a57a0b4b2b4fe9d40a6d962618dc78501406796.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/99c6dccb597b9a17e9910ce79fc5acf7b92aacc281f1d2a5e9818d63d57fb75b.jpg)

# 软件设备

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/6a79ba98f6e958a9a0d780cd76ca9ea72992b5b844d140b45bd6e1157a5e6c92.jpg)

Keil5 MDK

# 套件介绍

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/99d86a6146664cd694a544bcf7e9bcacdd7ccffc3cc3009de372635bff9bcbd5.jpg)

# STM32简介

• STM32是ST公司基于ARM Cortex-M内核开发的32位微控制器  
- STM32常应用在嵌入式领域，如智能车、无人机、机器人、无线通信、物联网、工业控制、娱乐电子产品等  
- STM32功能强大、性能优异、片上资源丰富、功耗低，是一款经典的嵌入式微控制器

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/16b3883e2c16420a761fa185fac5bbf2604b27fb4416a305a116e76da3fc8f98.jpg)

# STM32 MCUs 32-bit Arm® Cortex®-M

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/f93f687cccb51262d4a7e8b22bef61766f08a2469948b02e764ea106ffc788d0.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/ee03fa5c892fe06ee6349fb35d20c94505bf757c46c0dd39e35bd7826fa68a8d.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/4b47d798773f83bfe783a5cc314f761f7664059f90c33fa677fbe963e17270e9.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/dcfa289e543e1123ab6c17d93e6da99eb6dbe8aff5eecd3b7520753f24461f69.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/77daee8c8e1e272076bf0db20ddea96ddef4ee52b5f3dc79ccaa90dd2ef55826.jpg)

- ARM既指ARM公司，也指ARM处理器内核  
- ARM公司是全球领先的半导体知识产权（IP）提供商，全世界超过  $95\%$  的智能手机和平板电脑都采用ARM架构  
- ARM公司设计ARM内核，半导体厂商完善内核周边电路并生产芯片

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/c15edc7b1d941e9dbf233e366c51a66527b229ad69179017794765f987fe8530.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/2bd5326e1757150e7b9d69469b43426433330fda99eb57380e45d064ca0cdc5d.jpg)

- 系列：主流系列STM32F1  
• 内核：ARM Cortex-M3  
- 主频:  $72 \mathrm{MHz}$  
• RAM: 20K (SRAM)  
- ROM: 64K (Flash)  
供电:  $2.0 \sim 3.6 \mathrm{~V}$  (标准  $3.3 \mathrm{~V}$ )  
封装：LQFP48

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/a42d85d6ccc1d23c902faa59e54e8d7e22e22e648a1a998662cd167678eeb835.jpg)

# 片上资源/外设

<table><tr><td>英文缩写</td><td>名称</td><td>英文缩写</td><td>名称</td></tr><tr><td>NVIC</td><td>嵌套向量中断控制器</td><td>CAN</td><td>CAN通信</td></tr><tr><td>SysTick</td><td>系统滴答定时器</td><td>USB</td><td>USB通信</td></tr><tr><td>RCC</td><td>复位和时钟控制</td><td>RTC</td><td>实时时钟</td></tr><tr><td>GPIO</td><td>通用IO口</td><td>CRC</td><td>CRC校验</td></tr><tr><td>AFIO</td><td>复用IO口</td><td>PWR</td><td>电源控制</td></tr><tr><td>EXTI</td><td>外部中断</td><td>BKP</td><td>备份寄存器</td></tr><tr><td>TIM</td><td>定时器</td><td>IWDG</td><td>独立看门狗</td></tr><tr><td>ADC</td><td>模数转换器</td><td>WWDG</td><td>窗口看门狗</td></tr><tr><td>DMA</td><td>直接内存访问</td><td>DAC</td><td>数模转换器</td></tr><tr><td>USART</td><td>同步/异步串口通信</td><td>SDIO</td><td>SD卡接口</td></tr><tr><td>I2C</td><td>I2C通信</td><td>FSMC</td><td>可变静态存储控制器</td></tr><tr><td>SPI</td><td>SPI通信</td><td>USB OTG</td><td>USB主机接口</td></tr></table>

# 命名规则

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/5f1eaa28ceb7b5f434e3a90a7ad89dddf1d174f61e22be6fbcabbf8af3c4b137.jpg)

# 系统结构

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/9b5e4815e77dcebef280dcbfa573e943fb080f10f4f62bac1e69f3a5d5edf066.jpg)

# 引脚定义

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/d2fbef41b39a2aa100f54bb85bc4ba2bb1909b113c4f824a203014f33f6780de.jpg)

# 启动配置

在STM32F10xxx里，可以通过BOOT[1:0]引脚选择三种不同启动模式。

表6 启动模式  

<table><tr><td colspan="2">启动模式选择引脚</td><td rowspan="2">启动模式</td><td rowspan="2">说明</td></tr><tr><td>BOOT1</td><td>BOOT0</td></tr><tr><td>X</td><td>0</td><td>主闪存存储器</td><td>主闪存存储器被选为启动区域</td></tr><tr><td>0</td><td>1</td><td>系统存储器</td><td>系统存储器被选为启动区域</td></tr><tr><td>1</td><td>1</td><td>内置SRAM</td><td>内置SRAM被选为启动区域</td></tr></table>

在系统复位后，SYSCLK的第4个上升沿，BOOT引脚的值将被锁存。用户可以通过设置BOOT1和BOOT0引脚的状态，来选择在复位后的启动模式。

# 最小系统电路

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/166348a2b6ede97df504bab8f0d87e269b5f267f37e2bdf11e65d214245dceb0.jpg)  
晶振

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/be82b0b62aa388e838b7ff85fa7a736d8d076065a683b79a928708a94e2ad331.jpg)  
复位

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/d4d5c08f5b0015a3945d8811e8e9375c917198ae37b06dec37ccc65fa431833a.jpg)  
启动配置

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/085b5eb232bdabc1968679ebec8c324b93cc8c43a3ccf5e2bab08ecd9d9fdfed.jpg)  
下载端口

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/3d3e0e546114f849ffc6e0ba31f5d2d7084819201a28b8804d6bc5e83621cfa1.jpg)  
STM32及供电

# 软件安装

- 安装Keil5 MDK  
- 安装器件支持包  
- 软件注册  
- 安装STLINK驱动  
- 安装USB转串口驱动

# 型号分类及缩写

<table><tr><td>缩写</td><td>释义</td><td>Flash容量</td><td>型号</td></tr><tr><td>LD_VL</td><td>小容量产品超值系列</td><td>16~32K</td><td>STM32F100</td></tr><tr><td>MD_VL</td><td>中容量产品超值系列</td><td>64~128K</td><td>STM32F100</td></tr><tr><td>HD_VL</td><td>大容量产品超值系列</td><td>256~512K</td><td>STM32F100</td></tr><tr><td>LD</td><td>小容量产品</td><td>16~32K</td><td>STM32F101/102/103</td></tr><tr><td>MD</td><td>中容量产品</td><td>64~128K</td><td>STM32F101/102/103</td></tr><tr><td>HD</td><td>大容量产品</td><td>256~512K</td><td>STM32F101/102/103</td></tr><tr><td>XL</td><td>加大容量产品</td><td>大于512K</td><td>STM32F101/102/103</td></tr><tr><td>CL</td><td>互联型产品</td><td>-</td><td>STM32F105/107</td></tr></table>

# 新建工程步骤

- 建立工程文件夹，Keil中新建工程，选择型号  
- 工程文件夹里建立Start、Library、User等文件夹，复制固件库里面的文件到工程文件夹  
- 工程里对应建立Start、Library、User等同名称的分组，然后将文件夹内的文件添加到工程分组里  
- 工程选项, C/C++, Include Paths内声明所有包含头文件的文件夹  
- 工程选项, C/C++, Define内定义USE_STDPERIPH_DRV  
- 工程选项, Debug, 下拉列表选择对应调试器, Settings, Flash Download里勾选Reset and Run

# 工程架构

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/f26c8d63b5dc25d8e0c0e1464db9cd2043903f0bef0d1e0d9707328737a5b850.jpg)

# GPIO简介

- GPIO (General Purpose Input Output) 通用输入输出口  
- 可配置为8种输入输出模式  
- 引脚电平:  $0 \mathrm{~V} \sim 3.3 \mathrm{~V}$ , 部分引脚可容忍  $5 \mathrm{~V}$  
- 输出模式下可控制端口输出高低电平，用以驱动LED、控制蜂鸣器、模拟通信协议输出时序等  
- 输入模式下可读取端口的高低电平或电压，用于读取按键输入、外接模块电平信号输入、ADC电压采集、模拟通信协议接收数据等

# GPIO基本结构

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/c18b4bf833ab00e59cba50f31fb1d00bc5b432e299b358a9a3b6b570edfc7ba7.jpg)

# GPIO位结构

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/728642bb3a2736456463768c38fefadab1beac92febd2e67278b16766dc35c2f.jpg)  
图13 I/O端口位的基本结构

# GPIO模式

- 通过配置GPIO的端口配置寄存器，端口可以配置成以下8种模式

<table><tr><td>模式名称</td><td>性质</td><td>特征</td></tr><tr><td>浮空输入</td><td>数字输入</td><td>可读取引脚电平，若引脚悬空，则电平不确定</td></tr><tr><td>上拉输入</td><td>数字输入</td><td>可读取引脚电平，内部连接上拉电阻，悬空时默认高电平</td></tr><tr><td>下拉输入</td><td>数字输入</td><td>可读取引脚电平，内部连接下拉电阻，悬空时默认低电平</td></tr><tr><td>模拟输入</td><td>模拟输入</td><td>GPIO无效，引脚直接接入内部ADC</td></tr><tr><td>开漏输出</td><td>数字输出</td><td>可输出引脚电平，高电平为高阻态，低电平接VSS</td></tr><tr><td>推挽输出</td><td>数字输出</td><td>可输出引脚电平，高电平接VDD，低电平接VSS</td></tr><tr><td>复用开漏输出</td><td>数字输出</td><td>由片上外设控制，高电平为高阻态，低电平接VSS</td></tr><tr><td>复用推挽输出</td><td>数字输出</td><td>由片上外设控制，高电平接VDD，低电平接VSS</td></tr></table>

# 浮空/上拉/下拉输入

图15 输入浮空/上拉/下拉配置  
![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/e6c312b40d9235e2bf660079e70707b07871ba88edd68318c75ec032fb32d76c.jpg)  
(1)  $V_{\text{DD\_FT}}$  对5伏容忍I/O脚是特殊的，它与  $V_{\text{DD}}$  不同

# 模拟输入

图18 高阻抗的模拟输入配置  
![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/8f7d8116dfc647a194730d55b86ba25c651b361d22cdfbbf2a4a92af48450c7d.jpg)  
(1)  ${\mathrm{V}}_{\mathrm{{DD}}\_ \mathrm{{FT}}}$  对 5 伏兼容 I/O 脚是特殊的,它与  ${\mathrm{V}}_{\mathrm{{DD}}}$  不同

图16 输出配置  
![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/70a01beeaf7ac3f94b9a2b5c7921693f28d3697a1cde8f34f81ad80e870d547f.jpg)  
(1)  $V_{\text{DD\_FT}}$  对5伏兼容I/O脚是特殊的，它与  $V_{\text{DD}}$  不同

# 复用开漏/推挽输出

图17 复用功能配置  
![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/69afffd995d8a94b5218203f196ed87981fc9a303b4f835efe38ad21a2db3325.jpg)  
(1)  $V_{\text{DD\_FT}}$  对5伏兼容I/O脚是特殊的，它与  $V_{\text{DD}}$  不同

# LED和蜂鸣器简介

- LED: 发光二极管, 正向通电点亮, 反向通电不亮  
- 有源蜂鸣器：内部自带振荡源，将正负极接上直流电压即可持续发声，频率固定  
- 无源蜂鸣器：内部不带振荡源，需要控制器提供振荡脉冲才可发声，调整提供振荡脉冲的频率，可发出不同频率的声音

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/2c2b990f80646f3f593823b1960138d49cdd4819d537afe45733d8fe26cc1386.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/4b753d89d0a1e3a38ce66fc5522f67a5854e1ecc4f54e58e7cbedd4264cc3c10.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/bca52fa2fadce09483f6ba69cb52d062e3b563429c00bafdffd8a8840601393c.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/167d71173bba4a2e4c3fe175a797cbf4ba2ca5a22aad6a35eaf787583cb4134f.jpg)

# 硬件电路

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/bbb6394ce16a4690a85cc0793afbdac1300fe82b6e05ba44963f109b2bb66a7a.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/386a2bdd40c10bf0ff1d242d0579876f996f6e4beaf09799e8fb87e2d4fd825b.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/2c474085646f9a3a94363a4f192a9e123134b8461dbc8c35bd6e9e17e954079b.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/a3fbe3898e8fff5906f680ebe240d7c316a87a5769f1717f1a770008405655bd.jpg)

# 面包板

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/c1567bdcaa211a2f8c321514e4e7540b75769351d6b5e5b440e3ae89f74fa501.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/8f19d71f41a68934c7d94c64146671f8ce38373978bbe252d32feb17d53d2297.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/6882467eabf2fbbfbdb9c93e0be66a2d80afdeadc2a7cc3c206f5024b3d60a60.jpg)

# 按键简介

- 按键：常见的输入设备，按下导通，松手断开  
- 按键抖动：由于按键内部使用的是机械式弹簧片来进行通断的，所以在按下和松手的瞬间会伴随有一连串的抖动

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/b5ffc0329c54985409e9ef55c752d1b091c6629285eabf806395240d8b793ae6.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/d89eeaa4893570b956e4324ed3f20c5c6125c3f10aab59a2a173270f4bea6b27.jpg)

# 传感器模块简介

- 传感器模块：传感器元件（光敏电阻/热敏电阻/红外接收管等）的电阻会随外界模拟量的变化而变化，通过与定值电阻分压即可得到模拟电压输出，再通过电压比较器进行二值化即可得到数字电压输出

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/bafa81fb495b3bf160f05a8528fd56c2aeacff67ccbf2523ae05f24339762b51.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/7b48d47434133d6c49fbaf93998e3c61330c938a71fe739694d164416969398f.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/4bbf1258dc4d88f0d6b10af0e57ecae05987a3f6b0bdc886a8a0915867781ae2.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/e89b39106c4ef583de460d84fa688d3b6cfe875e085f516feac2a2c4f3171863.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/93cf7b703da10e8202c787fca69fc02ad6be93e38e79cda1be79ed07952a887e.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/37f4ddf2cd69447d1d4123184217c6833a4d72ceeb20217ff5e03e5095ffef3e.jpg)

# 硬件电路

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/32e2ec6549dcb400c4d9024ddd3880a19c8f2ba753a275115080813a30cff38c.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/596f6fd7ea5e1118c5a92b4d9713da012121f018f56fddc0926c5365c34215a6.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/59dd9f09bfc9e0dd75e4174313b1cb21201a0e13b8af5d6e98c1705bed3c3e5a.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/9bb637a87076bda6bc4d1eec103190c78af7ceaaa97fca04a4c61e53b53f52a0.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/eb05ec4ebe6a24a30cd93ddc67a4215a48c466fdb69dff518cf7daed7f7b43f3.jpg)

# C语言数据类型

<table><tr><td>关键字</td><td>位数</td><td>表示范围</td><td>stderr关键字</td><td>ST关键字</td></tr><tr><td>char</td><td>8</td><td>-128 ~ 127</td><td>int8_t</td><td>s8</td></tr><tr><td>unsigned char</td><td>8</td><td>0 ~ 255</td><td>uint8_t</td><td>u8</td></tr><tr><td>short</td><td>16</td><td>-32768 ~ 32767</td><td>int16_t</td><td>s16</td></tr><tr><td>unsigned short</td><td>16</td><td>0 ~ 65535</td><td>uint16_t</td><td>u16</td></tr><tr><td>int</td><td>32</td><td>-2147483648 ~ 2147483647</td><td>int32_t</td><td>s32</td></tr><tr><td>unsigned int</td><td>32</td><td>0 ~ 4294967295</td><td>uint32_t</td><td>u32</td></tr><tr><td>long</td><td>32</td><td>-2147483648 ~ 2147483647</td><td></td><td></td></tr><tr><td>unsigned long</td><td>32</td><td>0 ~ 4294967295</td><td></td><td></td></tr><tr><td>long long</td><td>64</td><td>-(2^64)/2 ~ (2^64)/2-1</td><td>int64_t</td><td></td></tr><tr><td>unsigned long long</td><td>64</td><td>0 ~ (2^64)-1</td><td>uint64_t</td><td></td></tr><tr><td>float</td><td>32</td><td>-3.4e38 ~ 3.4e38</td><td></td><td></td></tr><tr><td>double</td><td>64</td><td>-1.7e308 ~ 1.7e308</td><td></td><td></td></tr></table>

# C语言宏定义

- 关键字：#define  
• 用途：用一个字符串代替一个数字，便于理解，防止出错；提取程序中经常出现的参数，便于快速修改  
定义宏定义:

define ABC 12345

• 引用宏定义:

int a = ABC; //等效于int a = 12345;

# C语言 typedef

- 关键字: typedef  
- 用途：将一个比较长的变量类型名换个名字，便于使用  
定义typedef:

typedef unsigned char uint8_t;

- 引用typedef:

uint8_t a; //等效于unsigned char a;

# C语言结构体

• 关键字: struct  
- 用途：数据打包，不同类型变量的集合  
定义结构体变量:

struct{char x; int y; float z;} StructName;

因为结构体变量类型较长，所以通常用typedef更改变量类型名

• 引用结构体成员:

StructName.x = 'A';

StructName.y = 66;

StructName.z = 1.23;

或 pStructName->x = 'A'; //pStructName为结构体的地址

pStructName->y = 66;

pStructName->z = 1.23;

# C语言枚举

- 关键字: enum  
- 用途：定义一个取值受限制的整型变量，用于限制变量取值范围；宏定义的集合  
• 定义枚举变量:

$$
\operatorname {e n u m} \{\text {F A L S E} = 0, \text {T R U E} = 1 \} \text {E n u m N a m e};
$$

因为枚举变量类型较长，所以通常用typedef更改变量类型名

• 引用枚举成员:

$$
\begin{array}{l} \text {E n u m N a m e} = \text {F A L S E}; \\ \mathsf {E n u m N a m e} = \mathsf {T R U E}; \\ \end{array}
$$

# 调试方式

- 串口调试：通过串口通信，将调试信息发送到电脑端，电脑使用串口助手显示调试信息  
- 显示屏调试：直接将显示屏连接到单片机，将调试信息打印在显示屏上  
- Keil调试模式：借助Keil软件的调试模式，可使用单步运行、设置断点、查看寄存器及变量等功能

# OLED简介

OLED (Organic Light Emitting Diode) : 有机发光二极管  
- OLED显示屏：性能优异的新型显示屏，具有功耗低、相应速度快、宽视角、轻薄柔韧等特点  
• 0.96寸OLED模块：小巧玲珑、占用接口少、简单易用，是电子设计中非常常见的显示屏模块  
供电:  $3 \sim 5.5 \mathrm{~V}$ , 通信协议: I2C/SPI, 分辨率:  $128 * 64$

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/b86299823d9884b49badd4a1c2f4893225f4dfc2b4bcb9278ba4dbdfdfa4bc05.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/4ea9506b6d1dc9e9c229b91f4712741bbf130232628f635fb9a6187775cf0793.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/a9ab3b750d0fa3e74374f075b16eb8511ea807413372608fc8b57e5596d31c04.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/a06f24428e5e02d88dffabdd31603eb19041618fd222f617968579d56210557d.jpg)

# 硬件电路

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/ccc70d2707b1305870b5390250b6eb418cc50ad2eb004bf41614c6285a0a1342.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/ade01b08798766f5bf6212eccbead105d163830bc12faf6a4fb7271aeef222ff.jpg)

# OLED驱动函数

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/0041d214a3ad9b0fb443c4313553668b1eaafa487b6ee9e86116416aebd2b9eb.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/3e73e3257c1c4e60ec3691792ee57c288367c8ac2fdca5791784cb61780e0ab0.jpg)

<table><tr><td>函数</td><td>作用</td></tr><tr><td>OLED_Init();</td><td>初始化</td></tr><tr><td>OLED_Clear();</td><td>清屏</td></tr><tr><td>OLEDSHOWChar(1, 1, &#x27;A&#x27;);</td><td>显示一个字符</td></tr><tr><td>OLED-showString(1, 3, &quot;HelloWorld!&quot;)</td><td>显示字符串</td></tr><tr><td>OLED/showNum(2, 1, 12345, 5);</td><td>显示十进制数字</td></tr><tr><td>OLEDshowSignedNum(2, 7, -66, 2);</td><td>显示有符号十进制数字</td></tr><tr><td>OLEDShowHexNum(3, 1, 0xAA55, 4);</td><td>显示十六进制数字</td></tr><tr><td>OLEDShowBinNum(4, 1, 0xAA55, 16);</td><td>显示二进制数字</td></tr></table>

# 中断系统

- 中断：在主程序运行过程中，出现了特定的中断触发条件（中断源），使得CPU暂停当前正在运行的程序，转而去处理中断程序，处理完成后又返回原来被暂停的位置继续运行  
- 中断优先级：当有多个中断源同时申请中断时，CPU会根据中断源的轻重缓急进行裁决，优先响应更加紧急的中断源  
- 中断嵌套：当一个中断程序正在运行时，又有新的更高优先级的中断源申请中断，CPU再次暂停当前中断程序，转而去处理新的中断程序，处理完成后依次进行返回

# 中断执行流程

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/797b4cd4a131a7688f25c87b2cb34d4db7d1acde26e8f1bccd4cd45ed027577b.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/1a1284c2727273ad1a053d773ac2b3bb56e356fe4d7c4a11e5fccf7572cb00aa.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/79403cd1e0c26f5df6afb30be5eb2b8a0c5581863d867a1cb10c53a44bc23493.jpg)

# STM32中断

• 68个可屏蔽中断通道,包含EXTI、TIM、ADC、USART、SPI、I2C、RTC等多个外设  
- 使用NVIC统一管理中断，每个中断通道都拥有16个可编程的优先等级，可对优先级进行分组，进一步设置抢占优先级和响应优先级

表55 其它STM32F10xxx产品(小容量、中容量和大容量)的向量表  

<table><tr><td>位置</td><td>优先级</td><td>优先级类型</td><td>名称</td><td>说明</td><td>地址</td></tr><tr><td></td><td>-</td><td>-</td><td>-</td><td>保留</td><td>0x0000_0000</td></tr><tr><td></td><td>-3</td><td>固定</td><td>Reset</td><td>复位</td><td>0x0000_0004</td></tr><tr><td></td><td>-2</td><td>固定</td><td>NMI</td><td>不可屏蔽中断RCC时钟安全系统(CSS)联接到NMI向量</td><td>0x0000_0008</td></tr><tr><td></td><td>-1</td><td>固定</td><td>硬件失效(HardFault)</td><td>所有类型的失效</td><td>0x0000_000C</td></tr><tr><td></td><td>0</td><td>可设置</td><td>存储管理(MemManage)</td><td>存储器管理</td><td>0x0000_0010</td></tr><tr><td></td><td>1</td><td>可设置</td><td>总线错误(BusFault)</td><td>预取指失败,存储器访问失败</td><td>0x0000_0014</td></tr><tr><td></td><td>2</td><td>可设置</td><td>错误应用(UsageFault)</td><td>未定义的指令或非法状态</td><td>0x0000_0018</td></tr><tr><td></td><td>-</td><td>-</td><td>-</td><td>保留</td><td>0x0000_001C~0x0000_002B</td></tr><tr><td></td><td>3</td><td>可设置</td><td>SVCall</td><td>通过SWI指令的系统服务调用</td><td>0x0000_002C</td></tr><tr><td></td><td>4</td><td>可设置</td><td>调试监控(DebugMonitor)</td><td>调试监控器</td><td>0x0000_0030</td></tr><tr><td></td><td>-</td><td>-</td><td>-</td><td>保留</td><td>0x0000_0034</td></tr><tr><td></td><td>5</td><td>可设置</td><td>PendSV</td><td>可挂起的系统服务</td><td>0x0000_0038</td></tr><tr><td></td><td>6</td><td>可设置</td><td>SysTick</td><td>系统嘀嗒定时器</td><td>0x0000_003C</td></tr><tr><td>0</td><td>7</td><td>可设置</td><td>VWWDG</td><td>窗口定时器中断</td><td>0x0000_0040</td></tr><tr><td>1</td><td>8</td><td>可设置</td><td>PVD</td><td>连到EXTI的电源电压检测(PVD)中断</td><td>0x0000_0044</td></tr><tr><td>2</td><td>9</td><td>可设置</td><td>TAMPER</td><td>侵入检测中断</td><td>0x0000_0048</td></tr><tr><td>3</td><td>10</td><td>可设置</td><td>RTC</td><td>实时时钟(RTC)全局中断</td><td>0x0000_004C</td></tr><tr><td>4</td><td>11</td><td>可设置</td><td>FLASH</td><td>闪存全局中断</td><td>0x0000_0050</td></tr><tr><td>5</td><td>12</td><td>可设置</td><td>RCC</td><td>复位和时钟控制(RCC)中断</td><td>0x0000_0054</td></tr><tr><td>6</td><td>13</td><td>可设置</td><td>EXTI0</td><td>EXTI线0中断</td><td>0x0000_0058</td></tr><tr><td>7</td><td>14</td><td>可设置</td><td>EXTI1</td><td>EXTI线1中断</td><td>0x0000_005C</td></tr><tr><td>8</td><td>15</td><td>可设置</td><td>EXTI2</td><td>EXTI线2中断</td><td>0x0000_0060</td></tr><tr><td>9</td><td>16</td><td>可设置</td><td>EXTI3</td><td>EXTI线3中断</td><td>0x0000_0064</td></tr><tr><td>10</td><td>17</td><td>可设置</td><td>EXTI4</td><td>EXTI线4中断</td><td>0x0000_0068</td></tr><tr><td>11</td><td>18</td><td>可设置</td><td>DMA1通道1</td><td>DMA1通道1全局中断</td><td>0x0000_006C</td></tr><tr><td>12</td><td>19</td><td>可设置</td><td>DMA1通道2</td><td>DMA1通道2全局中断</td><td>0x0000_0070</td></tr><tr><td>13</td><td>20</td><td>可设置</td><td>DMA1通道3</td><td>DMA1通道3全局中断</td><td>0x0000_0074</td></tr><tr><td>14</td><td>21</td><td>可设置</td><td>DMA1通道4</td><td>DMA1通道4全局中断</td><td>0x0000_0078</td></tr><tr><td>15</td><td>22</td><td>可设置</td><td>DMA1通道5</td><td>DMA1通道5全局中断</td><td>0x0000_007C</td></tr><tr><td>16</td><td>23</td><td>可设置</td><td>DMA1通道6</td><td>DMA1通道6全局中断</td><td>0x0000_0080</td></tr><tr><td>17</td><td>24</td><td>可设置</td><td>DMA1通道7</td><td>DMA1通道7全局中断</td><td>0x0000_0084</td></tr><tr><td>18</td><td>25</td><td>可设置</td><td>ADC1_2</td><td>ADC1和ADC2的全局中断</td><td>0x0000_0088</td></tr><tr><td>19</td><td>26</td><td>可设置</td><td>USB_HP_CAN_TX</td><td>USB高优先级或CAN发送中断</td><td>0x0000_008C</td></tr><tr><td>20</td><td>27</td><td>可设置</td><td>USB_LP_CAN_RX0</td><td>USB低优先级或CAN接收0中断</td><td>0x0000_0090</td></tr><tr><td>21</td><td>28</td><td>可设置</td><td>CAN_RX1</td><td>CAN接收1中断</td><td>0x0000_0094</td></tr><tr><td>22</td><td>29</td><td>可设置</td><td>CAN_SCE</td><td>CAN SCE中断</td><td>0x0000_0098</td></tr><tr><td>23</td><td>30</td><td>可设置</td><td>EXTI9_5</td><td>EXTI线[9:5]中断</td><td>0x0000_009C</td></tr><tr><td>24</td><td>31</td><td>可设置</td><td>TIM1_BRK</td><td>TIM1刹车中断</td><td>0x0000_00A0</td></tr><tr><td>25</td><td>32</td><td>可设置</td><td>TIM1_UP</td><td>TIM1更新中断</td><td>0x0000_00A4</td></tr><tr><td>26</td><td>33</td><td>可设置</td><td>TIM1_TRG_COM</td><td>TIM1触发和通信中断</td><td>0x0000_00A8</td></tr><tr><td>27</td><td>34</td><td>可设置</td><td>TIM1_CC</td><td>TIM1捕获比较中断</td><td>0x0000_00AC</td></tr></table>

<table><tr><td>28</td><td>35</td><td>可设置</td><td>TIM2</td><td>TIM2全局中断</td><td>0x0000_00B0</td></tr><tr><td>29</td><td>36</td><td>可设置</td><td>TIM3</td><td>TIM3全局中断</td><td>0x0000_00B4</td></tr><tr><td>30</td><td>37</td><td>可设置</td><td>TIM4</td><td>TIM4全局中断</td><td>0x0000_00B8</td></tr><tr><td>31</td><td>38</td><td>可设置</td><td>I2C1EV</td><td>I²C1事件中断</td><td>0x0000_00BC</td></tr><tr><td>32</td><td>39</td><td>可设置</td><td>I2C1_ER</td><td>I²C1错误中断</td><td>0x0000_00C0</td></tr><tr><td>33</td><td>40</td><td>可设置</td><td>I2C2_ER</td><td>I²C2事件中断</td><td>0x0000_00C4</td></tr><tr><td>34</td><td>41</td><td>可设置</td><td>I2C2_ER</td><td>I²C2错误中断</td><td>0x0000_00C8</td></tr><tr><td>35</td><td>42</td><td>可设置</td><td>SPI1</td><td>SPI1全局中断</td><td>0x0000_00CC</td></tr><tr><td>36</td><td>43</td><td>可设置</td><td>SPI2</td><td>SPI2全局中断</td><td>0x0000_00D0</td></tr><tr><td>37</td><td>44</td><td>可设置</td><td>USART1</td><td>USART1全局中断</td><td>0x0000_00D4</td></tr><tr><td>38</td><td>45</td><td>可设置</td><td>USART2</td><td>USART2全局中断</td><td>0x0000_00D8</td></tr><tr><td>39</td><td>46</td><td>可设置</td><td>USART3</td><td>USART3全局中断</td><td>0x0000_00DC</td></tr><tr><td>40</td><td>47</td><td>可设置</td><td>EXT115_10</td><td>EXT线[15:10]中断</td><td>0x0000_00E0</td></tr><tr><td>41</td><td>48</td><td>可设置</td><td>RTCA Alarm</td><td>连到EXT1的RTC闹钟中断</td><td>0x0000_00E4</td></tr><tr><td>42</td><td>49</td><td>可设置</td><td>USB唤醒</td><td>连到EXT1的从USB待机唤醒中断</td><td>0x0000_00E8</td></tr><tr><td>43</td><td>50</td><td>可设置</td><td>TIM8_BRK</td><td>TIM8刹车中断</td><td>0x0000_00EC</td></tr><tr><td>44</td><td>51</td><td>可设置</td><td>TIM8_UP</td><td>TIM8更新中断</td><td>0x0000_00F0</td></tr><tr><td>45</td><td>52</td><td>可设置</td><td>TIM8_TRG_COM</td><td>TIM8触发和通信中断</td><td>0x0000_00F4</td></tr><tr><td>46</td><td>53</td><td>可设置</td><td>TIM8_CC</td><td>TIM8捕获比较中断</td><td>0x0000_00F8</td></tr><tr><td>47</td><td>54</td><td>可设置</td><td>ADC3</td><td>ADC3全局中断</td><td>0x0000_00FC</td></tr><tr><td>48</td><td>55</td><td>可设置</td><td>FSMC</td><td>FSMC全局中断</td><td>0x0000_0100</td></tr><tr><td>49</td><td>56</td><td>可设置</td><td>SDIO</td><td>SDIO全局中断</td><td>0x0000_0104</td></tr><tr><td>50</td><td>57</td><td>可设置</td><td>TIM5</td><td>TIM5全局中断</td><td>0x0000_0108</td></tr><tr><td>51</td><td>58</td><td>可设置</td><td>SPI3</td><td>SPI3全局中断</td><td>0x0000_010C</td></tr><tr><td>52</td><td>59</td><td>可设置</td><td>UART4</td><td>UART4全局中断</td><td>0x0000_0110</td></tr><tr><td>53</td><td>60</td><td>可设置</td><td>UART5</td><td>UART5全局中断</td><td>0x0000_0114</td></tr><tr><td>54</td><td>61</td><td>可设置</td><td>TIM6</td><td>TIM6全局中断</td><td>0x0000_0118</td></tr><tr><td>55</td><td>62</td><td>可设置</td><td>TIM7</td><td>TIM7全局中断</td><td>0x0000_011C</td></tr><tr><td>56</td><td>63</td><td>可设置</td><td>DMA2通道1</td><td>DMA2通道1全局中断</td><td>0x0000_0120</td></tr><tr><td>57</td><td>64</td><td>可设置</td><td>DMA2通道2</td><td>DMA2通道2全局中断</td><td>0x0000_0124</td></tr><tr><td>58</td><td>65</td><td>可设置</td><td>DMA2通道3</td><td>DMA2通道3全局中断</td><td>0x0000_0128</td></tr><tr><td>59</td><td>66</td><td>可设置</td><td>DMA2通道4_5</td><td>DMA2通道4和DMA2通道5全局中断</td><td>0x0000_012C</td></tr></table>

# NVIC基本结构

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/d7d63e32892ad92f024ae6a86bbe78970e27bef2a4e805d4f80f2f5972e305bc.jpg)

# NVIC优先级分组

- NVIC的中断优先级由优先级寄存器的4位（0~15）决定，这4位可以进行切分，分为高n位的抢占优先级和低4-n位的响应优先级  
- 抢占优先级高的可以中断嵌套，响应优先级高的可以优先排队，抢占优先级和响应优先级均相同的按中断号排队

<table><tr><td>分组方式</td><td>抢占优先级</td><td>响应优先级</td></tr><tr><td>分组0</td><td>0位，取值为0</td><td>4位，取值为0~15</td></tr><tr><td>分组1</td><td>1位，取值为0~1</td><td>3位，取值为0~7</td></tr><tr><td>分组2</td><td>2位，取值为0~3</td><td>2位，取值为0~3</td></tr><tr><td>分组3</td><td>3位，取值为0~7</td><td>1位，取值为0~1</td></tr><tr><td>分组4</td><td>4位，取值为0~15</td><td>0位，取值为0</td></tr></table>

# EXTI简介

-EXTI (External Interrupt) 外部中断  
- EXTI可以监测指定GPIO口的电平信号，当其指定的GPIO口产生电平变化时，EXTI将立即向NVIC发出中断申请，经过NVIC裁决后即可中断CPU主程序，使CPU执行EXTI对应的中断程序  
- 支持的触发方式：上升沿/下降沿/双边沿/软件触发  
- 支持的GPIO口：所有GPIO口，但相同的Pin不能同时触发中断  
• 通道数：16个GPIO_Pin，外加PVD输出、RTC闹钟、USB唤醒、以太网唤醒  
- 触发响应方式：中断响应/事件响应

# EXTI基本结构

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/b610a6039f83a415e1adcb4a4fbd7d6b7889a4484a07988b7f9e015207c2d710.jpg)

# AFIO复用IO口

- AFIO主要用于引脚复用功能的选择和重定义  
• 在STM32中，AFIO主要完成两个任务：复用功能引脚重映射、中断引脚选择

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/87dc01144e5ecf3a4498b813506e3555580b305ba70c0f04dadfff40273b4549.jpg)  
图20 外部中断通用I/O映像

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/cfa84c54d9bbbff373ce7c41c1a5d96f7629f9e2317eff739f80a7f9884887bf.jpg)  
图19 外部中断/事件控制器框图

# 旋转编码器简介

- 旋转编码器：用来测量位置、速度或旋转方向的装置，当其旋转轴旋转时，其输出端可以输出与旋转速度和方向对应的方波信号，读取方波信号的频率和相位信息即可得知旋转轴的速度和方向  
- 类型：机械触点式/霍尔传感器式/光栅式

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/e4ac39e7b38e2ab69cb53cf2590c6d2a6ef378b0bacfca5906a70978891bb191.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/99e5953ec6151be37cccbd1da79195b3bc023353ee557e10b9bed139a6abf4d8.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/bf5603ac29e377b1aaaf8c5d968fee7325f658bb3eabac2bac970882f90bd9f6.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/8232678458d2fe46ad3f66160dd35c0daff87608239b0dfb769a61193891d1e6.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/d22f9ee3b4e85f06d3bc451246857b2cf61cedc91ea77908c424c9e949439e88.jpg)

# 硬件电路

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/681c15e6724c0d6ad61b481555ff64c8ce946d4554b0c91a34374bae97375857.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/bd53aff729e383fca58698e096f482b929cb57640556e6dad2c99fae2484c92d.jpg)

# TIM简介

- TIM (Timer) 定时器  
• 定时器可以对输入的时钟进行计数，并在计数值达到设定值时触发中断  
• 16位计数器、预分频器、自动重装寄存器的时基单元，在72MHz计数时钟下可以实现最大59.65s的定时  
- 不仅具备基本的定时中断功能，而且还包含内外时钟源选择、输入捕获、输出比较、编码器接口、主从触发模式等多种功能  
- 根据复杂度和应用场景分为了高级定时器、通用定时器、基本定时器三种类型

# 定时器类型

<table><tr><td>类型</td><td>编号</td><td>总线</td><td>功能</td></tr><tr><td>高级定时器</td><td>TIM1、TIM8</td><td>APB2</td><td>拥有通用定时器全部功能，并额外具有重复计数器、死区生成、互补输出、刹车输入等功能</td></tr><tr><td>通用定时器</td><td>TIM2、TIM3、TIM4、TIM5</td><td>APB1</td><td>拥有基本定时器全部功能，并额外具有内外时钟源选择、输入捕获、输出比较、编码器接口、主从触发模式等功能</td></tr><tr><td>基本定时器</td><td>TIM6、TIM7</td><td>APB1</td><td>拥有定时中断、主模式触发DAC的功能</td></tr></table>

- STM32F103C8T6定时器资源：TIM1、TIM2、TIM3、TIM4

# 高级定时器

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/2fe37db5c889b424bbf226d07981c41a18ae0933905122f3b1c13554bda2dca0.jpg)  
图50 高级控制定时器框图

# 通用定时器

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/c5fdf93b6dd485540d51c3584ad729e0c4162522338d6f95d5305d7d5c2938a1.jpg)  
图98 通用定时器框图

# 基本定时器

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/6ef1d18c15ca1c494d6facdbf0b5912ee7f00410de8224d84361f8f8b18ea5d7.jpg)  
图144 基本定时器框图

# 定时中断基本结构

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/79038deade09555173e11697eda62fd5fb23f73bf7c90d219f70be4eb752218d.jpg)

# 预分频器时序

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/96b7e5139b6244567920488695abc636456d663eab6861baf7b083830dc80eee.jpg)  
图99 当预分频器的参数从1变到2时，计数器的时序图

- 计数器计数频率: CK_CNT = CK_PSC / (PSC + 1)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/3eaa7dee2a7644fcc58e3a6dd45e228df153cfd4b3385bf5ba56cba411b917ee.jpg)  
图102 计数器时序图，内部时钟分频因子为2

- 计数器溢出频率: CK_CNT_OV = CK_CNT / (ARR + 1)

$$
= C K _ {P S C} / (P S C + 1) / (A R R + 1)
$$

# 计数器无预装时序

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/4bf6dcc07d823e5b9ddcdd96e0e5e728a922606c25aa756943550504f33551c6.jpg)  
图105 计数器时序图，当ARPE=0时的更新事件(TIMx_ERR没有预装入)

# 计数器有预装时序

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/7c90976f3f0a896afdc0f7b0f6294795971563c6d9e1a10b050bcae1478dfb96.jpg)  
图106 计数器时序图，当ARPE=1时的更新事件(预装入了TIMx_ERR)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/5f4d7d8e258951c3b1f98e840b9d7007a47f408ce76cc82ee7056d530c2723fd.jpg)  
图8 时钟树

# 输出比较简介

• OC (Output Compare) 输出比较  
- 输出比较可以通过比较CNT与CCR寄存器值的关系，来对输出电平进行置1、置0或翻转的操作，用于输出一定频率和占空比的PWM波形  
- 每个高级定时器和通用定时器都拥有4个输出比较通道  
- 高级定时器的前3个通道额外拥有死区生成和互补输出的功能

# PWM简介

- PWM（Pulse Width Modulation）脉冲宽度调制  
- 在具有惯性的系统中，可以通过对一系列脉冲的宽度进行调制，来等效地获得所需要的模拟参量，常应用于电机控速等领域  
- PWM参数:

频率  $= 1 / T_{\mathrm{S}}$  占空比  $= T_{\mathrm{ON}} / T_{\mathrm{S}}$  分辨率 = 占空比变化步距

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/c7866295429ebe75838775900bb322ff86609567bc44a9d4873521f587c0ac2f.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/b03c8b6125562d0af69f7064c47bf54b9de790969763fbdb313657e48c4ad2dd.jpg)

# 输出比较通道(高级)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/f60420686f132fc7fcd0d09b5edbf8e103eb970a03b70aea67c1254094358e7e.jpg)  
图78 捕获/比较通道的输出部分(通道1至3)

# 输出比较通道(通用)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/6a981efac9234487b8529b61ccad0ff3ed8a699b294b97850a6a75f1ab8eecea.jpg)  
图125 捕获/比较通道的输出部分(通道1)

# 输出比较模式

<table><tr><td>模式</td><td>描述</td></tr><tr><td>冻结</td><td>CNT=CCR时, REF保持为原状态</td></tr><tr><td>匹配时置有效电平</td><td>CNT=CCR时, REF置有效电平</td></tr><tr><td>匹配时置无效电平</td><td>CNT=CCR时, REF置无效电平</td></tr><tr><td>匹配时电平翻转</td><td>CNT=CCR时, REF电平翻转</td></tr><tr><td>强制为无效电平</td><td>CNT与CCR无效, REF强制为无效电平</td></tr><tr><td>强制为有效电平</td><td>CNT与CCR无效, REF强制为有效电平</td></tr><tr><td>PWM模式1</td><td>向上计数: CNT&lt;CCR时, REF置有效电平, CNT≥CCR时, REF置无效电平
向下计数: CNT&gt;CCR时, REF置无效电平, CNT≤CCR时, REF置有效电平</td></tr><tr><td>PWM模式2</td><td>向上计数: CNT&lt;CCR时, REF置无效电平, CNT≥CCR时, REF置有效电平
向下计数: CNT&gt;CCR时, REF置有效电平, CNT≤CCR时, REF置无效电平</td></tr></table>

# PWM基本结构

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/3dac6933a8b35d1e039e0e47326a1f1bdbdb35b319950a25f658a10f79c72bdf.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/bb6c798385a813e5929b9013dd50e892bd535e53235e93c69ae400edbe021841.jpg)

CNT<CCR时，REF置有效电平  
CNT≥CCR时，REF置无效电平

REF

极性选择输出使能

GPIO

# 参数计算

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/187f88361eddf96d395713b5cfb18b82edb688b079249dd1562481201803dbc0.jpg)

• PWM频率:  $\mathrm{Freq} = \mathrm{CK\_PSC} / (\mathrm{PSC} + 1) / (\mathrm{ARR} + 1)$  
- PWM占空比: Duty = CCR / (ARR + 1)  
• PWM分辨率: Reso = 1 / (ARR + 1)

# 舵机简介

- 舱机是一种根据输入PWM信号占空比来控制输出角度的装置  
- 输入PWM信号要求：周期为  $20 \mathrm{~ms}$ , 高电平宽度为  $0.5 \mathrm{~ms} \sim 2.5 \mathrm{~ms}$

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/8e84c819b1867a95f163573f3152b5db1ad0d40151be907be56e415fa7cd762c.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/799cc705878ac48ef880d7a0ed98cdc39718653ca144fa57a786522d54ef42af.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/b87813b82bbe41c0c159b734485cbe306bee1a6396233812e013b8162d4baaab.jpg)

# 硬件电路

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/8848fac11ee05e652680202d9f5bd8d179fbb856d597436da2e15ea351f76c02.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/a2c207ca49ada8cde278abaae9955055812ff8b5100c6bbfcfc36a39ac09cc6c.jpg)

# 直流电机及驱动简介

- 直流电机是一种将电能转换为机械能的装置，有两个电极，当电极正接时，电机正转，当电极反接时，电机反转  
- 直流电机属于大功率器件，GPIO口无法直接驱动，需要配合电机驱动电路来操作  
- TB6612是一款双路H桥型的直流电机驱动芯片，可以驱动两个直流电机并且控制其转速和方向

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/511a8a484246e6847259e3946db3452f1f009de025bc38eeea32d5fcb82f942b.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/796b52d7b1e92b6a56381186862a287f21ec5b18ac2fdb6ed22bddd3075bf347.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/1254fb4a0ce2852565793e4e05b9e8b85076265c72fd68660724eeac870bdd66.jpg)

# 硬件电路

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/ae0eed88fb06468a85690c9f9a8482fb4a5bcd0603863279b90cc4397811269c.jpg)

<table><tr><td></td><td>引脚</td><td>定义</td></tr><tr><td rowspan="4"></td><td>VM</td><td>驱动电压输入端(4.5-10V)</td></tr><tr><td>VCC</td><td>逻辑电平输入端(2.7-5.5V)</td></tr><tr><td>GND</td><td>电源地端</td></tr><tr><td>STBY</td><td>正常工作/待机状态控制输入端</td></tr><tr><td rowspan="5">1路电机</td><td>PWMA</td><td>PWM信号输入端</td></tr><tr><td>AIN1</td><td rowspan="2">电机控制模式输入端</td></tr><tr><td>AIN2</td></tr><tr><td>A01</td><td rowspan="2">电机驱动输出端</td></tr><tr><td>A02</td></tr><tr><td rowspan="5">2路电机</td><td>PWMB</td><td>PWM信号输入端</td></tr><tr><td>BIN1</td><td rowspan="2">电机控制模式输入端</td></tr><tr><td>BIN2</td></tr><tr><td>B01</td><td rowspan="2">电机驱动输出端</td></tr><tr><td>B02</td></tr></table>

<table><tr><td colspan="4">输入</td><td colspan="3">输出</td></tr><tr><td>IN1</td><td>IN2</td><td>PWM</td><td>STBY</td><td>01</td><td>02</td><td>模式状态</td></tr><tr><td>H</td><td>H</td><td>H/L</td><td>H</td><td>L</td><td>L</td><td>制动</td></tr><tr><td>L</td><td>H</td><td>H</td><td>H</td><td>L</td><td>H</td><td>反转</td></tr><tr><td>L</td><td>H</td><td>L</td><td>H</td><td>L</td><td>L</td><td>制动</td></tr><tr><td>H</td><td>L</td><td>H</td><td>H</td><td>H</td><td>L</td><td>正转</td></tr><tr><td>H</td><td>L</td><td>L</td><td>H</td><td>L</td><td>L</td><td>制动</td></tr><tr><td>L</td><td>L</td><td>H</td><td>H</td><td colspan="2">OFF</td><td>停止</td></tr><tr><td>H/L</td><td>H/L</td><td>H/L</td><td>L</td><td colspan="2">OFF</td><td>待机</td></tr></table>

# 输入捕获简介

- IC (Input Capture) 输入捕获  
- 输入捕获模式下，当通道输入引脚出现指定电平跳变时，当前CNT的值将被锁存到CCR中，可用于测量PWM波形的频率、占空比、脉冲间隔、电平持续时间等参数  
- 每个高级定时器和通用定时器都拥有4个输入捕获通道  
- 可配置为PWM1模式，同时测量频率和占空比  
- 可配合主从触发模式，实现硬件全自动测量

# 频率测量

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/58d5efc05091f069ed1cf75ab69837ea513560c2243ebfa5cb15937a5b03008e.jpg)

- 测频法：在闸门时间T内，对上升沿计次，得到N，则频率

$$
f _ {x} = N / T
$$

- 测周法：两个上升沿内，以标准频率  $f_{c}$  计次，得到  $N$  ，则频率

$$
f _ {x} = f _ {c} / N
$$

- 中界频率：测频法与测周法误差相等的频率点

$$
f _ {m} = \sqrt {f _ {c} / T}
$$

# 输入捕获通道

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/76e81582c042395de0c43c89d7e6d479689b13c5b06eba3dade994d2533279fb.jpg)  
图123 捕获/比较通道(如：通道1输入部分)

# 主从触发模式

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/618f1a053986a3c36e10c1fe576522565c90ce2d2647bb33260932101930ded2.jpg)  
主模式

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/f30dc1736df9d1aab2c3745a58d55a8453e28bc59f9b79d24d567625be144b99.jpg)  
触发源选择  
从模式

# 输入捕获基本结构

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/accaddf7d6c8415f9ad296b8c02022230b537ede47dfbe6840543309ed2549cb.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/3c2eca7f75648aa68f95555ea9ceb8bab8632db06c7358290709e2ea35b42906.jpg)

# PWMI基本结构

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/8ddd6d98e363e0a5f6de9e3a34fa86f749bfed330a82efa692f1499d7bada4e2.jpg)  
CCR2 = CNT  
CCR2 = CNT

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/ddce97484c84102c03548b0112ef85892493a6199916392a83a9bb20d7851a64.jpg)

从模式 Reset

触发源选择

时基单元

PSC预分频器

ARR自动重装器

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/84f97d6febd57aec91d7da26af750e13406f72fa6ccab6a7d866737a2a6ae71e.jpg)

CNT 计数器

# 编码器接口简介

Encoder Interface 编码器接口  
- 编码器接口可接收增量（正交）编码器的信号，根据编码器旋转产生的正交信号脉冲，自动控制CNT自增或自减，从而指示编码器的位置、旋转方向和旋转速度  
- 每个高级定时器和通用定时器都拥有1个编码器接口  
- 两个输入引脚借用了输入捕获的通道1和通道2

# 正交编码器

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/26bf1ad90afd01f7a8e63be3c15c62e6d560c57909247363644db25e27038c0a.jpg)

<table><tr><td>边沿</td><td>另一相状态</td></tr><tr><td>A相↑</td><td>B相低电平</td></tr><tr><td>A相↓</td><td>B相高电平</td></tr><tr><td>B相↑</td><td>A相高电平</td></tr><tr><td>B相↓</td><td>A相低电平</td></tr></table>

反转

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/cd86c620de7b5e41144cabda7bb7021fa9bded83e2b176deda61e844ec62fbd4.jpg)

<table><tr><td>边沿</td><td>另一相状态</td></tr><tr><td>A相↑</td><td>B相高电平</td></tr><tr><td>A相↓</td><td>B相低电平</td></tr><tr><td>B相↑</td><td>A相低电平</td></tr><tr><td>B相↓</td><td>A相高电平</td></tr></table>

# 编码器接口基本结构

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/65008f0a65b1d499c95099f984c3884597501364821aa4354b0dc599f2e1f22f.jpg)

# 工作模式

表77 计数方向与编码器信号的关系  

<table><tr><td rowspan="2">有效边沿</td><td rowspan="2">相对信号的电平(TI1FP1对应TI2, TI2FP2对应TI1)</td><td colspan="2">TI1FP1信号</td><td colspan="2">TI2FP2信号</td></tr><tr><td>上升</td><td>下降</td><td>上升</td><td>下降</td></tr><tr><td rowspan="2">仅在TI1计数</td><td>高</td><td>向下计数</td><td>向上计数</td><td>不计数</td><td>不计数</td></tr><tr><td>低</td><td>向上计数</td><td>向下计数</td><td>不计数</td><td>不计数</td></tr><tr><td rowspan="2">仅在TI2计数</td><td>高</td><td>不计数</td><td>不计数</td><td>向上计数</td><td>向下计数</td></tr><tr><td>低</td><td>不计数</td><td>不计数</td><td>向下计数</td><td>向上计数</td></tr><tr><td rowspan="2">在TI1和TI2上计数</td><td>高</td><td>向下计数</td><td>向上计数</td><td>向上计数</td><td>向下计数</td></tr><tr><td>低</td><td>向上计数</td><td>向下计数</td><td>向下计数</td><td>向上计数</td></tr></table>

# 实例（均不反相）

<table><tr><td rowspan="2">有效边沿</td><td rowspan="2">相对信号的电平(TI1FP1对应TI2, TI2FP2对应TI1)</td><td colspan="2">TI1FP1信号</td><td colspan="2">TI2FP2信号</td></tr><tr><td>上升</td><td>下降</td><td>上升</td><td>下降</td></tr><tr><td rowspan="2">在TI1和TI2上计数</td><td>高</td><td>向下计数</td><td>向上计数</td><td>向上计数</td><td>向下计数</td></tr><tr><td>低</td><td>向上计数</td><td>向下计数</td><td>向下计数</td><td>向上计数</td></tr></table>

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/da8bf92722dd1822cbccce3b68edbf5bac087fae0fd3db4b5184c81430fd92c2.jpg)  
图132 编码器模式下的计数器操作实例

# 实例 (TI1反相)

<table><tr><td rowspan="2">有效边沿</td><td rowspan="2">相对信号的电平(TI1FP1对应TI2, TI2FP2对应TI1)</td><td colspan="2">TI1FP1信号</td><td colspan="2">TI2FP2信号</td></tr><tr><td>上升</td><td>下降</td><td>上升</td><td>下降</td></tr><tr><td rowspan="2">在TI1和TI2上计数</td><td>高</td><td>向下计数</td><td>向上计数</td><td>向上计数</td><td>向下计数</td></tr><tr><td>低</td><td>向上计数</td><td>向下计数</td><td>向下计数</td><td>向上计数</td></tr></table>

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/9b8e2a1e92ab23f3d7ba648610c66272bf9cf684dfcc19aba8575f5b26d5933b.jpg)  
图133 IC1FP1反相的编码器接口模式实例

# ADC简介

- ADC (Analog-Digital Converter) 模拟-数字转换器  
- ADC可以将引脚上连续变化的模拟电压转换为内存中存储的数字变量，建立模拟电路到数字电路的桥梁  
12位逐次逼近型ADC, 1us转换时间  
- 输入电压范围:  $0 \sim 3.3 \mathrm{~V}$ , 转换结果范围:  $0 \sim 4095$  
18个输入通道，可测量16个外部和2个内部信号源  
- 规则组和注入组两个转换单元  
- 模拟看门狗自动监测输入电压范围  
- STM32F103C8T6 ADC资源：ADC1、ADC2，10个外部输入通道

# 逐次逼近型ADC

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/06f241ec411147a9675e7fcd64496ddd1448cee26ae5d568823c92fe189b832c.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/217b26572079360b4ae2b63bb4962b991ca03e746e4f4a4e294a2183a6493190.jpg)  
图24 单个ADC框图

# ADC基本结构

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/5b66c90b4c7bde2382ed5913cacd29b259dc615f89638033d11aafab220aa598.jpg)

# 输入通道

<table><tr><td>通道</td><td>ADC1</td><td>ADC2</td><td>ADC3</td></tr><tr><td>通道0</td><td>PA0</td><td>PA0</td><td>PA0</td></tr><tr><td>通道1</td><td>PA1</td><td>PA1</td><td>PA1</td></tr><tr><td>通道2</td><td>PA2</td><td>PA2</td><td>PA2</td></tr><tr><td>通道3</td><td>PA3</td><td>PA3</td><td>PA3</td></tr><tr><td>通道4</td><td>PA4</td><td>PA4</td><td>PF6</td></tr><tr><td>通道5</td><td>PA5</td><td>PA5</td><td>PF7</td></tr><tr><td>通道6</td><td>PA6</td><td>PA6</td><td>PF8</td></tr><tr><td>通道7</td><td>PA7</td><td>PA7</td><td>PF9</td></tr><tr><td>通道8</td><td>PB0</td><td>PB0</td><td>PF10</td></tr><tr><td>通道9</td><td>PB1</td><td>PB1</td><td></td></tr><tr><td>通道10</td><td>PC0</td><td>PC0</td><td>PC0</td></tr><tr><td>通道11</td><td>PC1</td><td>PC1</td><td>PC1</td></tr><tr><td>通道12</td><td>PC2</td><td>PC2</td><td>PC2</td></tr><tr><td>通道13</td><td>PC3</td><td>PC3</td><td>PC3</td></tr><tr><td>通道14</td><td>PC4</td><td>PC4</td><td></td></tr><tr><td>通道15</td><td>PC5</td><td>PC5</td><td></td></tr><tr><td>通道16</td><td>温度传感器</td><td></td><td></td></tr><tr><td>通道17</td><td>内部参考电压</td><td></td><td></td></tr></table>

# 转换模式

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/25347657e2c27ac0988342d0de791d6d42e1a69b67ba677a84d0c4e935f9645e.jpg)  
- 单次转换，非扫描模式

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/e077f48ba04daaf890160269e02bf9bb8e3bfc19ac4e2815a51663fc11d42c4c.jpg)

# 转换模式

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/55867b719af268f83dd16f5f63158fd874a9b6d708796ed9e498280ea2669320.jpg)  
- 连续转换，非扫描模式

# 转换模式

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/1871fc3dd0154c39de01c27f194be491f6817c511a08de6f1c15e511da779bb5.jpg)  
- 单次转换，扫描模式

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/9c6cc3f28a40d7ee3d2994b0488c63aad548c38a4f25839ae284ad0dc0c89f91.jpg)

# 转换模式

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/73dab40ea62be0d956f295289701506c6e6ff79acc361b48810250aece4f05dd.jpg)  
- 连续转换，扫描模式

# 触发控制

表64 ADC1和ADC2用于规则通道的外部触发  

<table><tr><td>触发源</td><td>类型</td><td>EXTSEL[2:0]</td></tr><tr><td>TIM1_CC1事件</td><td rowspan="6">来自片上定时器的内部信号</td><td>000</td></tr><tr><td>TIM1_CC2事件</td><td>001</td></tr><tr><td>TIM1_CC3事件</td><td>010</td></tr><tr><td>TIM2_CC2事件</td><td>011</td></tr><tr><td>TIM3_TRGO事件</td><td>100</td></tr><tr><td>TIM4_CC4事件</td><td>101</td></tr><tr><td>EXTI线11/TIM8_TRGO事件(1)(2)</td><td>外部引脚/来自片上定时器的内部信号</td><td>110</td></tr><tr><td>SWSTART</td><td>软件控制位</td><td>111</td></tr></table>

# 数据对齐

- 数据右对齐:

规则组  

<table><tr><td>0</td><td>0</td><td>0</td><td>0</td><td>D11</td><td>D10</td><td>D9</td><td>D8</td><td>D7</td><td>D6</td><td>D5</td><td>D4</td><td>D3</td><td>D2</td><td>D1</td><td>D0</td></tr></table>

- 数据左对齐:

规则组  

<table><tr><td>D11</td><td>D10</td><td>D9</td><td>D8</td><td>D7</td><td>D6</td><td>D5</td><td>D4</td><td>D3</td><td>D2</td><td>D1</td><td>D0</td><td>0</td><td>0</td><td>0</td><td>0</td></tr></table>

# 转换时间

- AD转换的步骤：采样，保持，量化，编码  
• STM32 ADC的总转换时间为:  $T_{\text {CONV}} =$  采样时间 + 12.5个ADC周期  
例如：当ADCCLK=14MHz，采样时间为1.5个ADC周期  $T_{\text{CONV}} = 1.5 + 12.5 = 14$  个ADC周期  $= 1 \mu \text{s}$

# 校准

- ADC有一个内置自校准模式。校准可大幅减小因内部电容器组的变化而造成的准精度误差。校准期间，在每个电容器上都会计算出一个误差修正码(数字值)，这个码用于消除在随后的转换中每个电容器上产生的误差  
- 建议在每次上电后执行一次校准  
- 启动校准前，ADC必须处于关电状态超过至少两个ADC时钟周期

# 硬件电路

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/d7569414d1e5787441a750d44aaf5e528fed376cd91bc77abed0fc7ae9dbbd26.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/2ca6fecf37cd9038c32cc92233a9bb2583e8f09168019e96007650544fe17094.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/14353c35d84d699e30e96cd0f6d33258290d2223b6a517fa446fd1d319f9eb5c.jpg)

# DMA简介

DMA（DirectMemoryAccess）直接存储器存取  
- DMA可以提供外设和存储器或者存储器和存储器之间的高速数据传输，无须CPU干预，节省了CPU的资源  
• 12个独立可配置的通道：DMA1（7个通道），DMA2（5个通道）  
- 每个通道都支持软件触发和特定的硬件触发  
• STM32F103C8T6 DMA资源: DMA1 (7个通道)

# 存储器映像

<table><tr><td>类型</td><td>起始地址</td><td>存储器</td><td>用途</td></tr><tr><td rowspan="3">ROM</td><td>0x0800 0000</td><td>程序存储器Flash</td><td>存储C语言编译后的程序代码</td></tr><tr><td>0x1FFF F000</td><td>系统存储器</td><td>存储BootLoader,用于串口下载</td></tr><tr><td>0x1FFF F800</td><td>选项字节</td><td>存储一些独立于程序代码的配置参数</td></tr><tr><td rowspan="3">RAM</td><td>0x2000 0000</td><td>运行内存SRAM</td><td>存储运行过程中的临时变量</td></tr><tr><td>0x4000 0000</td><td>外设寄存器</td><td>存储各个外设的配置参数</td></tr><tr><td>0xE000 0000</td><td>内核外设寄存器</td><td>存储内核各个外设的配置参数</td></tr></table>

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/4d31866e934aef104de7417e497ed0de273928ea46d29c5fe04bf6eff7637d78.jpg)  
图21 DMA框图

# DMA基本结构

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/55fc753926e935649073148771dab7d36e5ab9bca797393cb81319d1c495081b.jpg)

# DMA请求

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/832ef04854d5bc3805fd74a769241d20908804799e0c23ca20f0e7337772d7b5.jpg)  
图22 DMA1请求映像

# 数据宽度与对齐

表57 可编程的数据传输宽度和大小端操作(当PINC = MINC = 1)  

<table><tr><td>源端宽度</td><td>目标宽度</td><td>传输数目</td><td>源:地址/数据</td><td>传输操作</td><td>目标:地址/数据</td></tr><tr><td rowspan="4">8</td><td rowspan="4">8</td><td rowspan="4">4</td><td>0x0/B0</td><td>1:在0x0读B0[7:0],在0x0写B0[7:0]</td><td>0x0/B0</td></tr><tr><td>0x1/B1</td><td>2:在0x1读B1[7:0],在0x1写B1[7:0]</td><td>0x1/B1</td></tr><tr><td>0x2/B2</td><td>3:在0x2读B2[7:0],在0x2写B2[7:0]</td><td>0x2/B2</td></tr><tr><td>0x3/B3</td><td>4:在0x3读B3[7:0],在0x3写B3[7:0]</td><td>0x3/B3</td></tr><tr><td rowspan="4">8</td><td rowspan="4">16</td><td rowspan="4">4</td><td>0x0/B0</td><td>1:在0x0读B0[7:0],在0x0写00B[15:0]</td><td>0x0/00B0</td></tr><tr><td>0x1/B1</td><td>2:在0x1读B1[7:0],在0x2写00B[15:0]</td><td>0x2/00B1</td></tr><tr><td>0x2/B2</td><td>3:在0x2读B2[7:0],在0x4写00B[15:0]</td><td>0x4/00B2</td></tr><tr><td>0x3/B3</td><td>4:在0x3读B3[7:0],在0x6写00B[15:0]</td><td>0x6/00B3</td></tr><tr><td rowspan="4">8</td><td rowspan="4">32</td><td rowspan="4">4</td><td>0x0/B0</td><td>1:在0x0读B0[7:0],在0x0写00000B[31:0]</td><td>0x0/00000B</td></tr><tr><td>0x1/B1</td><td>2:在0x1读B1[7:0],在0x4写00000B[131:0]</td><td>0x4/00000B1</td></tr><tr><td>0x2/B2</td><td>3:在0x2读B2[7:0],在0x8写00000B2[31:0]</td><td>0x8/00000B2</td></tr><tr><td>0x3/B3</td><td>4:在0x3读B3[7:0],在0xC写00000B3[31:0]</td><td>0xC/00000B3</td></tr><tr><td rowspan="4">16</td><td rowspan="4">8</td><td rowspan="4">4</td><td>0x0/B1B0</td><td>1:在0x0读B1B0[15:0],在0x0写B0[7:0]</td><td>0x0/B0</td></tr><tr><td>0x2/B3B2</td><td>2:在0x2读B3B2[15:0],在0x1写B2[7:0]</td><td>0x1/B2</td></tr><tr><td>0x4/B5B4</td><td>3:在0x4读B5B4[15:0],在0x2写B4[7:0]</td><td>0x2/B4</td></tr><tr><td>0x6/B7B6</td><td>4:在0x6读B7B6[15:0],在0x3写B6[7:0]</td><td>0x3/B6</td></tr><tr><td rowspan="4">16</td><td rowspan="4">16</td><td rowspan="4">4</td><td>0x0/B1B0</td><td>1:在0x0读B1B0[15:0],在0x0写B1B0[15:0]</td><td>0x0/B1B0</td></tr><tr><td>0x2/B3B2</td><td>2:在0x2读B3B2[15:0],在0x2写B3B2[15:0]</td><td>0x2/B3B2</td></tr><tr><td>0x4/B5B4</td><td>3:在0x4读B5B4[15:0],在0x4写B5B4[15:0]</td><td>0x4/B5B4</td></tr><tr><td>0x6/B7B6</td><td>4:在0x6读B7B6[15:0],在0x6写B7B6[15:0]</td><td>0x6/B7B6</td></tr><tr><td rowspan="4">16</td><td rowspan="4">32</td><td rowspan="4">4</td><td>0x0/B1B0</td><td>1:在0x0读B1B0[15:0],在0x0写0000B1B0[31:0]</td><td>0x0/0000B1B0</td></tr><tr><td>0x2/B3B2</td><td>2:在0x2读B3B2[15:0],在0x4写0000B3B2[31:0]</td><td>0x4/0000B3B2</td></tr><tr><td>0x4/B5B4</td><td>3:在0x4读B5B4[15:0],在0x8写0000B5B4[31:0]</td><td>0x8/0000B5B4</td></tr><tr><td>0x6/B7B6</td><td>4:在0x6读B7B6[15:0],在0xC写0000B7B6[31:0]</td><td>0xC/0000B7B6</td></tr><tr><td rowspan="4">32</td><td rowspan="4">8</td><td rowspan="4">4</td><td>0x0/B3B2B1B0</td><td>1:在0x0读B3B2B1B0[31:0],在0x0写B0[7:0]</td><td>0x0/B0</td></tr><tr><td>0x4/B7B6B5B4</td><td>2:在0x4读B7B6B5B4[31:0],在0x1写B4[7:0]</td><td>0x1/B4</td></tr><tr><td>0x8/BBBAB9B8</td><td>3:在0x8读BBBAB9B8[31:0],在0x2写B8[7:0]</td><td>0x2/B8</td></tr><tr><td>0xC/ BFBEBDBC</td><td>4:在0xC读BFBEBDBC[31:0],在0x3写BC[7:0]</td><td>0x3/BC</td></tr><tr><td rowspan="4">32</td><td rowspan="4">16</td><td rowspan="4">4</td><td>0x0/B3B2B1B0</td><td>1:在0x0读B3B2B1B0[31:0],在0x0写B1B0[15:0]</td><td>0x0/B1B0</td></tr><tr><td>0x4/B7B6B5B4</td><td>2:在0x4读B7B6B5B4[31:0],在0x2写B5B4[15:0]</td><td>0x2/B5B4</td></tr><tr><td>0x8/BBBAB9B8</td><td>3:在0x8读BBBAB9B8[31:0],在0x4写B9B8[15:0]</td><td>0x4/B9B8</td></tr><tr><td>0xC/ BFBEBDBC</td><td>4:在0xC读BFBEBDBC[31:0],在0x6写BDBC[15:0]</td><td>0x6/BDBC</td></tr><tr><td rowspan="4">32</td><td rowspan="4">32</td><td rowspan="4">4</td><td>0x0/B3B2B1B0</td><td>1:在0x0读B3B2B1B0[31:0],在0x0写B3B2B1B0[31:0]</td><td>0x0/B3B2B1B0</td></tr><tr><td>0x4/B7B6B5B4</td><td>2:在0x4读B7B6B5B4[31:0],在0x4写B7B6B5B4[31:0]</td><td>0x4/B7B6B5B4</td></tr><tr><td>0x8/BBBAB9B8</td><td>3:在0x8读BBBAB9B8[31:0],在0x8写BBBAB9B8[31:0]</td><td>0x8/BBBAB9B8</td></tr><tr><td>0xC/ BFBEBDBC</td><td>4:在0xC读BFBEBDBC[31:0],在0xC写BFBEBDBC[31:0]</td><td>0xC/ BFBEBDBC</td></tr></table>

# 数据转运+DMA

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/1610f0fe18a32a9ed8d9e5af6e1a70a4a3faba896c42d34b71aa356cd5cf830f.jpg)  
DMA外设地址 DMA存储器地址

# ADC扫描模式+DMA

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/c289f7f6f25bf675f63799b1c5d2d05f69f7d93361b21b1eb276c90cc9ebd6b4.jpg)

# 通信接口

- 通信的目的：将一个设备的数据传送到另一个设备，扩展硬件系统  
- 通信协议：制定通信的规则，通信双方按照协议规则进行数据收发

<table><tr><td>名称</td><td>引脚</td><td>双工</td><td>时钟</td><td>电平</td><td>设备</td></tr><tr><td>USART</td><td>TX、RX</td><td>全双工</td><td>异步</td><td>单端</td><td>点对点</td></tr><tr><td>I2C</td><td>SCL、SDA</td><td>半双工</td><td>同步</td><td>单端</td><td>多设备</td></tr><tr><td>SPI</td><td>SCLK、MOSI、MISO、CS</td><td>全双工</td><td>同步</td><td>单端</td><td>多设备</td></tr><tr><td>CAN</td><td>CAN_H、CAN_L</td><td>半双工</td><td>异步</td><td>差分</td><td>多设备</td></tr><tr><td>USB</td><td>DP、DM</td><td>半双工</td><td>异步</td><td>差分</td><td>点对点</td></tr></table>

# 串口通信

- 串口是一种应用十分广泛的通讯接口，串口成本低、容易使用、通信线路简单，可实现两个设备的互相通信  
- 单片机的串口可以使单片机与单片机、单片机与电脑、单片机与各式各样的模块互相通信，极大地扩展了单片机的应用范围，增强了单片机系统的硬件实力

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/2e4aacb21e9d73b87a6ec4d1e142eeded66c26a63092e8596b417ca172917fae.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/3fd1ce4bf08cf20c06b4ab62c056ef3b5c8ba9ca0ffe2144ffbe60451df343e2.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/c6aedd0efe7f912f8693057c57a2c29a610e333e262205aafb278ae958ebd6ba.jpg)

# 硬件电路

- 简单双向串口通信有两根通信线（发送端TX和接收端RX）  
- TX与RX要交叉连接  
- 当只需单向的数据传输时，可以只接一根通信线  
- 当电平标准不一致时，需要加电平转换芯片

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/23b8e073d5e47abde70ed81a0ee742c7a79d6939a3c018a89644447a713de551.jpg)

# 电平标准

- 电平标准是数据1和数据0的表达方式，是传输线缆中人为规定的电压与数据的对应关系，串口常用的电平标准有如下三种：  
• TTL电平: +3.3V或+5V表示1, 0V表示0  
RS232电平: -3~+15V表示1, +3~+15V表示0  
RS485电平: 两线压差  $+2 \sim +6 \mathrm{~V}$  表示  $1, -2 \sim -6 \mathrm{~V}$  表示  $0$  (差分信号)

# 串口参数及时序

- 波特率：串口通信的速率  
- 起始位：标志一个数据帧的开始，固定为低电平  
- 数据位：数据帧的有效载荷，1为高电平，0为低电平，低位先行  
- 校验位：用于数据验证，根据数据位计算得来  
- 停止位：用于数据帧间隔，固定为高电平

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/91dd459e3cb76988cc670735bf6b753b00ef8be3ed42bf4078b5047d56d2dc8d.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/ea8a97db321683b27b2838e7a95c637026b31c118a65195f7469cc80a353851a.jpg)

# 串口时序

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/842b3936eef13896e78ea2fe45400c09f575e62867ca7ec863e7906fabc7ec5e.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/11441bfc5dc2faa33768db59c1c9f3a3d1d6809bd70ab515b07192cae5eb7ce8.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/82b442c8b26955d348c87b0b564c56a4aa35d46eda05dbd5a4058cdc78a042eb.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/b1e322c22ccd3c3524880d3b6a41c65b00b9fd761c61d0e9365081a7f4695fd1.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/fedc96d313062a4772e11ed3318b9a92708769097012c5a9eba6d50a5807127b.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/355704301150142430a46ed136a005e9d98fa22393eac2cf56fe0000be78e685.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/ee94074c669f3074169127986d09f6ba760368058b883e0b91e016cda530d3da.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/438c1cb3a4e2eff8b35e6d10f8878c073632750a9503a414b698c848d8ef95a6.jpg)

# USART简介

-USART (Universal Synchronous/Asynchronous Receiver/Transmitter) 通用同步/异步收发器  
-USART是STM32内部集成的硬件外设，可根据数据寄存器的一个字节数据自动生成数据帧时序，从TX引脚发送出去，也可自动接收RX引脚的数据帧时序，拼接为一个字节数据，存放在数据寄存器里  
- 自带波特率发生器，最高达4.5Mbits/s  
- 可配置数据位长度（8/9）、停止位长度（0.5/1/1.5/2）  
- 可选校验位（无校验/奇校验/偶校验）  
- 支持同步模式、硬件流控制、DMA、智能卡、IrDA、LIN  
- STM32F103C8T6USART资源：USART1、USART2、USART3

图248USART框图  
![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/0078400ef2b0571c0eb09e59f4dd3921259bac65ede09491855a480904ca520b.jpg)  
USARTDIV = DIV_Mantissa + (DIV_Fraction / 16)

# USART基本结构

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/d30b01408c4f4868eeeb18ab417173857baf6c95a4b7cb5ff1f7009f5cff98ad.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/af4d48bf0f3837f7a60f473d9d74fba205fb33f540bb7c43afab0d5382d0bac5.jpg)  
图249 字长设置

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/9cf38dd00628695413b3f9ba55afe5e122cb5d0082536f818989c65f398ee009.jpg)  
**LBCL位控制最后一个数据的时钟脉冲  
**LBCL位控制最后一个数据的时钟脉冲

# 数据帧

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/04a2eab9448c00942e26547ee187e612a87d4c27230785de7a255eccf987843b.jpg)  
图250 配置停止位

# 起始位侦测

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/97512f3c9535637cb75497793074d3c560a16a9008564626a10d25528382b25d.jpg)  
图252 起始位侦测

# 数据采样

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/9d3574dff72d5183bc1ad2d05a76fc84895fb7d618525ddd7fb8eff31645347e.jpg)  
图253 检测噪声的数据采样

# 波特率发生器

- 发送器和接收器的波特率由波特率寄存器BRR里的DIV确定  
- 计算公式: 波特率  $= f_{\mathrm{PCLK}2 / 1} / (16 * \mathrm{DIV})$

# 25.6.3 波特比率寄存器(USART_BRR)

注意：如果TE或RE被分别禁止，波特计数器停止计数

地址偏移：0x08

复位值：0x0000

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/eebe421575e07c45894c632eca6af329ff7c50c0585188761bef7d611ec4a458.jpg)

<table><tr><td>位31:16</td><td>保留位, 硬件强制为 0</td></tr><tr><td>位15:4</td><td>DIV_Mantissa[11:0]: USARTDIV的整数部分这12位定义了USART分频器除法因子(USARTDIV)的整数部分。</td></tr><tr><td>位3:0</td><td>DIV_Fraction[3:0]: USARTDIV的小数部分这4位定义了USART分频器除法因子(USARTDIV)的小数部分。</td></tr></table>

# 数据模式

- HEX模式/十六进制模式/二进制模式：以原始数据的形式显示  
- 文本模式/字符模式：以原始数据编码后的形式显示

<table><tr><td>DEC</td><td>HEX</td><td>字符</td><td>解释</td></tr><tr><td>0</td><td>0x00</td><td>(NUL)</td><td>空字符</td></tr><tr><td>1</td><td>0x01</td><td>(SOH)</td><td>标题开始</td></tr><tr><td>2</td><td>0x02</td><td>(STX)</td><td>正文开始</td></tr><tr><td>3</td><td>0x03</td><td>(ETX)</td><td>正文结束</td></tr><tr><td>4</td><td>0x04</td><td>(EOT)</td><td>传输结束</td></tr><tr><td>5</td><td>0x05</td><td>(ENQ)</td><td>请求</td></tr><tr><td>6</td><td>0x06</td><td>(ACK)</td><td>收到通知</td></tr><tr><td>7</td><td>0x07</td><td>(BEL)</td><td>响铃\(\backslash\)a)</td></tr><tr><td>8</td><td>0x08</td><td>(BS)</td><td>退格\(\backslash\)b)</td></tr><tr><td>9</td><td>0x09</td><td>(HT)</td><td>水平制表符\(\backslash\)t)</td></tr><tr><td>10</td><td>0x0A</td><td>(LF)</td><td>换行键\(\backslash\)n)</td></tr><tr><td>11</td><td>0x0B</td><td>(VT)</td><td>垂直制表符\(\backslash\)v)</td></tr><tr><td>12</td><td>0x0C</td><td>(FF)</td><td>换页键\(\backslash\)f)</td></tr><tr><td>13</td><td>0x0D</td><td>(CR)</td><td>回车键\(\backslash\)r)</td></tr><tr><td>14</td><td>0x0E</td><td>(SO)</td><td>不用切换</td></tr><tr><td>15</td><td>0x0F</td><td>(SI)</td><td>启用切换</td></tr><tr><td>16</td><td>0x10</td><td>(DLE)</td><td>数据链路转义</td></tr><tr><td>17</td><td>0x11</td><td>(DC1)</td><td>设备控制1</td></tr><tr><td>18</td><td>0x12</td><td>(DC2)</td><td>设备控制2</td></tr><tr><td>19</td><td>0x13</td><td>(DC3)</td><td>设备控制3</td></tr><tr><td>20</td><td>0x14</td><td>(DC4)</td><td>设备控制4</td></tr><tr><td>21</td><td>0x15</td><td>(NAK)</td><td>拒绝接收</td></tr><tr><td>22</td><td>0x16</td><td>(SYN)</td><td>同步空闲</td></tr><tr><td>23</td><td>0x17</td><td>(ETB)</td><td>结束传输块</td></tr><tr><td>24</td><td>0x18</td><td>(CAN)</td><td>取消</td></tr><tr><td>25</td><td>0x19</td><td>(EM)</td><td>媒介结束</td></tr><tr><td>26</td><td>0x1A</td><td>(SUB)</td><td>代替</td></tr><tr><td>27</td><td>0x1B</td><td>(ESC)</td><td>换码</td></tr><tr><td>28</td><td>0x1C</td><td>(FS)</td><td>文件分隔符</td></tr><tr><td>29</td><td>0x1D</td><td>(GS)</td><td>分组符</td></tr><tr><td>30</td><td>0x1E</td><td>(RS)</td><td>记录分隔符</td></tr><tr><td>31</td><td>0x1F</td><td>(US)</td><td>单元分隔符</td></tr></table>

<table><tr><td>DEC</td><td>HEX</td><td>字符</td><td>解释</td></tr><tr><td>32</td><td>0x20</td><td>(space)</td><td>空格</td></tr><tr><td>33</td><td>0x21</td><td>!</td><td>叹号</td></tr><tr><td>34</td><td>0x22</td><td>&quot;</td><td>双引号</td></tr><tr><td>35</td><td>0x23</td><td>#</td><td>井号</td></tr><tr><td>36</td><td>0x24</td><td>$</td><td>美元符</td></tr><tr><td>37</td><td>0x25</td><td>%</td><td>百分号</td></tr><tr><td>38</td><td>0x26</td><td>&amp;</td><td>与号</td></tr><tr><td>39</td><td>0x27</td><td>&#x27;</td><td>单引号</td></tr><tr><td>40</td><td>0x28</td><td>(</td><td>左括号</td></tr><tr><td>41</td><td>0x29</td><td>)</td><td>右括号</td></tr><tr><td>42</td><td>0x2A</td><td>*</td><td>星号</td></tr><tr><td>43</td><td>0x2B</td><td>+</td><td>加号</td></tr><tr><td>44</td><td>0x2C</td><td>,</td><td>逗号</td></tr><tr><td>45</td><td>0x2D</td><td>-</td><td>减号</td></tr><tr><td>46</td><td>0x2E</td><td>.</td><td>句号</td></tr><tr><td>47</td><td>0x2F</td><td>/</td><td>斜杠</td></tr><tr><td>48</td><td>0x30</td><td>0</td><td>字符0</td></tr><tr><td>49</td><td>0x31</td><td>1</td><td>字符1</td></tr><tr><td>50</td><td>0x32</td><td>2</td><td>字符2</td></tr><tr><td>51</td><td>0x33</td><td>3</td><td>字符3</td></tr><tr><td>52</td><td>0x34</td><td>4</td><td>字符4</td></tr><tr><td>53</td><td>0x35</td><td>5</td><td>字符5</td></tr><tr><td>54</td><td>0x36</td><td>6</td><td>字符6</td></tr><tr><td>55</td><td>0x37</td><td>7</td><td>字符7</td></tr><tr><td>56</td><td>0x38</td><td>8</td><td>字符8</td></tr><tr><td>57</td><td>0x39</td><td>9</td><td>字符9</td></tr><tr><td>58</td><td>0x3A</td><td>:</td><td>冒号</td></tr><tr><td>59</td><td>0x3B</td><td>;</td><td>分号</td></tr><tr><td>60</td><td>0x3C</td><td>&lt;</td><td>小于</td></tr><tr><td>61</td><td>0x3D</td><td>=</td><td>等号</td></tr><tr><td>62</td><td>0x3E</td><td>&gt;</td><td>大于</td></tr><tr><td>63</td><td>0x3F</td><td>?</td><td>问号</td></tr></table>

<table><tr><td>DEC</td><td>HEX</td><td>字符</td><td>解释</td></tr><tr><td>64</td><td>0x40</td><td>@</td><td>电子邮件符号</td></tr><tr><td>65</td><td>0x41</td><td>A</td><td>大写字母A</td></tr><tr><td>66</td><td>0x42</td><td>B</td><td>大写字母B</td></tr><tr><td>67</td><td>0x43</td><td>C</td><td>大写字母C</td></tr><tr><td>68</td><td>0x44</td><td>D</td><td>大写字母D</td></tr><tr><td>69</td><td>0x45</td><td>E</td><td>大写字母E</td></tr><tr><td>70</td><td>0x46</td><td>F</td><td>大写字母F</td></tr><tr><td>71</td><td>0x47</td><td>G</td><td>大写字母G</td></tr><tr><td>72</td><td>0x48</td><td>H</td><td>大写字母H</td></tr><tr><td>73</td><td>0x49</td><td>I</td><td>大写字母I</td></tr><tr><td>74</td><td>0x4A</td><td>J</td><td>大写字母J</td></tr><tr><td>75</td><td>0x4B</td><td>K</td><td>大写字母K</td></tr><tr><td>76</td><td>0x4C</td><td>L</td><td>大写字母L</td></tr><tr><td>77</td><td>0x4D</td><td>M</td><td>大写字母M</td></tr><tr><td>78</td><td>0x4E</td><td>N</td><td>大写字母N</td></tr><tr><td>79</td><td>0x4F</td><td>O</td><td>大写字母O</td></tr><tr><td>80</td><td>0x50</td><td>P</td><td>大写字母P</td></tr><tr><td>81</td><td>0x51</td><td>Q</td><td>大写字母Q</td></tr><tr><td>82</td><td>0x52</td><td>R</td><td>大写字母R</td></tr><tr><td>83</td><td>0x53</td><td>S</td><td>大写字母S</td></tr><tr><td>84</td><td>0x54</td><td>T</td><td>大写字母T</td></tr><tr><td>85</td><td>0x55</td><td>U</td><td>大写字母U</td></tr><tr><td>86</td><td>0x56</td><td>V</td><td>大写字母V</td></tr><tr><td>87</td><td>0x57</td><td>W</td><td>大写字母W</td></tr><tr><td>88</td><td>0x58</td><td>X</td><td>大写字母X</td></tr><tr><td>89</td><td>0x59</td><td>Y</td><td>大写字母Y</td></tr><tr><td>90</td><td>0x5A</td><td>Z</td><td>大写字母Z</td></tr><tr><td>91</td><td>0x5B</td><td>[</td><td>左方括号</td></tr><tr><td>92</td><td>0x5C</td><td>\</td><td>反斜杠</td></tr><tr><td>93</td><td>0x5D</td><td>]</td><td>右方括号</td></tr><tr><td>94</td><td>0x5E</td><td>^</td><td>次方号</td></tr><tr><td>95</td><td>0x5F</td><td>_</td><td>下划线</td></tr></table>

<table><tr><td>DEC</td><td>HEX</td><td>字符</td><td>解释</td></tr><tr><td>96</td><td>0x60</td><td>`</td><td>反单引号</td></tr><tr><td>97</td><td>0x61</td><td>a</td><td>小写字母a</td></tr><tr><td>98</td><td>0x62</td><td>b</td><td>小写字母b</td></tr><tr><td>99</td><td>0x63</td><td>c</td><td>小写字母c</td></tr><tr><td>100</td><td>0x64</td><td>d</td><td>小写字母d</td></tr><tr><td>101</td><td>0x65</td><td>e</td><td>小写字母e</td></tr><tr><td>102</td><td>0x66</td><td>f</td><td>小写字母f</td></tr><tr><td>103</td><td>0x67</td><td>g</td><td>小写字母g</td></tr><tr><td>104</td><td>0x68</td><td>h</td><td>小写字母h</td></tr><tr><td>105</td><td>0x69</td><td>i</td><td>小写字母i</td></tr><tr><td>106</td><td>0x6A</td><td>j</td><td>小写字母j</td></tr><tr><td>107</td><td>0x6B</td><td>k</td><td>小写字母k</td></tr><tr><td>108</td><td>0x6C</td><td>l</td><td>小写字母l</td></tr><tr><td>109</td><td>0x6D</td><td>m</td><td>小写字母m</td></tr><tr><td>110</td><td>0x6E</td><td>n</td><td>小写字母n</td></tr><tr><td>111</td><td>0x6F</td><td>o</td><td>小写字母o</td></tr><tr><td>112</td><td>0x70</td><td>p</td><td>小写字母p</td></tr><tr><td>113</td><td>0x71</td><td>q</td><td>小写字母q</td></tr><tr><td>114</td><td>0x72</td><td>r</td><td>小写字母r</td></tr><tr><td>115</td><td>0x73</td><td>s</td><td>小写字母s</td></tr><tr><td>116</td><td>0x74</td><td>t</td><td>小写字母t</td></tr><tr><td>117</td><td>0x75</td><td>u</td><td>小写字母u</td></tr><tr><td>118</td><td>0x76</td><td>v</td><td>小写字母v</td></tr><tr><td>119</td><td>0x77</td><td>w</td><td>小写字母w</td></tr><tr><td>120</td><td>0x78</td><td>x</td><td>小写字母x</td></tr><tr><td>121</td><td>0x79</td><td>y</td><td>小写字母y</td></tr><tr><td>122</td><td>0x7A</td><td>z</td><td>小写字母z</td></tr><tr><td>123</td><td>0x7B</td><td>{</td><td>左花括号</td></tr><tr><td>124</td><td>0x7C</td><td>|</td><td>竖线</td></tr><tr><td>125</td><td>0x7D</td><td>}</td><td>右花括号</td></tr><tr><td>126</td><td>0x7E</td><td>~</td><td>波浪号</td></tr><tr><td>127</td><td>0x7F</td><td>(DEL)</td><td>删除</td></tr></table>

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/e0da77a9c2037cf9086a7d91be2b07160a5dc2aa749b9bfff60bb5a1b9cbe757.jpg)

# HEX数据包

- 固定包长，含包头包尾

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/6c49b33d7c0b1d6b77db8db8cf2177a6bab42ae9ab5fafba777a6499ccc1edbd.jpg)

- 可变包长，含包头包尾

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/7ba2dc4297985e052607a206f99acd78427f00ae4e6d0c427f2bea5df1510a76.jpg)

# 文本数据包

- 固定包长，含包头包尾

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/1a05a4ab66da5d87ac799bdb595da8dc1b42c98535da88414376e1f3124f4799.jpg)  
数据包1  
数据包2

- 可变包长, 含包头包尾

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/635ea826af9bc1266a80b5d55f4d4b5aa008e1687ec9e2c46034ace62d62f2b3.jpg)  
数据包1  
数据包2

# HEX数据包接收

<table><tr><td>0xFF</td><td>0x01</td><td>0x02</td><td>0x03</td><td>0x04</td><td>0xFE</td><td>0xFF</td><td>0x05</td><td>0x06</td><td>0x07</td><td>0x08</td><td>0xFE</td><td>······</td></tr></table>

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/9fbb4cc3b849a160a4458cc2ff3bba70501cf952ef8233e17b612a0bff19d330.jpg)

# 文本数据包接收

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/f1190384fb526eca3480acaa0cc3f99cf3f7cae00ee9463194c3108986d339c1.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/d33844a8707138150c73476e9bf20647835b5ad818e6f2cf82c6c82898d227d9.jpg)

# I2C通信

- I2C (Inter IC Bus) 是由Philips公司开发的一种通用数据总线  
- 两根通信线：SCL（Serial Clock）、SDA（Serial Data）  
- 同步，半双工  
• 带数据应答  
- 支持总线挂载多设备（一主多从、多主多从）

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/b75cf5ac605a341924b1b4606d1250be9ea072d9166702ae0812e30f44a9fdcd.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/fffc3897e7c1600e228036110003542cd5c291218a8768e102de06227b6b2321.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/16ebb43c2ad6555b8cac8a7881f1bebc46aa078f2c82f11e885857ced0e05fa9.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/60033d8fda5a59b1ebeace9fe6548e406b3ee23a7179b7472dfcfa180b9c39d1.jpg)

# 硬件电路

- 所有I2C设备的SCL连在一起，SDA连在一起  
设备的SCL和SDA均要配置成开漏输出模式  
- SCL和SDA各添加一个上拉电阻，阻值一般为  $4.7 \mathrm{k} \Omega$  左右

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/90eb56fcee5236f855b8eedf53d99ac07e4219f1194f0ebaa0ef56cec1d1acaf.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/d6710e97357f0e9dc391cfb5c0b360d69908b5c0b90f5178c22e153d5dc220e1.jpg)

# I2C时序基本单元

- 起始条件：SCL高电平期间，SDA从高电平切换到低电平  
- 终止条件：SCL高电平期间，SDA从低电平切换到高电平

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/34343474555290388484065dc75c8f74d2315b8a755c5305a465cde042b22eaf.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/6212ec9b9d3889f0b724f5e789f7aea8b8f9ef422766ea49647ed4483a0b7bd7.jpg)

# I2C时序基本单元

- 发送一个字节：SCL低电平期间，主机将数据位依次放到SDA线上（高位先行），然后释放SCL，从机将在SCL高电平期间读取数据位，所以SCL高电平期间SDA不允许有数据变化，依次循环上述过程8次，即可发送一个字节

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/1f97cec0ceb5e5980305afc482e61448aa8d29d5bc28ddf957d9e289074a21d7.jpg)

# I2C时序基本单元

- 接收一个字节：SCL低电平期间，从机将数据位依次放到SDA线上（高位先行），然后释放SCL，主机将在SCL高电平期间读取数据位，所以SCL高电平期间SDA不允许有数据变化，依次循环上述过程8次，即可接收一个字节（主机在接收之前，需要释放SDA）

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/8f4aa26c886de70357727c4a67eea4bc7f7341ab346e6a6e12733f9353e95389.jpg)

# I2C时序基本单元

• 发送应答：主机在接收完一个字节之后，在下一个时钟发送一位数据，数据0表示应答，数据1表示非应答  
• 接收应答：主机在发送完一个字节之后，在下一个时钟接收一位数据，判断从机是否应答，数据0表示应答，数据1表示非应答（主机在接收之前，需要释放SDA）

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/8be6523c23bd6f6a620dbf686b1131c20985970b7cc292b457dfdda6709be536.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/68e18ce74de0b84d0ce7e2cc9afaf613a9cfaca10f16b18d2e33283cd5cc6cf7.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/771cd083a4231218258f8dc422c29a1ed562b4ab8c9b077f3c172b578acdaa19.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/50e33ad78ef0eeb17fb6ed53d2a45fdf74d857fd52ec5018684d3d5a65065530.jpg)

# I2C时序

- 指定地址写  
• 对于指定设备（Slave Address），在指定地址（Reg Address）下，写入指定数据（Data）

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/9a66a9db498017f62ec82c8f3a1a0c31a2918c94ca4fa0e3d4e0be8dfc3a8cdc.jpg)

# I2C时序

- 当前地址读  
- 对于指定设备（Slave Address），在当前地址指针指示的地址下，读取从机数据（Data）

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/46e59cb22c2397995f9fb5390c4cc2709d5a7b2d88458d7045a6efbc25acbae2.jpg)

# I2C时序

- 指定地址读  
• 对于指定设备（Slave Address），在指定地址（Reg Address）下，读取从机数据（Data）

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/41c5eeb9fde0806bd3bf7a5975eead554c14fd92637bf7d94b48dd39d0c1327c.jpg)

- MPU6050是一个6轴姿态传感器，可以测量芯片自身X、Y、Z轴的加速度、角速度参数，通过数据融合，可进一步得到姿态角，常应用于平衡车、飞行器等需要检测自身姿态的场景  
• 3轴加速度计（Accelerometer）：测量X、Y、Z轴的加速度  
• 3轴陀螺仪传感器 (Gyroscope) : 测量X、Y、Z轴的角速度

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/517148eb02a894c1e660036ab3f217a169d71dce2cf0d30bc36c9978152466f3.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/ceb05ddff0778a72b77f59804d85687fdbaaf7b718f8df36751db2d2fcf801e0.jpg)  
加速度计示意图

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/d3190df461c7b18a01e4bde3079a15ab9348ff14a926b4fe40735b9f316f2cea.jpg)

# MPU6050参数

16位ADC采集传感器的模拟信号，量化范围：-32768~32767  
• 加速度计满量程选择:  $\pm 2 、 \pm 4 、 \pm 8 、 \pm 16 (g)$  
- 陀螺仪满量程选择:  $\pm 250 、 \pm 500 、 \pm 1000 、 \pm 2000$  (%/sec)  
- 可配置的数字低通滤波器  
- 可配置的时钟源  
- 可配置的采样分频

• I2C从机地址: 1101000 (AD0=0)

$$
1 1 0 1 0 0 1 \quad (A D O = 1)
$$

# 硬件电路

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/70beda1ead1ed82710a1ce592dd3a23baa6a955aa3143139a910ae43ed92e3c9.jpg)

<table><tr><td>引脚</td><td>功能</td></tr><tr><td>VCC、GND</td><td>电源</td></tr><tr><td>SCL、SDA</td><td>I2C通信引脚</td></tr><tr><td>XCL、XDA</td><td>主机I2C通信引脚</td></tr><tr><td>ADO</td><td>从机地址最低位</td></tr><tr><td>INT</td><td>中断信号输出</td></tr></table>

# MPU6050框图

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/321efed052d3ddc005cdc8e7b0c3c63e8fbc386b395d85daa539a9b5dfbfeaf2.jpg)

# I2C外设简介

- STM32内部集成了硬件I2C收发电路，可以由硬件自动执行时钟生成、起始终止条件生成、应答位收发、数据收发等功能，减轻CPU的负担  
- 支持多主机模型  
- 支持7位/10位地址模式  
- 支持不同的通讯速度，标准速度(高达  $100 \mathrm{kHz}$  )，快速(高达  $400 \mathrm{kHz}$ )  
- 支持DMA  
- 兼容SMBus协议

- STM32F103C8T6 硬件I2C资源: I2C1、I2C2

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/5d2222d0e6a4f3d905aa44d378d8a5d917217db9a35be9296fcea78b37eee920.jpg)  
图242  
$\mathsf{I}^2\mathsf{C}$  的功能框图

# I2C基本结构

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/58585e071034af70b61588c85176970f863e041192b2c5e1c436e853501e8868.jpg)

# 主机发送

7位主发送

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/2a659ee7aeca809b36d9dceddea6312d97689ca3ed2fdd94cfc5894eb143bbf1.jpg)  
图245 主发送器传送序列图

10位主发送

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/2b6c00b3a407e76a824c74a4ad6cf56c4c92b41498ad721e4f013d7523a78e8a.jpg)

说明：S=Start(起始条件)， $S_r$  = 重复的起始条件，P=Stop(停止条件)，A=响应，NA=非响应，EVx=事件(ITEVFEN=1时产生中断)。

EV5：SB=1，读SR1然后将地址写入DR寄存器将清除该事件。  
EV6: ADDR=1，读SR1然后读SR2将清除该事件。  
EV8_1：TxE=1，移位寄存器空，数据寄存器空，写DR寄存器。  
EV8：TxE=1，移位寄存器非空，数据寄存器空，写入DR寄存器将清除该事件。  
EV8_2：TxE=1，BTF=1，请求设置停止位。TxE和BTF位由硬件在产生停止条件时清除。  
EV9：ADDR10=1，读SR1然后写入DR寄存器将清除该事件。

注：1-EV5、EV6、EV9、EV8_1和EV8_2事件拉长SCL低的时间，直到对应的软件序列结束。

2-EV8的软件序列必须在当前字节传输结束之前完成。

# 主机接收

7位主接收

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/cf4042aa224b48e347fa7dc5c9667a8c95ae8528a3e1499053940e48b063aae8.jpg)  
图246 主接收器传送序列图

10位主接收

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/bb485e5d891824f67f046a8008946657be38470d9a0e21f7b7a762571acd0c30.jpg)

说明：S=Start(起始条件)， $\mathsf{S}_{\mathsf{r}}=$  重复的起始条件，P=Stop(停止条件)，A=响应，NA=非响应，EVx=事件(ITEVFEN=1时产生中断)

EV5：SB=1，读SR1然后将地址写入DR寄存器将清除该事件。  
EV6：ADDR=1，读SR1然后读SR2将清除该事件。在10位主接收模式下，该事件后应设置CR2的START=1。  
- EV6_1：没有对应的事件标志，只适于接收1个字节的情况。恰好在EV6之后(即清除了ADDR之后)，要清除响应和停止条件的产生位。  
EV7：RxNE=1，读DR寄存器清除该事件。  
EV7_1：RxNE=1，读DR寄存器清除该事件。设置ACK=0和STOP请求。  
EV9：ADDR10=1，读SR1然后写入DR寄存器将清除该事件。

# 软件/硬件波形对比

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/ec8ff6a74bc33db72cb16e6f36c0c7d63e74059103f1bb60113a9ffb9ceaa40f.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/d207c3d7cad339a0b2f78c75e83fdd3a8fbcedc26d30ebff575852c0a0cd3f8d.jpg)

# SPI通信

- SPI（Serial Peripheral Interface）是由Motorola公司开发的一种通用数据总线  
• 四根通信线：SCK（Serial Clock）、MOSI（Master Output Slave Input）、MISO（Master Input Slave Output）、SS（Slave Select）  
- 同步，全双工  
- 支持总线挂载多设备（一主多从）

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/34bcfb45e361dd3c040fea26f606dbfbd4d250ad9b4adadf63af92673e3afa05.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/6809783019408b17877d723359991c371216571a8a26208d65d92e63438f692f.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/f6fe0a76b2ea9d49921dfa30e7ee9c0275038c9083f29c18d3206489adc56d19.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/4503953654915817e86082e9e380252be2229b004d9ff722ac9275f100a60359.jpg)

# 硬件电路

- 所有SPI设备的SCK、MOSI、MISO分别连在一起  
- 主机另外引出多条SS控制线，分别接到各从机的SS引脚  
- 输出引脚配置为推挽输出，输入引脚配置为浮空或上拉输入

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/817775c0052b7124bc6d51593a13abb0eb4d0e3a7e9cab18f5ee25a434bb2632.jpg)

# 移位示意图

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/b4a19ff7708791fcf78e4ec8d6441ed6cab80eaca422bed1318917052e0ad0e0.jpg)

# SPI时序基本单元

- 起始条件：SS从高电平切换到低电平  
- 终止条件：SS从低电平切换到高电平

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/a6b1eebc4cc98dc693e73346558b73ade46e18af969ad6bce09ddb5c1912f52f.jpg)

# SPI时序基本单元

- 交换一个字节（模式0）  
- CPOL=0: 空闲状态时, SCK为低电平  
• CPHA=0: SCK第一个边沿移入数据，第二个边沿移出数据

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/e29e268672945db7336dea38e27f87db531ad388a019d94e1f8a52442f00ebeb.jpg)

# SPI时序基本单元

- 交换一个字节（模式1）  
- CPOL=0: 空闲状态时, SCK为低电平  
• CPHA=1: SCK第一个边沿移出数据，第二个边沿移入数据

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/1ae38e9f3565bd13c5ba52f9c9806c3c9a02ccf7aa613bc26e5de427dd688eb8.jpg)

# SPI时序基本单元

- 交换一个字节（模式2）  
- CPOL=1: 空闲状态时, SCK为高电平  
• CPHA=0: SCK第一个边沿移入数据，第二个边沿移出数据

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/45bee132c4a385fc6961d75576b9d3badd557a622a65c896cf7285ae072b91d7.jpg)

# SPI时序基本单元

- 交换一个字节（模式3）  
- CPOL=1: 空闲状态时, SCK为高电平  
• CPHA=1: SCK第一个边沿移出数据，第二个边沿移入数据

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/e4bc3653ea0eb50e4b0c7f633854f63f26242e84ad7802bb2857bc013fbf776d.jpg)

- 发送指令  
- 向SS指定的设备，发送指令（0x06）

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/49f73c2e42dd5f599608454b3051621f3335418b994c62deefb92fe8fb52439e.jpg)

# SPI时序

- 指定地址写  
- 向SS指定的设备，发送写指令（0x02），随后在指定地址（Address[23:0]）下，写入指定数据（Data）

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/5b13b7bef4bfcd7b8ae5a0fa8b893dabd3eaadff321c8a552faff3f3ad1bac0c.jpg)

- 指定地址读  
- 向SS指定的设备，发送读指令（0x03），随后在指定地址（Address[23:0]）下，读取从机数据（Data）

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/379f9432d2456c187c08986f2b9d57d215c3b55343a495c312713c9996b6538a.jpg)

# W25Q64简介

- W25Qxx系列是一种低成本、小型化、使用简单的非易失性存储器,常应用于数据存储、字库存储、固件程序存储等场景  
- 存储介质：Nor Flash（闪存）  
- 时钟频率:  $80 \mathrm{MHz} / 160 \mathrm{MHz}$  (Dual SPI) /  $320 \mathrm{MHz}$  (Quad SPI)  
- 存储容量（24位地址）：

W25Q40: 4Mbit / 512KByte

W25Q80: 8Mbit / 1MByte

W25Q16: 16Mbit / 2MByte

W25Q32: 32Mbit / 4MByte

W25Q64: 64Mbit / 8MByte

W25Q128: 128Mbit / 16MByte

W25Q256: 256Mbit / 32MByte

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/149a401382907f9ac3eb715a648213dcdd3af2afc76bb4f40d41ae0db2db20ba.jpg)

# 硬件电路

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/075cbab85904b238c5939faec0ec6adb2e876eed82a24f5479d0befeacd0b307.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/2df4620fd30afb113f81680c7c82353ebe71a240cb072a05dbdb792f6f7b0b9d.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/4632684343883134995150024772d63fb5746a17fc5787ba3282cd2e20eb8400.jpg)

<table><tr><td>引脚</td><td>功能</td></tr><tr><td>VCC、GND</td><td>电源(2.7~3.6V)</td></tr><tr><td>CS(SS)</td><td>SPI片选</td></tr><tr><td>CLK(SCK)</td><td>SPI时钟</td></tr><tr><td>DI(MOSI)</td><td>SPI主机输出从机输入</td></tr><tr><td>DO(MISO)</td><td>SPI主机输入从机输出</td></tr><tr><td>WP</td><td>写保护</td></tr><tr><td>HOLD</td><td>数据保持</td></tr></table>

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/4e60f442c74237926b89c6434c193b34f19204e726b1a9bf0d61d5f2d986b50e.jpg)  
Figure 2. W25Q64BV Serial Flash Memory Block Diagram

# Flash操作注意事项

# 写入操作时:

- 写入操作前，必须先进行写使能  
- 每个数据位只能由1改写为0，不能由0改写为1  
- 写入数据前必须先擦除，擦除后，所有数据位变为1  
- 擦除必须按最小擦除单元进行  
- 连续写入多字节时，最多写入一页的数据，超过页尾位置的数据，会回到页首覆盖写入  
• 写入操作结束后，芯片进入忙状态，不响应新的读写操作读取操作时：  
- 直接调用读取时序，无需使能，无需额外操作，没有页的限制，读取操作结束后不会进入忙状态，但不能在忙状态时读取

# SPI外设简介

- STM32内部集成了硬件SPI收发电路，可以由硬件自动执行时钟生成、数据收发等功能，减轻CPU的负担  
- 可配置8位/16位数据帧、高位先行/低位先行  
• 时钟频率:  $f_{\mathrm{PCLK}} / (2,4,8,16,32,64,128,256)$  
- 支持多主机模型、主或从操作  
- 可精简为半双工/单工通信  
- 支持DMA  
- 兼容I2S协议  
- STM32F103C8T6 硬件SPI资源：SPI1、SPI2

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/058d7fc7ec80c83dfad6e548b634093d46833250ed60934df8b7d9288acd4592.jpg)  
图209 SPI框图

# SPI基本结构

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/02be695444d51e23a0524752dd497fe8baa123e6bbca58356e5d293ef3a0993d.jpg)

# 主模式全双工连续传输

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/7093f5f426b9befa7c6bb550f6b7e745779fe252290e4a07b7346e72ee2b5d44.jpg)  
图213 主模式、全双工模式下(BIDIMODE=0并且RXONLY=0)连续传输时，TXE/RXNE/BSY的变化示意图

# 非连续传输

例子配置：CPOL=1，CPHA=1

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/fc8687904d242cbb57cec9f8485411a718f176c968b5d8f177fb0e39a4595964.jpg)  
图218 非连续传输发送(BIDIMODE=0并且RXONLY=0)时，TXE/BSY变化示意图

ai17348

# 软件/硬件波形对比

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/b6bfccac174ea17e210e3e1597c64dd5bfe0f42cb70e4a1101162c4d0419a0e2.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/afb9c708adb1a3adf88dc181300215331b7949268d6512f20064e91f9bef6908.jpg)

# Unix时间戳

- Unix 时间戳（Unix Timestamp）定义为从UTC/GMT的1970年1月1日0时0分0秒开始所经过的秒数，不考虑闰秒  
时间戳存储在一个秒计数器中，秒计数器为32位/64位的整型变量  
- 世界上所有时区的秒计数器相同，不同时区通过添加偏移来得到当地时间

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/d27a4aeced68d5008495a7a80221569ac4a73b77e11a3ce06ea8bf88f0ceff7c.jpg)

- GMT（Greenwich Mean Time）格林尼治标准时间是一种以地球自转为基础的时间计量系统。它将地球自转一周的时间间隔等分为24小时，以此确定计时标准  
- UTC (Universal Time Coordinated) 协调世界时是一种以原子钟为基础的时间计量系统。它规定铯133原子基态的两个超精细能级间在零磁场下跃迁辐射9,192,631,770周所持续的时间为1秒。当原子钟计时一天的时间与地球自转一周的时间相差超过0.9秒时，UTC会执行闰秒来保证其计时与地球自转的协调一致

# 时间戳转换

C语言的time.h模块提供了时间获取和时间戳转换的相关函数，可以方便地进行秒计数器、日期时间和字符串之间的转换

<table><tr><td>函数</td><td>作用</td></tr><tr><td>time_t time(time_t*);</td><td>获取系统时钟</td></tr><tr><td>struct tm* gmtime(const time_t*);</td><td>秒计数器转换为日期时间（格林尼治时间）</td></tr><tr><td>struct tm*北京时间(const time_t*);</td><td>秒计数器转换为日期时间（当地时间）</td></tr><tr><td>time_t mktime(struct tm*);</td><td>日期时间转换为秒计数器（当地时间）</td></tr><tr><td>char* ctime(const time_t*);</td><td>秒计数器转换为字符串（默认格式）</td></tr><tr><td>char* asetime(const struct tm*);</td><td>日期时间转换为字符串（默认格式）</td></tr><tr><td>size_t strftime(char*, size_t, const char*, const struct tm*);</td><td>日期时间转换为字符串（自定义格式）</td></tr></table>

# 时间戳转换

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/4f15e718cee5503447d6449b230f5939a6afe49c1bbadca6bc63a29f08bd13bc.jpg)

# BKP简介

- BKP (Backup Registers) 备份寄存器  
- BKP可用于存储用户应用程序数据。当VDD（2.0~3.6V）电源被切断，他们仍然由VBAT（1.8~3.6V）维持供电。当系统在待机模式下被唤醒，或系统复位或电源复位时，他们也不会被复位  
- TAMPER引脚产生的侵入事件将所有备份寄存器内容清除  
- RTC引脚输出RTC校准时钟、RTC闹钟脉冲或者秒脉冲  
- 存储RTC时钟校准寄存器  
- 用户数据存储容量：20字节（中容量和小容量）/84字节（大容量和互联型）

# BKP基本结构

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/2de8c276037bd001a9986897580fd1ce0d94b37a900d6cfa14c5519624ce2f96.jpg)

# RTC简介

RTC (Real Time Clock) 实时时钟  
- RTC是一个独立的定时器，可为系统提供时钟和日历的功能  
- RTC和时钟配置系统处于后备区域，系统复位时数据不清零，VDD  $(2.0\sim 3.6\mathrm{V})$  断电后可借助VBAT（1.8~3.6V）供电继续走时  
• 32位的可编程计数器，可对应Unix时间戳的秒计数器  
- 20位的可编程预分频器，可适配不同频率的输入时钟  
- 可选择三种RTC时钟源:

HSE时钟除以128（通常为8MHz/128）

LSE振荡器时钟（通常为32.768KHz）

LSI振荡器时钟 (40KHz)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/a0f03af0c815af37a3a9d2c2e15d1a8f5320746f8a9c9ecaedf58ffe2e8e4804.jpg)  
图154 简化的RTC框图

ai14969b

# RTC基本结构

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/adee4fcdb319a29315d51ced18581fc44dd232ab0afdbd917adf7510395b4839.jpg)

# 硬件电路

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/0cb3167bfaadcd25e5f4aa589e54299eb5a5a3678897a21459cefe5fe692b032.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/1ea2fa7a02539f3c990992bcb8a234c91da6892d3918e7c706b7289d6bd562ae.jpg)

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/b0d142172d6991a1611d53fae80d53664db54d406c7884a498228ae2d2b24a8f.jpg)

# RTC操作注意事项

• 执行以下操作将使能对BKP和RTC的访问：
设置RCC_APB1ENR的PWREN和BKPEN，使能PWR和BKP时钟设置PWR_CR的DBP，使能对BKP和RTC的访问  
- 若在读取RTC寄存器时，RTC的APB1接口曾经处于禁止状态，则软件首先必须等待RTC_CRL寄存器中的RSF位（寄存器同步标志）被硬件置1  
- 必须设置RTC_CRL寄存器中的CNF位，使RTC进入配置模式后，才能写入RTC_PRL、RTC_CNT、RTC_ALR寄存器  
- 对RTC任何寄存器的写操作，都必须在前一次写操作结束后进行。可以通过查询RTC_CR寄存器中的RTOFF状态位，判断RTC寄存器是否处于更新中。仅当RTOFF状态位是1时，才可以写入RTC寄存器

# PWR简介

PWR（Power Control）电源控制  
- PWR负责管理STM32内部的电源供电部分，可以实现可编程电压监测器和低功耗模式的功能  
- 可编程电压监测器（PVD）可以监控VDD电源电压，当VDD下降到PVD阈值以下或上升到PVD阈值之上时，PVD会触发中断，用于执行紧急关闭任务  
- 低功耗模式包括睡眠模式（Sleep）、停机模式（Stop）和待机模式（Standby），可在系统空闲时，降低STM32的功耗，延长设备使用时间

# 电源框图

图4 电源框图  
![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/4367ee7bfa6bcc96833af4cf856ddc051b7ae93fbc318364b2e07e195d393a16.jpg)  
$V_{DDA}$  和  $V_{SSA}$  必须分别联到  $V_{DD}$  和  $V_{SS}$  。

# 上电复位和掉电复位

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/03d119dab442adff739a587a1016f7d6e902fddcaf2132d8c20b2bf56a12b829.jpg)  
图5 上电复位和掉电复位的波形图

# 可编程电压监测器

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/438e5bd25bc5d07d488530591d41aadaab023d0b83cd0cc79286ef6ea583a0c9.jpg)  
图6 PVD的门限

# 低功耗模式

表8 低功耗模式一览  

<table><tr><td>模式</td><td>进入</td><td>唤醒</td><td>对1.8V区域时钟的影响</td><td>对\( V_{DD} \)区域时钟的影响</td><td>电压调节器</td></tr><tr><td rowspan="2">睡眠(SLEEP-NOW或SLEEP-ON-EXIT)</td><td>WFI</td><td>任一中断</td><td rowspan="2">CPU时钟关,对其他时钟和ADC时钟无影响</td><td rowspan="2">无</td><td rowspan="2">开</td></tr><tr><td>WFE</td><td>唤醒事件</td></tr><tr><td>停机</td><td>PDDS和LPDS位+SLEEPDEEP位+WFI或WFE</td><td>任一外部中断(在外部中断寄存器中设置)</td><td rowspan="2">关闭所有1.8V区域的时钟</td><td rowspan="2">HSI 和HSE的振荡器关闭</td><td>开启或处于低功耗模式(依据电源控制寄存器(PWR_CR)的设定)</td></tr><tr><td>待机</td><td>PDDS位+SLEEPDEEP位+WFI或WFE</td><td>WKUP引脚的上升沿、RTC闹钟事件、NRST引脚上的外部复位、IWDG复位</td><td>关</td></tr></table>

# 模式选择

- 执行WFI（Wait For Interrupt）或者WFE（Wait For Event）指令后，STM32进入低功耗模式

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/aaa68f0a591b8f5fdb77ce87f1580cfa1eb3830af69d36451c4b0f2e96e77b3c.jpg)

# 睡眠模式

- 执行完WFI/WFE指令后，STM32进入睡眠模式，程序暂停运行，唤醒后程序从暂停的地方继续运行  
- SLEEPONEXIT位决定STM32执行完WFI或WFE后，是立刻进入睡眠，还是等STM32从最低优先级的中断处理程序中退出时进入睡眠  
- 在睡眠模式下，所有的I/O引脚都保持它们在运行模式时的状态  
- WFI指令进入睡眠模式，可被任意一个NVIC响应的中断唤醒  
WFE指令进入睡眠模式，可被唤醒事件唤醒

# 停止模式

- 执行完WFI/WFE指令后，STM32进入停止模式，程序暂停运行，唤醒后程序从暂停的地方继续运行  
• 1.8V供电区域的所有时钟都被停止, PLL、HSI和HSE被禁止, SRAM和寄存器内容被保留下来  
- 在停止模式下，所有的I/O引脚都保持它们在运行模式时的状态  
- 当一个中断或唤醒事件导致退出停止模式时，HSI被选为系统时钟  
- 当电压调节器处于低功耗模式下，系统从停止模式退出时，会有一段额外的启动延时  
- WFI指令进入停止模式，可被任意一个EXTI中断唤醒  
- WFE指令进入停止模式，可被任意一个EXTI事件唤醒

# 待机模式

- 执行完WFI/WFE指令后，STM32进入待机模式，唤醒后程序从头开始运行  
- 整个1.8V供电区域被断电，PLL、HSI和HSE也被断电，SRAM和寄存器内容丢失，只有备份的寄存器和待机电路维持供电  
- 在待机模式下，所有的I/O引脚变为高阻态（浮空输入）  
- WKUP引脚的上升沿、RTC闹钟事件的上升沿、NRST引脚上外部复位、IWDG复位退出待机模式

# WDG简介

WDG (Watchdog) 看门狗  
- 看门狗可以监控程序的运行状态，当程序因为设计漏洞、硬件故障、电磁干扰等原因，出现卡死或跑飞现象时，看门狗能及时复位程序，避免程序陷入长时间的罢工状态，保证系统的可靠性和安全性  
- 看门狗本质上是一个定时器，当指定时间范围内，程序没有执行喂狗（重置计数器）操作时，看门狗硬件电路就自动产生复位信号  
- STM32内置两个看门狗

独立看门狗（IWDG）：独立工作，对时间精度要求较低  
窗口看门狗（WWDG）：要求看门狗在精确计时窗口起作用

图157 独立看门狗框图  
![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/b9e065b689ed55ecc5289826165582fde180eee320339cf9d91f1caf88348f68.jpg)  
看门狗功能处于VDD供电区，即在停机和待机模式时仍能正常工作。

# IWDG键寄存器

- 键寄存器本质上是控制寄存器，用于控制硬件电路的工作  
- 在可能存在干扰的情况下，一般通过在整个键寄存器写入特定值来代替控制寄存器写入一位的功能，以降低硬件电路受到干扰的概率

<table><tr><td>写入键寄存器的值</td><td>作用</td></tr><tr><td>0xCCCC</td><td>启用独立看门狗</td></tr><tr><td>0xAAAA</td><td>IWDG_RLR中的值重新加载到计数器（喂狗）</td></tr><tr><td>0x5555</td><td>解除IWDG_PR和IWDG_RLR的写保护</td></tr><tr><td>0x5555之外的其他值</td><td>启用IWDG_PR和IWDG_RLR的写保护</td></tr></table>

# IWDG超时时间

• 超时时间:  $T_{\text {IWDG}} = T_{\text {LSI}} \times \text {PR预分频系数} \times (\mathrm{RL} + 1)$  
• 其中:  $T_{\text {LSI}} = 1 / F_{\text {LSI}}$

表83 看门狗超时时间(40kHz的输入时钟(LSI)) $^{(1)}$  

<table><tr><td>预分频系数</td><td>PR[2:0]位</td><td>最短时间(ms)RL[11:0] = 0x000</td><td>最长时间(ms)RL[11:0] = 0xFFFF</td></tr><tr><td>/4</td><td>0</td><td>0.1</td><td>409.6</td></tr><tr><td>/8</td><td>1</td><td>0.2</td><td>819.2</td></tr><tr><td>/16</td><td>2</td><td>0.4</td><td>1638.4</td></tr><tr><td>/32</td><td>3</td><td>0.8</td><td>3276.8</td></tr><tr><td>/64</td><td>4</td><td>1.6</td><td>6553.6</td></tr><tr><td>/128</td><td>5</td><td>3.2</td><td>13107.2</td></tr><tr><td>/256</td><td>(6或7)</td><td>6.4</td><td>26214.4</td></tr></table>

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/d2ca3735bebc980945de3183f31b43bf9244291695aec187bcfc7607c70bdadb.jpg)  
图158 看门狗框图

# WWDG工作特性

- 递减计数器T[6:0]的值小于  $0 \times 40$  时, WWDG产生复位  
- 递减计数器T[6:0]在窗口W[6:0]外被重新装载时，WWDG产生复位  
• 递减计数器T[6:0]等于0x40时可以产生早期唤醒中断（EWI），用于重装载计数器以避免WWDG复位  
- 定期写入WWWDG_CR寄存器（喂狗）以避免WWWDG复位

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/3108971d551efcd152dd8752b06361412d7157ac964210e2dac16c9adcd7570b.jpg)  
图159 窗口看门狗时序图

# WWDG超时时间

• 超时时间:

$$
T _ {W W D G} = T _ {P C L K 1} \times 4 0 9 6 \times W D G T B \text {预 分 频 系 数} \times (T [ 5: 0 ] + 1)
$$

- 窗口时间：

$$
T _ {W I N} = T _ {P C L K 1} \times 4 0 9 6 \times W D G T B \text {预 分 频 系 数} \times (T [ 5: 0 ] - W [ 5: 0 ])
$$

• 其中:  $T_{\mathrm{PCLK} 1} = 1 / F_{\mathrm{PCLK} 1}$

计算超时的公式如下：

$$
T _ {W W D G} = T _ {P C L K 1} \times 4 0 9 6 \times 2 ^ {W D G T B} \times (T [ 5: 0 ] + 1); \tag {ms}
$$

其中：

$\mathsf{T}_{\mathsf{WWDG}}$  :WWDG超时时间

$\mathsf{T_{PCLK1}}$  ：APB1以ms为单位的时钟间隔

在PCLK1 = 36MHz时的最小-最大超时值

<table><tr><td>WDGTB</td><td>最小超时值</td><td>最大超时值</td></tr><tr><td>0</td><td>113μs</td><td>7.28ms</td></tr><tr><td>1</td><td>227μs</td><td>14.56ms</td></tr><tr><td>2</td><td>455μs</td><td>29.12ms</td></tr><tr><td>3</td><td>910μs</td><td>58.25ms</td></tr></table>

# IWDG和WWDG对比

<table><tr><td></td><td>IWDG独立看门狗</td><td>WWDG窗口看门狗</td></tr><tr><td>复位</td><td>计数器减到0后</td><td>计数器T[5:0]减到0后、过早重装计数器</td></tr><tr><td>中断</td><td>无</td><td>早期唤醒中断</td></tr><tr><td>时钟源</td><td>LSI(40KHz)</td><td>PCLK1(36MHz)</td></tr><tr><td>预分频系数</td><td>4、8、32、64、128、256</td><td>1、2、4、8</td></tr><tr><td>计数器</td><td>12位</td><td>6位(有效计数)</td></tr><tr><td>超时时间</td><td>0.1ms~26214.4ms</td><td>113us~58.25ms</td></tr><tr><td>喂狗方式</td><td>写入键寄存器,重装固定值RLR</td><td>直接写入计数器,写多少重装多少</td></tr><tr><td>防误操作</td><td>键寄存器和写保护</td><td>无</td></tr><tr><td>用途</td><td>独立工作,对时间精度要求较低</td><td>要求看门狗在精确计时窗口起作用</td></tr></table>

# FLASH简介

- STM32F1系列的FLASH包含程序存储器、系统存储器和选项字节三个部分，通过闪存存储器接口（外设）可以对程序存储器和选项字节进行擦除和编程  
- 读写FLASH的用途:

利用程序存储器的剩余空间来保存掉电不丢失的用户数据通过在程序中编程（IAP），实现程序的自我更新

- 在线编程（In-Circuit Programming - ICP）用于更新程序存储器的全部内容，它通过JTAG、SWD协议或系统加载程序（Bootloader）下载程序  
- 在程序中编程（In-Application Programming - IAP）可以使用微控制器支持的任一种通信接口下载程序

# 闪存模块组织

表2 闪存模块组织(中容量产品)  

<table><tr><td>块</td><td>名称</td><td>地址范围</td><td>长度(字节)</td></tr><tr><td rowspan="9">主存储器</td><td>页0</td><td>0x0800 0000 - 0x0800 03FF</td><td>1K</td></tr><tr><td>页1</td><td>0x0800 0400 - 0x0800 07FF</td><td>1K</td></tr><tr><td>页2</td><td>0x0800 0800 - 0x0800 0BFF</td><td>1K</td></tr><tr><td>页3</td><td>0x0800 0C00 - 0x0800 0FFF</td><td>1K</td></tr><tr><td>页4</td><td>0x0800 1000 - 0x0800 13FF</td><td>1K</td></tr><tr><td>·</td><td>·</td><td>·</td></tr><tr><td>·</td><td>·</td><td>·</td></tr><tr><td>·</td><td>·</td><td>·</td></tr><tr><td>页127</td><td>0x0801 FC00 - 0x0801 FFFF</td><td>1K</td></tr><tr><td rowspan="2">信息块</td><td>启动程序代码</td><td>0x1FFF F000 - 0x1FFF F7FF</td><td>2K</td></tr><tr><td>用户选择字节</td><td>0x1FFF F800 - 0x1FFF F80F</td><td>16</td></tr><tr><td rowspan="9">闪存存储器接口寄存器</td><td>FLASH_ACR</td><td>0x4002 2000 - 0x4002 2003</td><td>4</td></tr><tr><td>FLASH_KEYR</td><td>0x4002 2004 - 0x4002 2007</td><td>4</td></tr><tr><td>FLASH_OPTKEYR</td><td>0x4002 2008 - 0x4002 200B</td><td>4</td></tr><tr><td>FLASH_SR</td><td>0x4002 200C - 0x4002 200F</td><td>4</td></tr><tr><td>FLASH_CR</td><td>0x4002 2010 - 0x4002 2013</td><td>4</td></tr><tr><td>FLASH_AR</td><td>0x4002 2014 - 0x4002 2017</td><td>4</td></tr><tr><td>保留</td><td>0x4002 2018 - 0x4002 201B</td><td>4</td></tr><tr><td>FLASH_OBR</td><td>0x4002 201C - 0x4002 201F</td><td>4</td></tr><tr><td>FLASH_WRPR</td><td>0x4002 2020 - 0x4002 2023</td><td>4</td></tr></table>

# FLASH基本结构

闪存存储器接口 / 闪存编程和擦除控制器（FPEC）

程序存储器的擦除和编程

选项字节的擦除和编程

程序存储器 (C8T6-64K)

0x0800 0000

页0 (1K)

0x0800 0400

页1 (1K)

0x0800 0800

页2 (1K)

0x0800 0C00

页3 (1K)

···

···

0x0800 F400

页61 (1K)

0x0800 F800

页62 (1K)

0x0800 FC00

页63 (1K)

系统存储器

0x1FFF F000

Bootloader (2K)

选项字节

0x1FFF F800

选项字节 (16)

配置读写保护

# FLASH解锁

FPEC共有三个键值:

RDPRT键 = 0x000000A5

KEY1 = 0x45670123

KEY2 = 0xCDEF89AB

• 解锁:

复位后，FPEC被保护，不能写入FLASH_CR

在FLASH_KEYR先写入KEY1，再写入KEY2，解锁

错误的操作序列会在下次复位前锁死FPEC和FLASH_CR

• 加锁:

设置FLASH_CR中的LOCK位锁住FPEC和FLASH_CR

# 使用指针访问存储器

- 使用指针读指定地址下的存储器:

$$
u n t 1 6 \_ t D a t a = * ((\_ I O u n t 1 6 \_ t *) (0 \times 0 8 0 0 0 0 0));
$$

- 使用指针写指定地址下的存储器:

$$
* ((\_ I O u n t 1 6 _ {t} {*}) (0 \times 0 8 0 0 0 0 0 0)) = 0 \times 1 2 3 4;
$$

• 其中:

$$
\# d e f i n e \quad \_ I O \quad v o l a t i l e
$$

# 程序存储器编程

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/b087b40189a76d61793115caebc7286346b696ec9739e4055c0e05f62aed2c90.jpg)  
图一 编程过程

# 程序存储器页擦除

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/60059dea6aecf1b541bd1e410412f38b8c20c5c44c4c86a33cb97a1fa39f4b44.jpg)  
图二 闪存页擦除过程

# 程序存储器全擦除

![](https://cdn-mineru.openxlab.org.cn/result/2025-12-29/95e6e5a2-c285-4336-b6ec-77ada0ce4498/2f8af55f9d800e17d1577beaf31ae207b40ca0b32e35f8145cd09473840054fa.jpg)  
图三 闪存全擦除过程

# 选项字节

表6 信息块的组织结构  

<table><tr><td>地址</td><td>[31:24]</td><td>[23:16]</td><td>[15:8]</td><td>[7:0]</td></tr><tr><td>0x1FFF F800</td><td>nUSER</td><td>USER</td><td>nRDP</td><td>RDP</td></tr><tr><td>0x1FFF F804</td><td>nData1</td><td>Data1</td><td>nData0</td><td>Data0</td></tr><tr><td>0x1FFF F808</td><td>nWRP1</td><td>WRP1</td><td>nWRP0</td><td>WRP0</td></tr><tr><td>0x1FFF F80C</td><td>nWRP3</td><td>WRP3</td><td>nWRP2</td><td>WRP2</td></tr></table>

RDP: 写入RDPRT键（0x0000000A5）后解除读保护  
- USER: 配置硬件看门狗和进入停机/待机模式是否产生复位  
- Data0/1: 用户可自定义使用  
- WRPO/1/2/3: 配置写保护, 每一个位对应保护4个存储页 (中容量)

# 选项字节编程

- 检查FLASH_SR的BSY位，以确认没有其他正在进行的编程操作。  
- 解锁FLASH_CR的OPTWRE位  
- 设置FLASH_CR的OPTPG位为1  
- 写入要编程的半字到指定的地址  
- 等待BSY位变为0  
- 读出写入的地址并验证数据

# 选项字节擦除

- 检查FLASH_SR的BSY位，以确认没有其他正在进行的闪存操作。  
- 解锁FLASH_CR的OPTWRE位  
- 设置FLASH_CR的OPTER位为1  
- 设置FLASH_CR的STRT位为1  
- 等待BSY位变为0  
- 读出被擦除的选择字节并做验证

# 器件电子签名

- 电子签名存放在闪存存储器模块的系统存储区域，包含的芯片识别信息在出厂时编写，不可更改，使用指针读指定地址下的存储器可获取电子签名  
- 闪存容量寄存器:

基地址：0x1FFF F7E0

大小：16位

- 产品唯一身份标识寄存器:

基地址: 0x1FFF F7E8

大小：96位

• END