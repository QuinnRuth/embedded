# 8.1_DMA数据转运_打卡gemini

## 1. 章节目标回顾
本次学习的目标是掌握 STM32 的 DMA（直接存储器访问）功能。通过配置 DMA 控制器，实现内存到内存（Memory to Memory）的数据块高速转运。验证在不占用 CPU 资源的情况下，如何高效地完成大批量数据的迁移，并观察转运前后数据的变化。

## 2. 核心知识点精华
### 2.1 什么是 DMA？
DMA 是主板上的“数据搬运工”。它可以独立于 CPU，直接控制外设与存储器、或存储器与存储器之间的数据交换。
- **意义**：释放 CPU，让 CPU 在数据转运期间可以处理更复杂的逻辑运算。
- **通道**：STM32F103 有 7 个 DMA1 通道。

### 2.2 内存到内存转运的关键配置
- **外设地址 (CPAR)**：转运源地址（虽然叫外设地址，但在 M2M 模式下可以填 SRAM 地址）。
- **存储器地址 (CMAR)**：转运目的地址。
- **传输数量 (CNDTR)**：要搬运的数据个数，是一个自减计数器。
- **地址增量 (MINC/PINC)**：搬运完一个数据后，地址是否自动移动到下一个。
- **M2M 模式**：必须开启，此时 DMA 将以最高优先级不间断地进行软件触发传输。

## 3. 核心代码注释速查表
### 3.1 DMA 初始化配置 (MyDMA.c)
```c
void MyDMA_Init(uint32_t AddrA, uint32_t AddrB, uint16_t Size)
{
    RCC_AHBPeriphClockCmd(RCC_AHBPeriph_DMA1, ENABLE); // DMA挂在AHB总线上
    
    DMA_InitTypeDef DMA_InitStructure;
    DMA_InitStructure.DMA_PeripheralBaseAddr = AddrA; // 源地址
    DMA_InitStructure.DMA_PeripheralDataSize = DMA_PeripheralDataSize_Byte; // 字节传输(8位)
    DMA_InitStructure.DMA_PeripheralInc = DMA_PeripheralInc_Enable; // 源地址自增
    
    DMA_InitStructure.DMA_MemoryBaseAddr = AddrB; // 目的地址
    DMA_InitStructure.DMA_MemoryDataSize = DMA_MemoryDataSize_Byte;
    DMA_InitStructure.DMA_MemoryInc = DMA_MemoryInc_Enable; // 目的地址自增
    
    DMA_InitStructure.DMA_DIR = DMA_DIR_PeripheralSRC; // 传输方向：外设(AddrA) -> 存储器(AddrB)
    DMA_InitStructure.DMA_BufferSize = Size; // 传输数量
    DMA_InitStructure.DMA_Mode = DMA_Mode_Normal; // 正常模式（转完一轮就停）
    DMA_InitStructure.DMA_M2M = DMA_M2M_Enable; // 开启内存到内存模式
    DMA_InitStructure.DMA_Priority = DMA_Priority_Medium; // 中等优先级
    
    DMA_Init(DMA1_Channel1, &DMA_InitStructure);
    
    DMA_Cmd(DMA1_Channel1, DISABLE); // 默认不启动，等调用时再启动
}
```

### 3.2 触发转运函数 (MyDMA.c)
```c
void MyDMA_Transfer(void)
{
    DMA_Cmd(DMA1_Channel1, DISABLE); // 先关闭才能重新设置计数器
    DMA_SetCurrDataCounter(DMA1_Channel1, MyDMA_Size); // 重置传输数量
    DMA_Cmd(DMA1_Channel1, ENABLE); // 启动转运
    
    while (DMA_GetFlagStatus(DMA1_FLAG_TC1) == RESET); // 等待传输完成标志(TC)
    DMA_ClearFlag(DMA1_FLAG_TC1); // 清除标志位
}
```

## 4. 核心洞察
- **本质思考**：DMA 的核心是“总线控制权的让渡”。在执行 DMA 时，CPU 实际上是暂时交出了 AHB 总线的使用权。虽然在内存到内存模式下 CPU 会因为总线竞争而稍有停顿，但在外设到内存模式下（如 ADC 采集），CPU 几乎可以实现真正的“零开销”数据同步。
- **软件工程思维**：通过将地址封装进初始化函数，我们将“数据搬运逻辑”与“业务逻辑”解耦。这种参数化配置的思路是编写驱动程序时的重要技巧。
