# 6.6-6.8_输入捕获与编码器接口_打卡gemini.md

## 章节目标回顾
*   掌握定时器的 **输入捕获 (Input Capture, IC)** 功能。
*   实现外部信号频率 (Frequency) 和占空比 (Duty Cycle) 的测量。
*   掌握 **编码器接口 (Encoder Interface)**，实现对正交编码器方向和速度的采集。

## 核心知识点精华
*   **输入捕获 (IC)**：
    *   **原理**：当输入引脚出现指定电平跳变（上升沿/下降沿）时，将当前计数器 CNT 的值锁存到 CCR 中。
    *   **频率测量**：利用两个上升沿之间的时间差（计数次数）计算频率。$f = f_{clk} / CCR$。
*   **PWMI 模式**：
    *   利用两个通道同时捕获一个引脚。通道1测周期（频率），通道2测脉宽（占空比）。
*   **编码器接口**：
    *   硬件自动根据 A、B 两相的相位差进行加减计数，无需 CPU 参与。
    *   **正交编码器**：A 领先 B（顺时针），B 领先 A（逆时针）。

## 核心代码注释速查表

### 输入捕获配置 (IC)
```c
TIM_ICInitTypeDef TIM_ICInitStructure;
TIM_ICInitStructure.TIM_Channel = TIM_Channel_1;
TIM_ICInitStructure.TIM_ICPolarity = TIM_ICPolarity_Rising; // 上升沿触发
TIM_ICInitStructure.TIM_ICSelection = TIM_ICSelection_DirectTI;
TIM_ICInit(TIM3, &TIM_ICInitStructure);
TIM_PWMIConfig(TIM3, &TIM_ICInitStructure); // 自动配置通道2为相反极性
```

### 编码器初始化
```c
TIM_EncoderInterfaceConfig(TIM3, TIM_EncoderMode_TI12, 
                           TIM_ICPolarity_Rising, TIM_ICPolarity_Rising);
TIM_Cmd(TIM3, ENABLE);
// 读取计数
int16_t Speed = (int16_t)TIM_GetCounter(TIM3);
TIM_SetCounter(TIM3, 0); // 每次读取清零，实现测速
```

## 核心洞察
*   **硬件的力量**：以前用外部中断测频率，高频时 CPU 会被中断累死。硬件 IC 极大减轻了 CPU 负担。
*   **正交解码的鲁棒性**：编码器接口利用正交信号不仅能测速，还能自动滤除机械抖动带来的虚假计数，这是纯软件难以完美实现的。
