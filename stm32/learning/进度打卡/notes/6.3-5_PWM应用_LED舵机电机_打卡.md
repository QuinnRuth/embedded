# 6.3-5 PWM 应用：LED、舵机、直流电机 - 学习打卡

**日期**: 2026-01-06
**状态**: ✅ 完成

---

## 学习内容

### 6-3 PWM 呼吸灯
- 配置 TIM2_CH1 @ PA0，PWM 频率 1kHz
- CCR 范围 0-100，对应占空比 0-100%
- 占空比越高，LED 越亮

### 6-4 PWM 舵机控制
- 配置 TIM2_CH2 @ PA1，PWM 频率 50Hz（20ms 周期）
- CCR 范围 500-2500，对应 0.5ms~2.5ms 脉宽
- 脉宽 0.5ms→0°，1.5ms→90°，2.5ms→180°
- 改进：添加 TIM2_CH1 @ PA0，LED 亮度随扫动角度变化

### 6-5 PWM 直流电机控制
- 配置 TIM2_CH3 @ PA2，PWM 频率 20kHz
- CCR 范围 0-100，对应速度 0-100%
- PA4/PA5 控制 L298N 方向：IN1=1/IN2=0 正转，IN1=0/IN2=1 反转

---

## 核心概念：PWM = 脉冲宽度调制

### PWM 三要素

| 概念 | 英文 | 含义 | 公式 |
|------|------|------|------|
| **频率** | Frequency | 每秒开关多少次 | f = 1 / T |
| **周期** | Period | 开一次关一次多长时间 | T = 1 / f |
| **占空比** | Duty Cycle | "开"时间占比 | Duty = 高电平时间 / 周期 × 100% |

### PWM 工作原理

```
CNT 计数器不断循环：0, 1, 2, ..., ARR → 0, 1, ...

硬件自动比较 CNT 和 CCR：
    CNT < CCR  → 输出 HIGH
    CNT ≥ CCR  → 输出 LOW

CCR 越大 → HIGH 时间越长 → 占空比越高
```

---

## 三种 PWM 应用对比

| 场景 | 频率 | PSC | ARR | CCR范围 | 控制量 | 引脚 |
|------|------|-----|-----|---------|--------|------|
| 6-3 LED 呼吸 | 1kHz | 719 | 99 | 0-100 | 亮度 | PA0 |
| 6-4 舵机 | 50Hz | 71 | 19999 | 500-2500 | 角度 | PA1 |
| 6-5 直流电机 | 20kHz | 35 | 99 | 0-100 | 速度 | PA2 |

**频率计算**：`fPWM = 72MHz / (PSC+1) / (ARR+1)`

---

## 6-4 舵机控制详解

### 舵机角度公式

```c
void Servo_SetAngle(float Angle)
{
    // CCR = Angle / 180 × 2000 + 500
    // 验证：
    //   0°  → 0/180 × 2000 + 500 = 500   (0.5ms)
    //   90° → 90/180 × 2000 + 500 = 1500  (1.5ms)
    //   180° → 180/180 × 2000 + 500 = 2500  (2.5ms)
    PWM_SetCompare2((uint16_t)(Angle / 180 * 2000 + 500));
}
```

### 脉宽与角度对应关系

```
0.5ms 高电平 → 0°   (最左边)
1.5ms 高电平 → 90°  (中间位置)
2.5ms 高电平 → 180° (最右边)
```

### 改进功能（用户修改版）

```c
// 5 档速度控制
static const ServoGear g_gears[] =
{
    {1, 20, 20},   // 慢档：每步1°，延时20ms
    {2, 15, 40},
    {3, 10, 60},
    {5, 6, 80},
    {8, 4, 100},   // 快档：每步8°，延时4ms
};

// LED 三角波同步：0..100..0 (与扫动同步)
uint8_t wave = (angle <= 90) ?
    (uint8_t)(angle * 100 / 90) :
    (uint8_t)((180 - angle) * 100 / 90);
```

---

## 6-5 直流电机控制详解

### L298N 真值表

| IN1 | IN2 | ENA | 电机状态 |
|-----|-----|-----|----------|
| 1 | 0 | PWM | **正转** |
| 0 | 1 | PWM | **反转** |
| 0 | 0 | X | **刹车** |
| 1 | 1 | X | **刹车** |

### 方向+速度控制代码

```c
void Motor_SetSpeed(int8_t Speed)
{
    if (Speed >= 0)  // 正转
    {
        GPIO_SetBits(GPIOA, GPIO_Pin_4);      // IN1 = H
        GPIO_ResetBits(GPIOA, GPIO_Pin_5);    // IN2 = L
        PWM_SetCompare3(Speed);               // PWM = Speed
    }
    else  // 反转
    {
        GPIO_ResetBits(GPIOA, GPIO_Pin_4);    // IN1 = L
        GPIO_SetBits(GPIOA, GPIO_Pin_5);      // IN2 = H
        PWM_SetCompare3(-Speed);               // PWM = -Speed (取绝对值)
    }
}
```

**速度循环**：0 → 20 → 40 → 60 → 80 → 100 → -100 → -80 → ... → 0

---

## GPIO 模式选择

| 模式 | 英文 | 用途 | 例子 |
|------|------|------|------|
| `GPIO_Mode_Out_PP` | 推挽输出 | 软件控制电平 | LED、电机方向 |
| `GPIO_Mode_AF_PP` | 复用推挽 | 外设控制电平 | PWM、串口、SPI |

**6-5 典型对比**：
- PA2 (PWM) → `GPIO_Mode_AF_PP` → 定时器硬件控制
- PA4/PA5 (方向) → `GPIO_Mode_Out_PP` → 软件控制

---

## PWM 初始化代码

```c
// 1. 开时钟
RCC_APB1PeriphClockCmd(RCC_APB1Periph_TIM2, ENABLE);
RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOA, ENABLE);

// 2. 配置 GPIO 为复用推挽
GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AF_PP;
GPIO_InitStructure.GPIO_Pin = GPIO_Pin_x;
GPIO_Init(GPIOA, &GPIO_InitStructure);

// 3. 配置时基单元（PSC、ARR）
TIM_TimeBaseInitStructure.TIM_Period = ARR;
TIM_TimeBaseInitStructure.TIM_Prescaler = PSC;
TIM_TimeBaseInit(TIM2, &TIM_TimeBaseInitStructure);

// 4. 配置输出比较（PWM 模式）
TIM_OCInitStructure.TIM_OCMode = TIM_OCMode_PWM1;
TIM_OCInitStructure.TIM_OCPolarity = TIM_OCPolarity_High;
TIM_OCInitStructure.TIM_OutputState = TIM_OutputState_Enable;
TIM_OCInitStructure.TIM_Pulse = 0;
TIM_OCxInit(TIM2, &TIM_OCInitStructure);

// 5. 启动定时器
TIM_Cmd(TIM2, ENABLE);
```

---

## 硬件连接

### 6-3 LED 呼吸灯
- LED: PA0 → 电阻 → LED+ → LED- → GND
- OLED: PB8 (SCL), PB9 (SDA)

### 6-4 舵机
- 舵机: PA1 (信号), 5V (供电), GND (共地)
- LED: PA0 → 电阻 → LED+ → GND
- OLED: PB8 (SCL), PB9 (SDA)
- Key1: PB1

### 6-5 直流电机
- L298N: ENA(PWM) → PA2, IN1 → PA4, IN2 → PA5
- 电机电源: +12V, 共地
- OLED: PB8 (SCL), PB9 (SDA)
- Key1: PB1

---

## 关键记忆点

1. **PWM 占空比**：CCR / (ARR+1) × 100%，CCR 越大占空比越高
2. **GPIO 模式**：`Out_PP` 软件控，`AF_PP` 外设控
3. **舵机**：50Hz，脉宽 0.5~2.5ms 对应 0~180°
4. **直流电机**：PWM 控速度，GPIO 控方向，20kHz 避免噪音
5. **频率计算**：f = 72MHz / (PSC+1) / (ARR+1)

---

## 疑问记录

- [x] PWM 是什么？
- [x] 为什么 CCR 决定占空比？
- [x] 6-4 与 6-5 的区别？
- [x] GPIO 的 Out_PP 和 AF_PP 有什么区别？
- [x] 舵机和电机的 PWM 频率为什么不同？

---

## 扩展阅读

- `stm32/docs/concepts/04_Timer_Basics.md` - 定时器基础
- `stm32/docs/concepts/05_PWM_Complete.md` - PWM 完整讲解
- `stm32/docs/concepts/06_GPIO_Pins_Complete.md` - GPIO 引脚完整讲解
