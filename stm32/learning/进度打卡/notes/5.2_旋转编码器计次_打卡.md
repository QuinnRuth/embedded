# 5.2 旋转编码器计次 - 学习打卡

**日期**: 2024-12-30
**课程**: 江科大STM32入门 - 第5章第2节

---

## 1. 章节目标回顾

- **核心目标**: 掌握正交编码器的工作原理，理解如何通过双路EXTI中断实现方向判断
- **理论重点**: 正交编码原理、相位差方向检测、双中断协同工作
- **实战目标**: 实现旋转编码器双向计数，OLED实时显示

---

## 2. 核心知识点精华

### 2.1 正交编码器 (Quadrature Encoder)

- **本质**: 输出两路相位差90°的方波信号（A相、B相）
- **类型**: 机械触点式 / 霍尔传感器式 / 光栅式
- **输出特性**: 旋转时产生与速度和方向对应的脉冲

### 2.2 方向判断原理 (核心!)

```
顺时针旋转 (A领先B 90°):
A: ──┐  ┌──┐  ┌──
    └──┘  └──┘
B: ───┐  ┌──┐  ┌─
     └──┘  └──┘

逆时针旋转 (B领先A 90°):
A: ───┐  ┌──┐  ┌─
     └──┘  └──┘
B: ──┐  ┌──┐  ┌──
    └──┘  └──┘
```

**方向检测逻辑表**:

| 触发事件 | 另一相电平 | 旋转方向 | 计数操作 |
|---------|-----------|---------|---------|
| A相下降沿 | B = LOW | 逆时针 | Count-- |
| A相下降沿 | B = HIGH | 顺时针 | Count++ |
| B相下降沿 | A = LOW | 顺时针 | Count++ |
| B相下降沿 | A = HIGH | 逆时针 | Count-- |

### 2.3 与5-1的对比

| 特性 | 5-1 红外传感器 | 5-2 旋转编码器 |
|------|---------------|---------------|
| 信号数量 | 1路 | 2路 (A+B) |
| EXTI线数 | 1条 | 2条 (EXTI0 + EXTI1) |
| 方向判断 | 无 | 有 |
| 计数类型 | 单向递增 | 双向增减 |
| ISR逻辑 | 直接计数 | 交叉检测另一相 |

### 2.4 硬件接线

| 编码器引脚 | STM32引脚 | 说明 |
|-----------|----------|------|
| CLK (A相) | PB0 | EXTI0中断 |
| DT (B相) | PB1 | EXTI1中断 |
| SW | 未使用 | 按键功能 |
| VCC | 3.3V | 电源 |
| GND | GND | 地 |

---

## 3. 核心代码解析

### 3.1 初始化配置要点

```c
// 1. 必须开启AFIO时钟（EXTI需要）
RCC_APB2PeriphClockCmd(RCC_APB2Periph_AFIO, ENABLE);

// 2. GPIO配置为上拉输入（编码器空闲时保持高电平）
GPIO_InitStructure.GPIO_Mode = GPIO_Mode_IPU;

// 3. 两条EXTI线都配置为下降沿触发
EXTI_InitStructure.EXTI_Line = EXTI_Line0 | EXTI_Line1;
EXTI_InitStructure.EXTI_Trigger = EXTI_Trigger_Falling;

// 4. 两个NVIC通道需要分别配置
NVIC_InitStructure.NVIC_IRQChannel = EXTI0_IRQn;  // 第一个
NVIC_InitStructure.NVIC_IRQChannel = EXTI1_IRQn;  // 第二个
```

### 3.2 中断服务函数 (方向判断核心)

```c
// A相下降沿中断
void EXTI0_IRQHandler(void)
{
    if (EXTI_GetITStatus(EXTI_Line0) == SET)
    {
        if (GPIO_ReadInputDataBit(GPIOB, GPIO_Pin_0) == 0)  // 消抖确认
        {
            // 关键: 读取B相电平判断方向
            if (GPIO_ReadInputDataBit(GPIOB, GPIO_Pin_1) == 0)
                Encoder_Count--;  // B低 = 逆时针
            else
                Encoder_Count++;  // B高 = 顺时针
        }
        EXTI_ClearITPendingBit(EXTI_Line0);  // 必须清除!
    }
}

// B相下降沿中断 (逻辑相反)
void EXTI1_IRQHandler(void)
{
    if (EXTI_GetITStatus(EXTI_Line1) == SET)
    {
        if (GPIO_ReadInputDataBit(GPIOB, GPIO_Pin_1) == 0)
        {
            if (GPIO_ReadInputDataBit(GPIOB, GPIO_Pin_0) == 0)
                Encoder_Count++;  // A低 = 顺时针
            else
                Encoder_Count--;  // A高 = 逆时针
        }
        EXTI_ClearITPendingBit(EXTI_Line1);
    }
}
```

### 3.3 增量获取模式

```c
int16_t Encoder_Get(void)
{
    int16_t temp = Encoder_Count;
    Encoder_Count = 0;  // 读取后清零，返回"增量"
    return temp;
}
```

---

## 4. 实战成果

- 成功配置PB0、PB1双路EXTI中断
- 实现正交解码方向判断
- OLED实时显示编码器累计值
- 顺时针递增，逆时针递减

---

## 5. 关键技术细节

1. **为什么需要两路信号?**
   - 单路信号只能计数，无法判断方向
   - 两路90°相位差 → "谁先谁后"确定方向

2. **为什么用下降沿触发?**
   - 机械编码器空闲时输出高电平（上拉）
   - 旋转时产生低电平脉冲
   - 下降沿是脉冲开始的时刻，最稳定

3. **消抖处理**
   - ISR中二次读取引脚电平确认
   - 避免机械抖动产生误触发

4. **增量模式 vs 绝对模式**
   - `Encoder_Get()` 返回增量并清零 → 适合速度/变化量检测
   - 直接读 `Encoder_Count` → 适合位置累计

---

## 6. 完成成就

- [x] **解锁技能**: 正交编码原理理解
- [x] **解锁技能**: 双EXTI中断协同配置
- [x] **解锁技能**: 相位差方向判断算法
- [x] **解锁技能**: 软件消抖技术

---

## 7. 知识掌握度自评

| 评估维度 | 掌握情况 | 说明 |
|---------|:-------:|------|
| 正交编码原理 | ⬜⬜⬜⬜⬜ | 理解90°相位差如何表示方向 |
| 方向判断逻辑 | ⬜⬜⬜⬜⬜ | 能推导出A/B相位与方向的关系 |
| 双EXTI配置 | ⬜⬜⬜⬜⬜ | AFIO映射、NVIC分别配置 |
| ISR交叉检测 | ⬜⬜⬜⬜⬜ | 在一相中断中读取另一相电平 |
| 增量获取模式 | ⬜⬜⬜⬜⬜ | 读取后清零的设计思路 |

---

## 8. 核心洞察

**"交叉检测是正交解码的灵魂"**

正交编码器的精髓在于：在一相信号的边沿时刻，读取另一相的电平状态。这种"交叉检测"利用了两相90°相位差的特性——同一时刻，两相的电平组合唯一确定了旋转方向。

这种设计思想在后续的TIM硬件编码器接口（6-8）中被硬件化实现，但理解软件实现的原理是掌握硬件接口的基础。

---

## 9. 与后续课程的联系

| 当前课程 | 后续课程 | 关系 |
|---------|---------|------|
| 5-2 软件解码 | 6-8 硬件编码器接口 | TIM硬件自动完成方向判断 |
| EXTI中断计数 | 6-1 TIM定时器 | 定时器可作为更精确的计数源 |
| 双中断协同 | 后续多中断项目 | 中断优先级管理基础 |

---

## 10. 待回答的理论问题

> 请在下方回答这些问题，检验你的理解程度：

### Q1: 为什么单路信号无法判断旋转方向？

**你的回答**:


---

### Q2: 请解释为什么"A相下降沿时B为高电平"表示顺时针旋转？

**你的回答**:


---

### Q3: 如果把两个ISR中的 `++` 和 `--` 全部交换，会发生什么？

**你的回答**:


---

### Q4: 课程简化版只在EXTI0检测反转、EXTI1检测正转，而完整版两个ISR都检测双向。这两种实现的计数精度有什么区别？

**你的回答**:


---

### Q5: 为什么 `Encoder_Get()` 要在读取后清零？如果不清零会怎样？

**你的回答**:


---

**备注**: 本笔记基于江协科技STM32 5.2章节内容，侧重于正交编码器的方向判断原理与双中断协同实现。
