# 6.1-2 定时器中断与外部时钟 - 学习打卡

**日期**: 2025-01-05
**状态**: ✅ 完成

---

## 学习内容

### 6-1 定时器定时中断
- 配置 TIM2 使用内部时钟（72MHz）
- 设置预分频器 PSC = 7200-1
- 设置自动重载值 ARR = 10000-1
- 中断周期：(7200 × 10000) / 72,000,000 = 1 秒

### 6-2 定时器外部时钟
- 配置 TIM2 使用外部时钟（PA0 = TIM2_ETR）
- 外部脉冲直接驱动 CNT 计数
- 设置 ARR = 10-1，每 10 个脉冲触发一次中断

---

## 核心概念

### 定时器公式
```
定时周期 = (PSC + 1) × (ARR + 1) / 时钟频率
```

### 四个关键寄存器
| 寄存器 | 全名 | 作用 | 比喻 |
|--------|------|------|------|
| PSC | Prescaler | 分频器 | 齿轮减速 |
| ARR | Auto-Reload Register | 计数上限 | 终点线 |
| CNT | Counter | 当前计数值 | 跑步者位置 |
| CCR | Capture/Compare | PWM 比较值 | 分界线 |

### 6-1 vs 6-2 对比
| 项目 | 6-1 定时中断 | 6-2 外部时钟 |
|------|--------------|--------------|
| 时钟源 | 内部 72MHz | 外部 PA0 |
| 用途 | 定时触发中断 | 计数外部脉冲 |
| PSC | 7200 | 1 |
| ARR | 10000 | 10 |
| 新函数 | 无 | `TIM_ETRClockMode2Config()` |
| 新函数 | 无 | `Timer_GetCounter()` |

---

## 关键函数

### TIM_ETRClockMode2Config() (6-2)
```c
TIM_ETRClockMode2Config(
    TIM2,                      // 使用 TIM2 定时器
    TIM_ExtTRGPSC_OFF,         // 预分频：不分频（1进1数）
    TIM_ExtTRGPolarity_NonInverted,  // 极性：上升沿触发
    0x0F                       // 滤波器：最大值，抗干扰
);
```

**第2参数详解**：
| 值 | 意思 | 效果 |
|-----|------|------|
| `TIM_ExtTRGPSC_OFF` | 不分频 | 外来1个脉冲，CNT +1 |
| `TIM_ExtTRGPSC_DIV2` | 2分频 | 外来2个脉冲，CNT +1 |
| `TIM_ExtTRGPSC_DIV4` | 4分频 | 外来4个脉冲，CNT +1 |
| `TIM_ExtTRGPSC_DIV8` | 8分频 | 外来8个脉冲，CNT +1 |

---

## Timer.c 初始化 6 步

```c
void Timer_Init(void)
{
    // 1. 开启时钟
    RCC_APB1PeriphClockCmd(RCC_APB1Periph_TIM2, ENABLE);

    // 2. 配置时基单元（PSC、ARR）
    TIM_TimeBaseInitTypeDef TIM_TimeBaseInitStructure;
    TIM_TimeBaseInitStructure.TIM_Period = 10000 - 1;      // ★ ARR
    TIM_TimeBaseInitStructure.TIM_Prescaler = 7200 - 1;    // ★ PSC
    TIM_TimeBaseInit(TIM2, &TIM_TimeBaseInitStructure);

    // 3. 清除更新标志位（避免初始化后立即进中断）
    TIM_ClearFlag(TIM2, TIM_FLAG_Update);

    // 4. 使能更新中断
    TIM_ITConfig(TIM2, TIM_IT_Update, ENABLE);

    // 5. 配置 NVIC 优先级
    NVIC_PriorityGroupConfig(NVIC_PriorityGroup_2);
    NVIC_InitStructure.NVIC_IRQChannel = TIM2_IRQn;
    NVIC_Init(&NVIC_InitStructure);

    // 6. 启动定时器
    TIM_Cmd(TIM2, ENABLE);
}
```

---

## 中断服务函数

```c
void TIM2_IRQHandler(void)
{
    if (TIM_GetITStatus(TIM2, TIM_IT_Update) == SET)
    {
        Num++;                                    // 核心业务逻辑
        TIM_ClearITPendingBit(TIM2, TIM_IT_Update); // 必须清除标志位！
    }
}
```

**注意**：不清除中断标志位会导致中断反复触发，程序卡死。

---

## 硬件连接

### 6-1 定时中断
- OLED: PB8 (SCL), PB9 (SDA)

### 6-2 外部时钟
- 外部信号源 → PA0 (TIM2_ETR)
- OLED: PB8 (SCL), PB9 (SDA)

**重要**：PA0 是 TIM2 的 ETR 引脚，固定映射不可更改。

---

## 实验效果

### 6-1
```
┌─────────────────────────┐
│ Lesson 6-1         │
│ Timer Interrupt     │
│ ----------------   │
│ Num: XXXXX         │  ← 每秒 +1
└─────────────────────────┘
```

### 6-2
```
┌─────────────────────────┐
│ Num: XXX            │  ← 每10个脉冲 +1（溢出次数）
│ CNT: XXX            │  ← 实时计数值（0-9）
└─────────────────────────┘
```

---

## 关键记忆点

1. **定时中断（6-1）**：PSC分频 → CNT计数到ARR → 触发中断 → 执行代码
2. **外部时钟（6-2）**：外部脉冲驱动CNT → 数到ARR → 触发中断 → Num++
3. **PA0 = TIM2_ETR**：固定映射，作为外部时钟输入引脚
4. **清除中断标志**：中断服务函数必须调用 `TIM_ClearITPendingBit()`
5. **定时公式**：T = (PSC+1) × (ARR+1) / 72,000,000

---

## 疑问记录

- [x] PSC 和 ARR 的作用是什么？
- [x] 6-1 和 6-2 的区别？
- [x] `TIM_ETRClockMode2Config` 的 4 个参数含义？
- [x] 为什么 PA0 是 ETR 引脚？
