# 9.1-9.3_串口发送与数据包_打卡gemini.md

## 章节目标回顾
*   掌握 USART 串口外设的基本配置与通信原理。
*   实现单字节、字符串、数字、以及 printf 重定向发送。
*   掌握串口中断接收机制，实现单字节及 HEX 数据包的可靠接收。
*   理解“状态机”在协议解析中的核心作用。

## 核心知识点精华
*   **USART 结构**：TX (发送) / RX (接收)。数据在发送/接收移位寄存器中实现并串转换。
*   **配置要点**：
    *   PA9 (TX): 复用推挽输出。
    *   PA10 (RX): 上拉输入。
    *   波特率、数据位 (8b)、校验位 (None)、停止位 (1) 必须在通信双方保持一致。
*   **HEX 数据包协议**：
    *   **固定包长协议**：利用包头 (如 0xFF) 和包尾 (如 0xFE) 确定一帧数据的边界。
    *   **状态机解析**：通过 `RxState` 变量区分“等待包头”、“接收数据”、“等待包尾”三个阶段，极大提高通信鲁棒性。

## 核心代码注释速查表

### 串口发送常用函数
```c
void Serial_SendByte(uint8_t Byte) {
    USART_SendData(USART1, Byte);
    while (USART_GetFlagStatus(USART1, USART_FLAG_TXE) == RESET);
}
// printf重定向
int fputc(int ch, FILE *f) {
    Serial_SendByte(ch);
    return ch;
}
```

### HEX 数据包接收状态机 (USART1_IRQHandler)
```c
if (RxState == 0) { // 找包头
    if (RxData == 0xFF) { RxState = 1; pRxPacket = 0; }
} else if (RxState == 1) { // 存数据
    RxPacket[pRxPacket++] = RxData;
    if (pRxPacket >= 4) RxState = 2;
} else if (RxState == 2) { // 找包尾
    if (RxData == 0xFE) { RxState = 0; Serial_RxFlag = 1; }
}
```

## 核心洞察
*   **查询 vs 中断**：发送通常用查询（TXE标志），因为发送主动权在 CPU；接收必须用中断（RXNE），因为数据何时到来不可预测，中断能保证实时性。
*   **协议是通信的灵魂**：单纯的字节流容易因干扰或错位导致解析错误。引入“包头包尾+状态机”是将物理层字节流升华为应用层可靠消息的关键。
